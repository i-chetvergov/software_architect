@startuml c4_component
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

skinparam backgroundColor #FFFFFF
skinparam legendBackgroundColor #EEEBDC
skinparam legendBorderColor #2D3E50

skinparam linetype ortho
skinparam componentStyle rectangle
skinparam shadowing false
skinparam defaultTextAlignment center
left to right direction

title "Call Control Service — Компонентная диаграмма"

' ==========================================================
' ТЕГИ И СТИЛИ (усиленная контрастность фона под светлый текст,
' выровнено с контейнерной диаграммой)
' ==========================================================
AddElementTag("Сигнализация", $bgColor="#1565C0", $borderColor="#0D47A1")
AddElementTag("Периметр",     $bgColor="#C62828", $borderColor="#B71C1C")
AddElementTag("Данные",       $bgColor="#283593", $borderColor="#1A237E")
AddElementTag("Политики",     $bgColor="#F9A825", $borderColor="#F57F17")

' ==========================================================
' АКТЁРЫ И ВНЕШНИЕ КОНТЕЙНЕРЫ
' ==========================================================
Person(corpUser, "Корпоративный пользователь", "Сотрудник, использующий UC-платформу")

System_Ext(ucClients, "UC Clients", "Веб-клиент, мобильные приложения")

Container(apiGateway, "API Gateway", "HTTPS, REST, WebSocket", "API-шлюз/WAF: authN/authZ на периметре", $tags="Периметр")
Container(callControlService, "Call Control Service", "HTTP, gRPC, SIP", "Управление вызовами и маршрутизация", $tags="Сигнализация")

Container_Ext(sipGw, "SIP Gateway / SBC", "SIP, SIP/TLS", "Session Border Controller")
Container_Ext(webrtcGw, "WebRTC Gateway", "WebRTC, WebTransport", "WebRTC шлюз")
Container_Ext(iam, "IAM Service", "OIDC, SAML 2.0", "IdP/Authorization Server (SSO, токены)")
Container_Ext(policyPDP, "Policy Decision Point (OPA)", "HTTP/gRPC", "PDP: ABAC/REGO решения allow/deny + obligations", $tags="Политики")
Container_Ext(billing, "Billing / CDR Service", "Events", "Сервис биллинга")
Container_Ext(presence, "Presence Service", "Events", "Сервис presence")
Container_Ext(voiceConf, "Voice Conferencing Service", "SIP/WebRTC, gRPC, Events", "Сервис голосовых конференций")

ContainerDb(dbCalls, "БД вызовов", "PostgreSQL", "Хранилище вызовов и сессий", $tags="Данные")
ContainerDb(cache, "Кэш", "Redis", "Кэширование сессий и маршрутизации", $tags="Данные")
ContainerQueue(messageQueue, "Очередь сообщений", "Kafka / RabbitMQ", "Брокер сообщений", $tags="Данные")

' ==========================================================
' КОМПОНЕНТЫ CALL CONTROL SERVICE
' ==========================================================
Container_Boundary(callControlBoundary, "Call Control Service") {

	Component(callApi, "Call Control API", "HTTP/gRPC", "Входная точка: команды управления вызовом (create/hold/transfer/end)")

	Component(authContextValidator, "Auth Context Validator", "Library", "Валидация identity context от API Gateway (claims/scopes/tenant) без вызова IAM на каждый запрос")

	Component(policyClient, "Policy Client", "OPA Client", "Формирование ABAC-запросов в PDP (subject/resource/action/context), разбор obligations")

	Component(callOrchestrator, "Call Orchestrator", "Java / Go", "Оркестрация жизненного цикла вызовов, координация подсистем")

	Component(routingEngine, "Routing Engine", "Java / Go", "Выбор маршрута: правила, префиксы, политики, fallback")
	Component(routePolicyEvaluator, "Route Policy Evaluator", "Java / Go", "Применение policy obligations к маршруту (например: запрет направления, forced trunk, запись)")

	Component(sessionManager, "Session Manager", "Java / Go", "Управление активными сессиями и их состояниями, идемпотентность")
	Component(stateMachine, "Call State Machine", "Library", "Детерминированные переходы состояний вызова (FSM)")

	Component(sipHandler, "SIP Handler", "Java / Go", "Обработка SIP-сообщений, транзакции/диалоги")
	Component(webrtcHandler, "WebRTC Handler", "Java / Go", "Обработка сигнализации WebRTC-сессий (контрольные сообщения)")

	Component(eventPublisher, "Event Publisher", "Kafka/Rabbit Client", "Публикация событий вызова (started/connected/ended/fail) [async]")

	Component(cdrCollector, "CDR Collector", "Java / Go", "Сбор данных для CDR: тайминги, причины завершения, маршрут, участники")

	ComponentDb(callRepository, "Call Repository", "SQL", "Доступ к данным: вызовы/сессии/маршруты/состояния")
	Component(cacheAdapter, "Cache Adapter", "Redis Client", "Кэш маршрутизации, активные сессии, dedup keys")
}

' ==========================================================
' ВЗАИМОДЕЙСТВИЯ (верхний уровень)
' ==========================================================
Rel(corpUser, ucClients, "Использует", "Инициация/управление вызовом")
Rel(ucClients, apiGateway, "HTTPS/JSON", "REST/Web API")
Rel(apiGateway, callApi, "HTTP/gRPC + Identity Context", "Команды управления вызовом")

' Валидация контекста доступа (не делаем IAM bottleneck)
Rel(callApi, authContextValidator, "In-process", "Валидация claims/scopes/tenant")
Rel(callApi, policyClient, "gRPC", "Запрос ABAC-решения (authorize)")

' PDP как формальная точка принятия решения
Rel(policyClient, policyPDP, "HTTP/gRPC", "authorize(subject, resource, action, context)")

' Оркестрация и маршрутизация
Rel(callApi, callOrchestrator, "gRPC", "Создание/управление вызовом")
Rel(callOrchestrator, routingEngine, "gRPC", "Запрос маршрутизации")
Rel(routingEngine, routePolicyEvaluator, "In-process", "Применение obligations к маршруту")

' Сессии и состояния
Rel(callOrchestrator, sessionManager, "gRPC", "Создание/обновление сессии")
Rel(sessionManager, stateMachine, "In-process", "Переходы состояний вызова")

' SIP / WebRTC обработчики
Rel(callOrchestrator, sipHandler, "gRPC", "Команды сигнализации (INVITE/UPDATE/BYE/...)")
Rel(sipHandler, sipGw, "SIP/SIP-TLS", "SIP-сообщения")
Rel(sipGw, sipHandler, "SIP/SIP-TLS", "SIP-ответы")

Rel(callOrchestrator, webrtcHandler, "gRPC", "Команды сигнализации WebRTC")
Rel(webrtcHandler, webrtcGw, "WebTransport/WebRTC", "Сигнализация WebRTC")
Rel(webrtcGw, webrtcHandler, "WebTransport/WebRTC", "Ответы/события WebRTC")

' Интеграция с голосовыми конференциями (как отдельный домен)
Rel(callOrchestrator, voiceConf, "gRPC/Events", "Создание/управление конференцией (room/participants)")

' Presence учитывается маршрутизацией и/или событиями
Rel(routingEngine, presence, "Events/Query", "Доступность/статус абонента (optional)")
Rel(eventPublisher, presence, "Events", "События состояния вызова [async]")

' CDR/Events
Rel(cdrCollector, billing, "Events", "CDR события [async]")
Rel(callOrchestrator, eventPublisher, "Events", "Публикация событий вызова [async]")
Rel(eventPublisher, messageQueue, "Events", "Call events [async]")
Rel(cdrCollector, messageQueue, "Events", "CDR events [async]")

' Данные
Rel(callRepository, dbCalls, "SQL", "Вызовы/сессии/маршруты")
Rel(cacheAdapter, cache, "Redis", "Кэш сессий/маршрутов/dedup")
Rel(sessionManager, callRepository, "Repository", "Сохранение состояния сессии")
Rel(sessionManager, cacheAdapter, "Redis", "Кэш активных сессий")
Rel(routingEngine, callRepository, "Repository", "Чтение правил маршрутизации")
Rel(routingEngine, cacheAdapter, "Redis", "Кэш маршрутизации")
Rel(cdrCollector, callRepository, "Repository", "Запись CDR данных")

' IAM присутствует как источник токенов/SSO, но не обязательный runtime-hop
Rel(iam, apiGateway, "OIDC/JWKS", "Ключи/токены (JWT)")

' ==========================================================
' ПРИМЕЧАНИЯ
' ==========================================================
note right of callApi
	Call Control API:
	- точка входа команд (create/answer/hold/transfer/end)
	- получает identity context от API Gateway
	- инициирует ABAC проверку через PDP (OPA)
end note

note bottom of policyPDP
	PDP (OPA/REGO):
	- allow/deny
	- obligations (например: require_recording, force_trunk, block_prefix)
	- versioning/rollback политик выполняется на уровне платформы
end note

note bottom of routingEngine
	Routing Engine:
	- правила/префиксы/пулы маршрутов
	- учёт статуса (presence) при необходимости
	- применение obligations через Route Policy Evaluator
end note

note bottom of sessionManager
	Session Manager + FSM:
	- согласованные переходы состояний (idempotent)
	- восстановление после ретраев/дубликатов событий
	- хранение состояния в DB + Redis (hot path)
end note

note right of cdrCollector
	CDR Collector:
	- собирает тайминги/причины завершения/маршрут
	- публикует CDR events (billing) асинхронно
end note

SHOW_LEGEND()
@enduml