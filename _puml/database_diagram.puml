@startuml database_diagram
title Схема баз данных "Платформа Унифицированных Коммуникаций" (логический уровень, с описаниями таблиц)

skinparam linetype ortho
skinparam classAttributeIconSize 0
left to right direction

skinparam backgroundColor #FFFFFF
skinparam legendBackgroundColor #EEEBDC
skinparam legendBorderColor #2D3E50

skinparam package {
  BackgroundColor #F5F5F5
  BorderColor #424242
}

' ВАЖНО:
' - Внутри каждого package показаны физические FK (сплошные связи).
' - Между пакетами (между БД) связи помечены как ЛОГИЧЕСКИЕ (пунктир), т.к. физические FK across-DB обычно не применяются.

' ==========================================================
' DB_ACCOUNTS
' ==========================================================
package "DB_ACCOUNTS\n(PostgreSQL)\nДомен: Аккаунты и профили" {

  class accounts {
    + PK_id : uuid
    + email : text
    + password_hash : text
    + status : text        ' active / suspended / deleted
    + created_at : timestamp
    + updated_at : timestamp
  }

  note right of accounts
    accounts — учётные записи пользователей UC-платформы.
    Используется IAM для аутентификации и как источник identity.
    Удаление — логическое (status=deleted/suspended), физическое удаление не допускается (audit/compliance).
  end note

  class user_profiles {
    + PK_id : uuid
    + FK_account_id : uuid  ' UNIQUE (1:1)
    + display_name : text
    + phone_number : text
    + timezone : text
    + language : text
  }

  note right of user_profiles
    user_profiles — профиль пользователя (1:1 с accounts).
    timezone и language — для UI/маршрутизации по времени/локали.
    Presence-статусы вынесены в DB_MESSAGING (presence_status),
    чтобы не смешивать домены "профиль" и "presence-runtime".
  end note

  class user_devices {
    + PK_id : uuid
    + FK_account_id : uuid
    + device_type : text   ' web / mobile / desktop / sip
    + device_id : text
    + registration_token : text
    + last_seen : timestamp
    + is_active : boolean
  }

  note right of user_devices
    user_devices — зарегистрированные устройства.
    Используется для multi-device, маршрутизации вызова на набор устройств,
    а также для пушей/токенов и контроля активности.
  end note

  class feature_flags {
    + PK_id : uuid
    + key : text
    + value : jsonb
    + scope : text        ' global / tenant / account / device
    + scope_ref : text    ' null / tenant_id / account_id / device_id
    + enabled : boolean
  }

  note right of feature_flags
    feature_flags — feature-toggle/config storage.
    Связь со scope_ref — логическая (через приложение), без жёстких FK.
  end note

  class routing_rules {
    + PK_id : uuid
    + FK_account_id : uuid
    + rule_type : text    ' time_based / presence_based / device_based
    + priority : integer
    + conditions : jsonb
    + actions : jsonb
    + is_active : boolean
  }

  note right of routing_rules
    routing_rules — пользовательские правила маршрутизации.
    Используется Call Control при выборе target'ов (device/queue/voicemail/external),
    а также как источник условий (time/presence/device).
  end note

  class policy_assignments {
    + PK_id : uuid
    + FK_account_id : uuid
    + policy_subject_type : text   ' user / group / role
    + policy_subject_ref : text
    + policy_bundle_version : text
    + created_at : timestamp
  }

  note right of policy_assignments
    policy_assignments — привязки политик (ABAC/OPA) к субъектам.
    Хранит версию набора политик (bundle_version) для воспроизводимости решений.
    Используется Provisioning/IAM при управлении доступом.
  end note

  ' Физические связи внутри DB_ACCOUNTS
  accounts "1" -- "1" user_profiles : FK_account_id (UNIQUE)
  accounts "1" -- "*" user_devices : FK_account_id
  accounts "1" -- "*" routing_rules : FK_account_id
  accounts "1" -- "*" policy_assignments : FK_account_id

  ' Логические связи feature_flags (НЕ физические FK)
  feature_flags .. user_profiles : scope="account"\nscope_ref=account_id
  feature_flags .. user_devices  : scope="device"\nscope_ref=device_id
}

' ==========================================================
' DB_CALLS
' ==========================================================
package "DB_CALLS\n(PostgreSQL)\nДомен: Сигнализация и вызовы" {

  class call_sessions {
    + PK_id : uuid
    + call_id : text
    + correlation_id : text
    + initiator_account_id : uuid   ' logical ref to accounts
    + callee_account_id : uuid      ' logical ref to accounts
    + direction : text     ' inbound / outbound
    + call_type : text     ' voice / video / conference
    + status : text        ' initiating / ringing / answered / ended / failed
    + started_at : timestamp
    + answered_at : timestamp
    + ended_at : timestamp
  }

  note right of call_sessions
    call_sessions — сессии вызовов (основная сущность Call Control).
    account_id поля — логические ссылки на DB_ACCOUNTS.
    correlation_id — для сквозного трейсинга (logs/traces/CDR).
  end note

  class call_legs {
    + PK_id : uuid
    + FK_call_session_id : uuid
    + device_id : uuid           ' logical ref to user_devices
    + leg_type : text            ' local / pstn / webrtc / sip
    + remote_address : text
    + status : text              ' active / hold / transfer / ended
    + started_at : timestamp
    + ended_at : timestamp
  }

  note right of call_legs
    call_legs — "ноги" вызова.
    device_id — логическая ссылка на user_devices (DB_ACCOUNTS).
  end note

  class call_routing {
    + PK_id : uuid
    + FK_call_session_id : uuid
    + routing_step : integer
    + target_type : text   ' device / queue / voicemail / external
    + target_ref : text
    + result : text        ' success / busy / no_answer / failed
    + attempted_at : timestamp
  }

  note right of call_routing
    call_routing — история попыток маршрутизации.
    target_ref — внешний идентификатор цели (device_id/queue_id/number).
  end note

  class call_queues {
    + PK_id : uuid
    + name : text
    + description : text
    + strategy : text      ' ring_all / longest_idle / round_robin
    + timeout_sec : integer
    + max_wait_sec : integer
    + is_active : boolean
  }

  class queue_members {
    + PK_id : uuid
    + FK_queue_id : uuid
    + account_id : uuid    ' logical ref to accounts
    + priority : integer
    + is_active : boolean
  }

  note right of queue_members
    queue_members — состав очередей.
    account_id — логическая ссылка на accounts (DB_ACCOUNTS).
  end note

  class policy_decision_audit {
    + PK_id : uuid
    + correlation_id : text
    + subject_account_id : uuid  ' logical ref to accounts
    + action : text
    + resource : text
    + decision : text            ' allow / deny
    + obligations : jsonb
    + policy_bundle_version : text
    + decided_at : timestamp
  }

  note right of policy_decision_audit
    policy_decision_audit — аудит ABAC/OPA решений в runtime.
    Позволяет объяснять "почему был запрет/разрешение" (security/compliance),
    и воспроизводить решение по policy_bundle_version.
    Заполняется Call Control (через Policy Client) при критичных действиях
    (например: инициировать вызов, перевод, подключение к конференции).
  end note

  ' Физические связи внутри DB_CALLS
  call_sessions "1" -- "*" call_legs : FK_call_session_id
  call_sessions "1" -- "*" call_routing : FK_call_session_id
  call_queues "1" -- "*" queue_members : FK_queue_id
}

' ==========================================================
' DB_CDR
' ==========================================================
package "DB_CDR\n(PostgreSQL)\nДомен: CDR и биллинг" {

  class cdr_records {
    + PK_id : uuid
    + call_id : text
    + correlation_id : text
    + account_id : uuid          ' logical ref to accounts
    + device_id : uuid           ' logical ref to user_devices
    + direction : text           ' inbound / outbound
    + call_type : text           ' voice / video / conference
    + source_number : text
    + destination_number : text
    + duration_sec : integer
    + started_at : timestamp
    + answered_at : timestamp
    + ended_at : timestamp
    + termination_reason : text
    + cost : numeric
    + currency : text
  }

  note right of cdr_records
    cdr_records — CDR (детализация) для биллинга и аналитики.
    account_id/device_id — логические ссылки на DB_ACCOUNTS.
    Записи не удаляются (compliance/audit).
  end note

  class billing_plans {
    + PK_id : uuid
    + name : text
    + plan_type : text     ' per_minute / flat_rate / unlimited
    + rate_per_minute : numeric
    + currency : text
    + is_active : boolean
  }

  class account_billing {
    + PK_id : uuid
    + account_id : uuid        ' logical ref to accounts
    + FK_billing_plan_id : uuid
    + balance : numeric
    + currency : text
    + credit_limit : numeric
    + is_active : boolean
  }

  ' Физические связи внутри DB_CDR
  account_billing "*" -- "1" billing_plans : FK_billing_plan_id
}

' ==========================================================
' DB_MESSAGING
' ==========================================================
package "DB_MESSAGING\n(PostgreSQL)\nДомен: Сообщения и presence" {

  class conversations {
    + PK_id : uuid
    + conversation_type : text  ' direct / group / channel
    + created_at : timestamp
    + updated_at : timestamp
  }

  class conversation_participants {
    + PK_id : uuid
    + FK_conversation_id : uuid
    + account_id : uuid         ' logical ref to accounts
    + role : text               ' owner / admin / member
    + joined_at : timestamp
    + left_at : timestamp
  }

  class messages {
    + PK_id : uuid
    + FK_conversation_id : uuid
    + sender_account_id : uuid  ' logical ref to accounts
    + message_type : text       ' text / file / voice / video
    + content : text
    + metadata : jsonb
    + sent_at : timestamp
  }

  class message_receipts {
    + PK_id : uuid
    + FK_message_id : uuid
    + account_id : uuid         ' logical ref to accounts
    + delivered_at : timestamp
    + read_at : timestamp
  }

  note right of message_receipts
    message_receipts — статусы доставки/прочтения по участникам.
    Нормализует delivered/read вместо хранения delivered_at/read_at в messages
    (подходит для групп/каналов).
  end note

  class message_attachments {
    + PK_id : uuid
    + FK_message_id : uuid
    + storage_key : text        ' S3 key
    + content_type : text
    + size_bytes : bigint
    + checksum : text
    + created_at : timestamp
  }

  note right of message_attachments
    message_attachments — вложения сообщений.
    storage_key указывает на объект в S3 (Object Storage), что согласовано с deployment.
  end note

  class presence_status {
    + PK_id : uuid
    + account_id : uuid         ' logical ref to accounts
    + status : text             ' available / busy / away / offline
    + status_message : text
    + last_seen : timestamp
    + updated_at : timestamp
  }

  class presence_subscriptions {
    + PK_id : uuid
    + subscriber_account_id : uuid  ' logical ref to accounts
    + target_account_id : uuid      ' logical ref to accounts
    + is_active : boolean
    + created_at : timestamp
  }

  ' Физические связи внутри DB_MESSAGING
  conversations "1" -- "*" conversation_participants : FK_conversation_id
  conversations "1" -- "*" messages : FK_conversation_id
  messages "1" -- "*" message_receipts : FK_message_id
  messages "1" -- "*" message_attachments : FK_message_id
}

' ==========================================================
' DB_CONFERENCES (добавлено: соответствует контейнеру Voice Conferencing Service и deployment)
' ==========================================================
package "DB_CONFERENCES\n(PostgreSQL)\nДомен: Голосовые конференции" {

  class conferences {
    + PK_id : uuid
    + conference_id : text
    + title : text
    + owner_account_id : uuid     ' logical ref to accounts
    + join_policy : text          ' invite_only / org / public_link
    + pin_hash : text
    + created_at : timestamp
    + updated_at : timestamp
    + is_active : boolean
  }

  note right of conferences
    conferences — комнаты конференций (voice conferencing домен).
    join_policy определяет модель доступа (в т.ч. гостевая ссылка),
    owner_account_id — логическая ссылка на accounts.
  end note

  class conference_participants {
    + PK_id : uuid
    + FK_conference_id : uuid
    + participant_type : text     ' internal / external
    + account_id : uuid           ' logical (для internal)
    + external_ref : text         ' email/phone/guest_id (для external)
    + role : text                 ' owner / moderator / participant
    + joined_at : timestamp
    + left_at : timestamp
  }

  note right of conference_participants
    conference_participants — участники конференции.
    Для внешних участников используется external_ref (гость по ссылке/телефону),
    для внутренних — account_id (логическая ссылка на accounts).
  end note

  class conference_sessions {
    + PK_id : uuid
    + FK_conference_id : uuid
    + correlation_id : text
    + started_at : timestamp
    + ended_at : timestamp
    + status : text               ' starting / active / ended / failed
  }

  note right of conference_sessions
    conference_sessions — экземпляры (сессии) проведения конференции.
    correlation_id обеспечивает связь с трейсингом и с call_sessions/cdr_records.
  end note

  class conference_recordings {
    + PK_id : uuid
    + FK_conference_session_id : uuid
    + storage_key : text         ' S3 key
    + duration_sec : integer
    + created_at : timestamp
  }

  note right of conference_recordings
    conference_recordings — метаданные записей конференций.
    storage_key хранит ключ объекта в S3 (Object Storage).
  end note

  ' Физические связи внутри DB_CONFERENCES
  conferences "1" -- "*" conference_participants : FK_conference_id
  conferences "1" -- "*" conference_sessions : FK_conference_id
  conference_sessions "1" -- "*" conference_recordings : FK_conference_session_id
}

' ==========================================================
' ЛОГИЧЕСКИЕ СВЯЗИ МЕЖДУ ДОМЕНАМИ (между БД) — пунктиром
' ==========================================================

' --- DB_CALLS <-> DB_ACCOUNTS (логические) ---
call_sessions .. accounts : initiator_account_id / callee_account_id
call_legs .. user_devices : device_id
queue_members .. accounts : account_id
policy_decision_audit .. accounts : subject_account_id

' --- DB_CDR <-> DB_ACCOUNTS (логические) ---
cdr_records .. accounts : account_id
cdr_records .. user_devices : device_id
account_billing .. accounts : account_id

' --- DB_MESSAGING <-> DB_ACCOUNTS (логические) ---
conversation_participants .. accounts : account_id
messages .. accounts : sender_account_id
message_receipts .. accounts : account_id
presence_status .. accounts : account_id
presence_subscriptions .. accounts : subscriber_account_id / target_account_id

' --- DB_CONFERENCES <-> DB_ACCOUNTS (логические) ---
conferences .. accounts : owner_account_id
conference_participants .. accounts : account_id (internal)

' --- ЛОГИЧЕСКАЯ СВЯЗЬ Call Sessions <-> Conference Sessions (через correlation_id / call_type=conference) ---
call_sessions .. conference_sessions : correlation_id / call_type=conference

' ==========================================================
' ОБЩЕЕ ПРИМЕЧАНИЕ
' ==========================================================
note bottom
  Разделение по БД (соответствует контейнерной/деплоймент диаграммам):
  - DB_ACCOUNTS — IAM/профили/устройства/feature_flags/routing_rules + привязки политик (policy_assignments)
  - DB_CALLS — сигнализация: call_sessions/call_legs/call_routing/queues + аудит ABAC решений (policy_decision_audit)
  - DB_CDR — детализация и биллинг
  - DB_MESSAGING — чат и presence (включая receipts и attachments -> S3)
  - DB_CONFERENCES — голосовые конференции (комнаты/участники/сессии/записи -> S3)

  Хранилища вне PostgreSQL:
  - Redis — кэш сессий/маршрутов/presence/active chats
  - Object Storage (S3) — записи разговоров/конференций, вложения сообщений

  Условности:
  - Сплошные связи внутри пакета = физические FK в одной БД.
  - Пунктир между пакетами = логические ссылки (на уровне приложения), без cross-DB FK.
end note

@enduml