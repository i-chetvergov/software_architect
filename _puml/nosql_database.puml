@startuml nosql_database
title Схема нереляционных хранилищ "Платформа Унифицированных Коммуникаций" (логический уровень)

skinparam linetype ortho
skinparam classAttributeIconSize 0
left to right direction

skinparam backgroundColor #FFFFFF
skinparam legendBackgroundColor #EEEBDC
skinparam legendBorderColor #2D3E50

skinparam package {
  BackgroundColor #F5F5F5
  BorderColor #424242
}

' ВАЖНО:
' 1) Kafka выбрана как единая event-bus (из deployment).
' 2) Object Storage — S3 API (AWS S3 / MinIO) + политика хранения/retention.
' 3) Добавлены структуры для:
'    - voice conferencing (отдельный домен нагрузки),
'    - OPA/Policy bundles (PDP),
'    - idempotency/dedup в Kafka-консьюмерах,
'    - выдачи pre-signed URL (контролируемый доступ к S3),
'    - Outbox/Inbox паттерна (логически) для "DB -> Kafka" надежности.

' ==========================================================
' OBJECT STORAGE (S3)
' ==========================================================
package "Object Storage\n(S3 API: AWS S3 / MinIO)\nДомен: Медиа-файлы и записи" {

  class recording_bucket {
    + bucket_name : text
    + region : text
    + storage_class : text    ' STANDARD / GLACIER / DEEP_ARCHIVE (пример)
    + lifecycle_policy : json
    + encryption : text       ' SSE-S3 / SSE-KMS
  }

  note right of recording_bucket
    recording_bucket — записи разговоров и конференций (S3).

    Пример структуры ключей:
    - recordings/calls/{call_id}/{session_id}/audio.opus
    - recordings/calls/{call_id}/{session_id}/video.webm
    - recordings/conferences/{conf_session_id}/mix.opus
    - transcripts/{call_id}/{session_id}/stt.json

    Access pattern:
    - запись: Media/Recording Service
    - чтение: через контролируемые ссылки (pre-signed URL)
      с проверкой прав (ABAC/OPA) в API Gateway/Policy PDP.
  end note

  class media_assets_bucket {
    + bucket_name : text
    + region : text
    + storage_class : text
    + cdn_enabled : boolean
  }

  note right of media_assets_bucket
    media_assets_bucket — медиа-ассеты:
    - вложения чатов (files)
    - голосовые сообщения
    - аватары
    - превью/миниатюры

    CDN используется только для публично-кэшируемых ресурсов
    (например, ассеты), но НЕ для защищённых записей разговоров,
    где доступ должен быть авторизован.
  end note

  class object_index {
    + object_id : uuid
    + bucket_name : text
    + object_key : text
    + owner_account_id : uuid
    + object_type : text        ' call_recording / conf_recording / attachment / avatar / voicemail
    + content_type : text
    + size_bytes : bigint
    + checksum : text
    + created_at : timestamp
    + retention_until : timestamp
    + access_policy_ref : text  ' ссылка на политику/класс доступа
  }

  note right of object_index
    object_index — логический индекс объектов S3.

    Важно:
    - сам индекс хранится в PostgreSQL (DB_CDR/DB_MESSAGING/DB_CONFERENCES),
      но здесь показан как "каталог" для S3, чтобы не сканировать бакеты.
    - retention_until поддерживает compliance-ретеншн
      (запрет удаления до даты).
  end note

  class presigned_url_lease {
    + lease_id : uuid
    + object_id : uuid
    + issued_to_account_id : uuid
    + purpose : text           ' download / upload
    + url_expires_at : timestamp
    + issued_at : timestamp
    + revoked_at : timestamp
  }

  note right of presigned_url_lease
    presigned_url_lease — учёт выдачи временных ссылок (pre-signed URL).
    Используется для:
    - аудита доступа к записям/вложениям,
    - ограничений по времени и отзыву,
    - привязки к пользователю/контексту доступа.
  end note

  object_index ..> recording_bucket : хранится как объект
  object_index ..> media_assets_bucket : хранится как объект
  presigned_url_lease ..> object_index : выдача URL на объект
}

' ==========================================================
' REDIS (Key-Value)
' ==========================================================
package "Redis\n(Key-Value Store)\nДомен: Кэш, сессии, дедупликация" {

  class session_cache {
    + key_pattern : text      ' session:{session_id}
    + value_type : text       ' hash
    + ttl_sec : integer
  }

  class token_cache {
    + key_pattern : text      ' token:{token_hash}
    + value_type : text       ' string/json
    + ttl_sec : integer
  }

  class presence_cache {
    + key_pattern : text      ' presence:{account_id}
    + value_type : text       ' hash
    + ttl_sec : integer
  }

  class active_chats_cache {
    + key_pattern : text      ' chat:{conversation_id}:active
    + value_type : text       ' zset
    + ttl_sec : integer
  }

  class rate_limit_cache {
    + key_pattern : text      ' ratelimit:{subject}:{endpoint}
    + value_type : text       ' counter
    + ttl_sec : integer
  }

  class idempotency_keys {
    + key_pattern : text      ' idem:{service}:{operation}:{request_id}
    + value_type : text       ' string
    + ttl_sec : integer
  }

  note right of idempotency_keys
    idempotency_keys — ключи идемпотентности для команд и консьюмеров событий:
    - защита от повторной обработки (Kafka at-least-once)
    - дедупликация повторных запросов клиента
    TTL = окно повторной доставки/ретраев (например, 24-72 часа).
  end note

  class routing_cache {
    + key_pattern : text      ' route:{tenant}:{callee}
    + value_type : text       ' hash/json
    + ttl_sec : integer
  }

  note right of routing_cache
    routing_cache — кэш результатов маршрутизации:
    - уменьшает обращения к DB_ACCOUNTS (routing_rules) и DB_CALLS
    - критичен для low-latency пути Call Control.
  end note
}

' ==========================================================
' KAFKA (Event Bus) — ДОБАВЛЕНО
' ==========================================================
package "Kafka\n(Event Bus)\nДомен: События и интеграции" {

  class topic_call_events {
    + name : text = "call-events"
    + partitions : int
    + retention_ms : bigint
    + key : text             ' call_id / correlation_id
  }

  class topic_cdr_events {
    + name : text = "cdr-events"
    + partitions : int
    + retention_ms : bigint
    + key : text             ' call_id / correlation_id
  }

  class topic_chat_events {
    + name : text = "chat-events"
    + partitions : int
    + retention_ms : bigint
    + key : text             ' conversation_id
  }

  class topic_presence_events {
    + name : text = "presence-events"
    + partitions : int
    + retention_ms : bigint
    + key : text             ' account_id
  }

  class topic_conf_events {
    + name : text = "conf-events"
    + partitions : int
    + retention_ms : bigint
    + key : text             ' conference_id / conf_session_id
  }

  class schema_registry {
    + enabled : boolean
    + format : text          ' Avro / Protobuf / JSON Schema
    + compatibility : text   ' BACKWARD / FULL
  }

  note right of schema_registry
    Schema Registry (опционально, но рекомендуется):
    - фиксирует контракты событий,
    - обеспечивает эволюцию схем (compatibility),
    - снижает риск "сломанных" событий между сервисами.
  end note

  class consumer_groups {
    + group_id : text
    + topics : text
    + commit_strategy : text  ' at-least-once
  }

  note right of consumer_groups
    consumer_groups — логическое представление групп консьюмеров:
    - billing-cdr-consumer
    - presence-subscriber
    - notification-dispatcher
    - analytics-exporter

    Поведение: at-least-once => нужна идемпотентность (Redis idempotency_keys)
    и/или inbox/outbox на уровне сервисов.
  end note
}

' ==========================================================
' POLICY STORAGE (OPA Bundles) — ДОБАВЛЕНО
' ==========================================================
package "Policy Storage\n(OPA bundles)\nДомен: ABAC/REGO политики" {

  class policy_bundles {
    + bundle_id : text
    + version : text
    + source : text         ' git/http
    + checksum : text
    + published_at : timestamp
  }

  note right of policy_bundles
    policy_bundles — хранилище/каталог версий политик OPA.
    Физическая реализация может быть:
    - Git репозиторий
    - HTTP bundle server
    - S3 bucket (policy-bundles/)
  end note

  class policy_cache {
    + key_pattern : text     ' opa:bundle:{version}
    + value_type : text      ' json
    + ttl_sec : integer
  }

  note right of policy_cache
    policy_cache — кэш активной версии политик для PDP.
    Может быть реализован:
    - локально в OPA (in-memory),
    - или в Redis (как shared-cache) для ускорения rollout/rollback.
  end note
}

' ==========================================================
' TIME-SERIES (Prometheus/TSDB)
' ==========================================================
package "Time-Series Database\n(Prometheus / TSDB)\nДомен: Метрики" {

  class metrics_series {
    + metric_name : text
    + labels : map<string, string>
    + timestamp : timestamp
    + value : numeric
  }

  class call_quality_metrics {
    + metric_name : text
    + correlation_id : text
    + timestamp : timestamp
    + rtt_ms : numeric
    + packet_loss_percent : numeric
    + jitter_ms : numeric
    + mos_score : numeric
  }

  note right of call_quality_metrics
    Метрики качества — должны коррелироваться по correlation_id/trace_id,
    чтобы связывать качество медиа с конкретной сессией/маршрутом.
  end note
}

' ==========================================================
' LOG STORAGE (Loki/Elasticsearch)
' ==========================================================
package "Log Storage\n(Loki / Elasticsearch)\nДомен: Логи и аудит" {

  class application_logs {
    + log_level : text
    + service_name : text
    + timestamp : timestamp
    + message : text
    + fields : json
  }

  class audit_logs {
    + event_type : text
    + account_id : uuid
    + action : text
    + resource_type : text
    + resource_id : text
    + timestamp : timestamp
    + ip_address : text
    + user_agent : text
  }

  note right of audit_logs
    audit_logs — аудит ИБ.
    Важно включать события:
    - выдача pre-signed URL (доступ к записи/вложению)
    - решения ABAC (allow/deny) для критичных действий
    - административные изменения конфигурации/политик
  end note
}

' ==========================================================
' TRACE STORAGE (Tempo/Jaeger)
' ==========================================================
package "Trace Storage\n(Tempo / Jaeger)\nДомен: Трейсы" {

  class trace_spans {
    + trace_id : text
    + span_id : text
    + parent_span_id : text
    + service_name : text
    + operation_name : text
    + start_time : timestamp
    + duration_ms : numeric
    + tags : map<string, string>
  }
}

' ==========================================================
' СВЯЗИ И ИНТЕГРАЦИИ (логические)
' ==========================================================

' --- Object Storage логика доступа ---
presigned_url_lease ..> audit_logs : аудит выдачи ссылки
application_logs ..> trace_spans : логи коррелируются с трейсам по trace_id

' --- Redis логика ---
idempotency_keys ..> consumer_groups : дедупликация повторной обработки
session_cache ..> topic_call_events : актуализация статуса по событиям
presence_cache ..> topic_presence_events : обновления статусов
active_chats_cache ..> topic_chat_events : события активности в чатах
routing_cache ..> topic_call_events : кэш маршрутов может инвалидироваться событиями

' --- Kafka контракты ---
topic_call_events ..> schema_registry : контракт событий
topic_chat_events ..> schema_registry : контракт событий
topic_conf_events ..> schema_registry : контракт событий

' --- Policy bundles ---
policy_bundles ..> policy_cache : ускорение распространения
policy_bundles ..> object_index : политики могут управлять доступом к объектам (логически)

' --- Метрики/логи/трейсы ---
metrics_series ..> topic_call_events : метрики агрегируют события (логически)
call_quality_metrics ..> trace_spans : корреляция качества с трейсами

' ==========================================================
' ОБЩЕЕ ПРИМЕЧАНИЕ
' ==========================================================
note bottom
  Нереляционные хранилища UC-платформы (логический уровень):

  1) Object Storage (S3 API):
      - записи звонков/конференций, вложения чатов, ассеты
      - контролируемый доступ через pre-signed URL + ABAC/OPA
      - индексация объектов (object_index) хранится в PostgreSQL, но показана здесь как каталог

  2) Redis:
      - session_cache/presence_cache/active_chats_cache
      - rate_limit_cache (API Gateway)
      - idempotency_keys (обязательно при Kafka at-least-once)
      - routing_cache (low-latency путь Call Control)

  3) Kafka (выбранный event-bus):
      - топики по доменам: call/cdr/chat/presence/conf
      - схема событий через Schema Registry (рекомендовано)
      - at-least-once => идемпотентность и дедупликация

  4) Observability:
      - метрики (Prometheus/TSDB), логи (Loki/ELK), трейсы (Tempo/Jaeger)

  5) Политики (ABAC/OPA):
      - bundles/versions (policy_bundles) + кэш (policy_cache)
      - аудит решений и выдачи доступа к объектам

  Диаграмма согласована с:
  - Container: выделены Chat, Voice Conferencing, OPA PDP, Kafka, S3
  - Deployment: Kafka выбран явно; S3 как AWS S3/MinIO; протоколы зафиксированы
end note

@enduml