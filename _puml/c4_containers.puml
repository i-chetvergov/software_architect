@startuml c4_containers
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

skinparam backgroundColor #FFFFFF
skinparam legendBackgroundColor #EEEBDC
skinparam legendBorderColor #2D3E50

skinparam linetype ortho
skinparam componentStyle rectangle
skinparam shadowing false
skinparam defaultTextAlignment center
left to right direction

title "Платформа Унифицированных Коммуникаций — Контейнерная диаграмма системы"

' ==========================================================
' ТЕГИ И СТИЛИ (усиленная контрастность фона под светлый текст)
' ==========================================================
AddElementTag("Сигнализация", $bgColor="#1565C0", $borderColor="#0D47A1")
AddElementTag("Медиа",       $bgColor="#2E7D32", $borderColor="#1B5E20")
AddElementTag("Presence",    $bgColor="#EF6C00", $borderColor="#E65100")
AddElementTag("Монетизация", $bgColor="#6A1B9A", $borderColor="#4A148C")
AddElementTag("Платформа",   $bgColor="#455A64", $borderColor="#263238")
AddElementTag("Периметр",    $bgColor="#C62828", $borderColor="#B71C1C")
AddElementTag("Данные",      $bgColor="#283593", $borderColor="#1A237E")

' Новый домен для политик (ABAC/OPA)
AddElementTag("Политики",    $bgColor="#F9A825", $borderColor="#F57F17")

' ==========================================================
' АКТЁРЫ
' ==========================================================
Person(corpUser, "Корпоративный пользователь", "Сотрудник/агент, использующий UC-платформу")
Person(admin, "Администратор UC", "IT-администратор, управляющий системой")
Person(securityOfficer, "Офицер ИБ", "Контроль доступа, политики, аудит")
Person(externalUser, "Внешний пользователь", "Подключение по ссылке через приложение/браузер")

' ==========================================================
' ВНЕШНИЕ СИСТЕМЫ
' ==========================================================
System_Ext(ucClients, "UC Clients", "Web (WebRTC/WebTransport), Mobile (iOS/Android), Desktop")
System_Ext(idp, "Identity Provider", "AD/Okta/Azure AD — аутентификация и SSO")
System_Ext(crm, "CRM / ERP / Service Desk", "Интеграции с бизнес-системами")
System_Ext(pstn, "PSTN / Операторская сеть", "Голосовая связь через SIP-транки")
System_Ext(esmsgw, "Email/SMS/Push Gateway", "Шлюз уведомлений")
System_Ext(monitoring, "Системы мониторинга и ИБ", "SIEM/SOC/Monitoring")

' ==========================================================
' СИСТЕМА UC PLATFORM
' ==========================================================
System_Boundary(ucPlatform, "Платформа Унифицированных Коммуникаций") {

	' ---- Периметр ----
	Container(apiGateway, "API Gateway", "HTTPS, REST, WebSocket", "API-шлюз/WAF: маршрутизация, rate-limit, authN/authZ на периметре", $tags="Периметр")
	Container(iam, "IAM Service", "OIDC, SAML 2.0", "IdP/Authorization Server: SSO, выдача токенов, управление сессиями", $tags="Периметр")

	' ---- Политики (ABAC) ----
	Container(policyPDP, "Policy Decision Point (OPA)", "HTTP/gRPC", "PDP: вычисление ABAC/REGO решений по входным атрибутам и контексту", $tags="Политики,Периметр")
	Container(policyBundle, "Policy Bundle/Distribution", "HTTP, Git, Events", "Доставка/версионирование политик (bundles), роллаута и отката", $tags="Политики,Платформа")

	' ---- Сигнализация ----
	Container(callControl, "Call Control Service", "HTTP, gRPC, SIP", "Управление вызовами и маршрутизация", $tags="Сигнализация")
	Container(sipgw, "SIP Gateway / SBC", "SIP, SIP/TLS", "SBC для SIP-транков: policy, нормализация, защита, interop", $tags="Сигнализация,Периметр")
	Container(webrtcGw, "WebRTC Gateway", "WebRTC, WebTransport", "Шлюз для real-time соединений клиента (сигнализация/ICE/DTLS)", $tags="Сигнализация")

	' ---- Медиа ----
	Container(mediaRec, "Media / Recording Service", "RTP, SRTP", "Обработка медиапотоков, запись, транскодирование", $tags="Медиа")

	' ---- Presence ----
	Container(presence, "Presence Service", "HTTP, gRPC, Events", "Статусы пользователей, подписки, события присутствия", $tags="Presence")

	' ---- Messaging (чат отдельно) ----
	Container(chat, "Messaging / Chat Service", "WebSocket, HTTP, Events", "Текстовый чат: комнаты, сообщения, вложения", $tags="Presence")

	' ---- Voice Conferencing (отдельно от чата) ----
	Container(voiceConf, "Voice Conferencing Service", "SIP, WebRTC, gRPC, Events", "Голосовые конференции: комнаты, микширование/мост, управление участниками", $tags="Медиа,Сигнализация")

	' ---- Монетизация и биллинг ----
	Container(billing, "Billing / CDR Service", "HTTP, gRPC, Events", "CDR, тарификация, экспорт/интеграции", $tags="Монетизация")

	' ---- Платформа ----
	Container(provisioning, "Provisioning Service", "HTTP, gRPC, Events", "Пользователи, конфигурации, номера, политики", $tags="Платформа")
	Container(notify, "Notification Service", "HTTP, Events", "Уведомления: email/SMS/push, события", $tags="Платформа")
	Container(observability, "Observability Stack", "Metrics, Logs, Traces", "Мониторинг, логирование, трейсинг, аудит", $tags="Платформа")

	' ---- Данные (в составе платформы) ----
	ContainerDb(dbAccounts, "БД аккаунтов и профилей", "PostgreSQL", "Аккаунты, профили, конфигурации", $tags="Данные")
	ContainerDb(dbCalls, "БД сигнализации и вызовов", "PostgreSQL", "Сессии, маршрутизация, состояния вызовов", $tags="Данные")
	ContainerDb(dbCdr, "БД CDR и биллинга", "PostgreSQL", "CDR/биллинг данные", $tags="Данные")
	ContainerDb(dbMessaging, "БД messaging/presence", "PostgreSQL", "Чаты, сообщения, presence", $tags="Данные")
	ContainerDb(dbConferences, "БД конференций", "PostgreSQL", "Комнаты/участники/метаданные конференций", $tags="Данные")

	ContainerDb(cache, "Кэш / сессии", "Redis", "Сессии, токены (cache), presence cache, краткоживущие данные", $tags="Данные")
	ContainerQueue(messageQueue, "Очередь сообщений", "Kafka / RabbitMQ", "Асинхронные события/интеграции/буферизация пиков", $tags="Данные")
	ContainerDb(objStore, "Object Storage", "S3-compatible", "Записи разговоров и медиа-файлы", $tags="Данные")
}

' ==========================================================
' ВЗАИМОДЕЙСТВИЯ ПОЛЬЗОВАТЕЛЕЙ
' ==========================================================
Rel(corpUser, ucClients, "Использует", "голос/видео/чат")
Rel(externalUser, ucClients, "Подключается", "по ссылке (web/app)")
Rel(admin, apiGateway, "Администрирует", "UI/API: пользователи, политики, маршруты")
Rel(securityOfficer, observability, "Контролирует", "аудит, события ИБ, корреляции")

' ==========================================================
' КЛИЕНТСКИЕ ВЗАИМОДЕЙСТВИЯ
' ==========================================================
Rel(ucClients, apiGateway, "HTTPS/JSON", "REST/Web API")
Rel(ucClients, webrtcGw, "WebTransport", "real-time сигнализация/обновления")
Rel(ucClients, webrtcGw, "WebRTC (DTLS/SRTP)", "медиа (голос/видео)")

' Чат: отдельный путь
Rel(ucClients, chat, "WebSocket/HTTPS", "текстовый чат")

' Голосовые конференции: отдельный домен и профиль нагрузки
Rel(ucClients, voiceConf, "SIP/WebRTC", "участие в голосовых конференциях")
Rel(ucClients, voiceConf, "WebRTC (DTLS/SRTP)", "медиа конференции")

' ==========================================================
' АУТЕНТИФИКАЦИЯ / АВТОРИЗАЦИЯ
' ==========================================================
Rel(apiGateway, iam, "OIDC (JWT) / Introspection (optional)", "Проверка токенов, сессии")
Rel(iam, idp, "OIDC / SAML 2.0", "SSO/федерация")

' PDP: решения политик доступа (ABAC)
Rel(apiGateway, policyPDP, "HTTP/gRPC", "Проверка доступа: allow/deny + obligations")
Rel(provisioning, policyBundle, "HTTP/Events", "Публикация/версионирование политик")
Rel(policyBundle, policyPDP, "Bundle pull", "Доставка REGO/bundles (rollout/rollback)")

' Downstream сервисы получают identity context от API Gateway и/или валидируют JWT локально (JWKS cache).
Rel(apiGateway, provisioning, "HTTP/gRPC + Identity Context", "управление пользователями/конфигами")
Rel(apiGateway, callControl, "HTTP/gRPC + Identity Context", "инициация/управление вызовами")
Rel(apiGateway, presence, "HTTP/gRPC + Identity Context", "статусы/подписки")
Rel(apiGateway, notify, "HTTP/gRPC + Identity Context", "инициация уведомлений")

' Для чата и конференций также проходит через Gateway (для API), а real-time каналы — напрямую
Rel(apiGateway, chat, "HTTP/gRPC + Identity Context", "операции управления чатами (метаданные)")
Rel(apiGateway, voiceConf, "HTTP/gRPC + Identity Context", "операции управления конференциями (метаданные)")

' ==========================================================
' СИГНАЛИЗАЦИЯ (КЛЮЧЕВОЙ ПУТЬ)
' ==========================================================
Rel(callControl, sipgw, "SIP (internal) / SIP-TLS (optional)", "входящие/исходящие вызовы")
Rel(callControl, webrtcGw, "gRPC/Events", "управление сессиями WebRTC/звонками")

' Вызовы конференций: call control управляет конференцией (room/participant state)
Rel(callControl, voiceConf, "gRPC/Events", "создание/управление комнатой конференции")

' Операторская сеть: доверенная связность на периметре
Rel(sipgw, pstn, "SIP over TLS (mTLS) + ACL", "SIP-транки к оператору")
Rel(pstn, sipgw, "SIP over TLS (mTLS) + ACL", "входящие SIP-транки")

' ==========================================================
' МЕДИА
' ==========================================================
Rel(webrtcGw, mediaRec, "RTP/SRTP", "медиа-потоки и запись")
Rel(sipgw, mediaRec, "RTP/SRTP", "медиа-потоки (PSTN)")

' Медиа конференций: либо через voiceConf (мост), либо через mediaRec для записи
Rel(voiceConf, mediaRec, "RTP/SRTP", "запись конференций/интеграция с записью")

' ==========================================================
' PRESENCE / MESSAGING
' ==========================================================
Rel(chat, presence, "Events", "активность -> presence")
Rel(presence, chat, "Events", "уведомления о статусах")

' ==========================================================
' БИЛЛИНГ / CDR (async)
' ==========================================================
Rel(callControl, billing, "Events (CDR)", "детализация вызовов [async]")
Rel(mediaRec, billing, "Events", "записи/метаданные [async]")
Rel(voiceConf, billing, "Events", "CDR конференций/участников [async]")
Rel(billing, crm, "REST/Export", "отчётность/интеграции")

' ==========================================================
' ПЛАТФОРМА: PROVISIONING/NOTIFY
' ==========================================================
Rel(provisioning, callControl, "Events", "номера/маршруты/политики вызовов")
Rel(provisioning, billing, "Events", "тарифы/правила биллинга")
Rel(notify, esmsgw, "SMTP/HTTPS", "email/SMS/push")

' ==========================================================
' ДОСТУП К ДАННЫМ
' ==========================================================
Rel(provisioning, dbAccounts, "SQL", "аккаунты/профили/конфиги")
Rel(callControl, dbCalls, "SQL", "сессии/маршрутизация")
Rel(billing, dbCdr, "SQL", "CDR/биллинг")
Rel(chat, dbMessaging, "SQL", "сообщения/чаты")
Rel(presence, dbMessaging, "SQL", "presence")
Rel(voiceConf, dbConferences, "SQL", "комнаты/участники/метаданные")

Rel(callControl, cache, "Redis", "кэш сессий/маршрутов")
Rel(presence, cache, "Redis", "presence cache")
Rel(chat, cache, "Redis", "активные чаты")
Rel(apiGateway, cache, "Redis", "rate-limit/session cache (optional)")
Rel(voiceConf, cache, "Redis", "временные состояния комнат (optional)")

Rel(mediaRec, objStore, "S3 API", "recordings/медиа")

' ==========================================================
' ASYNC / EVENT-DRIVEN
' ==========================================================
Rel(callControl, messageQueue, "Events", "call started/ended/state [async]")
Rel(billing, messageQueue, "Events", "billing events [async]")
Rel(provisioning, messageQueue, "Events", "служебные события [async]")
Rel(observability, messageQueue, "Events", "события для алёртов/аналитики [async]")
Rel(chat, messageQueue, "Events", "chat events (delivered/read) [async]")
Rel(voiceConf, messageQueue, "Events", "conference events (join/leave) [async]")

' ==========================================================
' OBSERVABILITY
' ==========================================================
Rel(callControl, observability, "Metrics/Logs/Traces", "KPI сигнализации [async]")
Rel(mediaRec, observability, "Metrics/Logs/Traces", "качество медиа [async]")
Rel(chat, observability, "Metrics/Logs/Traces", "KPI messaging [async]")
Rel(presence, observability, "Metrics/Logs/Traces", "KPI presence [async]")
Rel(voiceConf, observability, "Metrics/Logs/Traces", "KPI conferencing [async]")
Rel(billing, observability, "Metrics/Logs/Traces", "бизнес-метрики [async]")
Rel(provisioning, observability, "Metrics/Logs/Traces", "метрики платформы [async]")

Rel(observability, monitoring, "Export/Forward", "SIEM/SOC/Monitoring")

' ==========================================================
' ПРИМЕЧАНИЯ
' ==========================================================
note right of ucPlatform
	Контейнерный уровень (C4):
	каждый контейнер — развернутый сервис или приложение.

	Периметр и идентификация:
	- IAM выдаёт токены/сессии (OIDC/SAML).
	- API Gateway выполняет authN/authZ на входе.
	- PDP (OPA) формально реализует ABAC:
		allow/deny + obligations.
	- Сервисы не вызывают IAM на каждый запрос.
end note

note bottom of policyPDP
	ABAC/OPA (PDP):
	- вход: subject, resource, action, context
	- выход: allow/deny, obligations
	- политики: REGO bundles (rollout/rollback)
end note

note bottom of chat
	Messaging домен:
	- текстовый чат, вложения, delivery/read
	- иной профиль нагрузки, чем conferencing
end note

note bottom of voiceConf
	Voice Conferencing домен:
	- комнаты, управление участниками
	- media bridge/mixing, высокий RTP-трафик
	- отдельные требования по latency/jitter
end note

note bottom of sipgw
	Периметр для SIP-транков (оператор):
	- SIP over TLS (mTLS) + IP ACL/Policy
	- защита от SIP-flood/DDoS
	- нормализация и interop
end note

note bottom of messageQueue
	MessageQueue:
	- асинхронные события
	- буферизация пиков
	- слабая связность сервисов
end note

SHOW_LEGEND()
@enduml