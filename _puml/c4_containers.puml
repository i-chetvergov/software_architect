@startuml c4_containers
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
skinparam backgroundColor #FFFFFF
skinparam legendBackgroundColor #EEEBDC
skinparam legendBorderColor #2D3E50

skinparam linetype ortho
skinparam componentStyle rectangle
skinparam shadowing false
skinparam defaultTextAlignment center
left to right direction

title "Платформа Унифицированных Коммуникаций — Контейнерная диаграмма системы"

' ============ ЦВЕТОВАЯ СХЕМА ДОМЕНОВ ============
skinparam package {
  BackgroundColor<<Сигнализация>> #E3F2FD
  BorderColor<<Сигнализация>> #1976D2
  BackgroundColor<<Медиа>> #E8F5E9
  BorderColor<<Медиа>> #388E3C
  BackgroundColor<<Presence>> #FFF3E0
  BorderColor<<Presence>> #F57C00
  BackgroundColor<<Монетизация>> #F3E5F5
  BorderColor<<Монетизация>> #7B1FA2
  BackgroundColor<<Платформа>> #ECEFF1
  BorderColor<<Платформа>> #455A64
  BackgroundColor<<Периметр>> #FFEBEE
  BorderColor<<Периметр>> #C62828
  BackgroundColor<<Данные>> #E8EAF6
  BorderColor<<Данные>> #3F51B5
}

' ============ АКТЁРЫ ============

Person(corpUser, "Корпоративный пользователь", "Сотрудник, агент, использующий UC-платформу")
Person(admin, "Администратор UC", "IT-администратор, управляющий системой")
Person(securityOfficer, "Офицер информационной безопасности", "Специалист по безопасности, контролирующий доступ и политики ИБ")
Person(externalUser, "Внешний пользователь", "Любой человек, подключающийся по ссылке через приложение или браузер")

' ============ СИСТЕМА UC PLATFORM ============

System_Boundary(ucPlatform, "Платформа Унифицированных Коммуникаций") {
    
    ' ---- Периметр ----
    Container(apiGateway, "API Gateway", "HTTPS, REST, WebSocket", "API-шлюз и WAF для маршрутизации запросов")
    Container(iam, "IAM Service", "OIDC, SAML 2.0", "Сервис аутентификации и авторизации")
    
    ' ---- Сигнализация ----
    Container(callControl, "Call Control Service", "HTTP, gRPC, SIP", "Управление вызовами и маршрутизация")
    Container(sipgw, "SIP Gateway / SBC", "SIP", "Session Border Controller для SIP-транков")
    Container(webrtcGw, "WebRTC Gateway", "WebRTC, WebTransport", "WebRTC шлюз для клиентских соединений")
    
    ' ---- Медиа ----
    Container(mediaRec, "Media / Recording Service", "RTP, SRTP", "Обработка медиапотоков и запись разговоров")
    
    ' ---- Presence и Messaging ----
    Container(presence, "Presence Service", "HTTP, gRPC, Events", "Управление статусами пользователей")
    Container(chat, "Messaging / Chat Service", "WebSocket, WebRTC", "Текстовый и голосовой чат")
    
    ' ---- Монетизация и биллинг ----
    Container(billing, "Billing / CDR Service", "HTTP, gRPC, Events", "Детализация вызовов и биллинг")
    
    ' ---- Платформа ----
    Container(provisioning, "Provisioning Service", "HTTP, gRPC, Events", "Управление пользователями и конфигурацией")
    Container(notify, "Notification Service", "HTTP, Events", "Сервис уведомлений")
    Container(observability, "Observability Stack", "Metrics, Logs, Traces", "Мониторинг, логирование и трейсинг")
}

' ============ КЛИЕНТ ============

System_Ext(ucClients, "UC Clients", "Веб-клиент (WebRTC, WebTransport), мобильные приложения (iOS/Android), Desktop-клиенты")

' ============ ВНЕШНИЕ СИСТЕМЫ ============

System_Ext(idp, "Identity Provider", "Active Directory, Okta, Azure AD — аутентификация и SSO")
System_Ext(crm, "CRM / ERP / Service Desk", "Salesforce, SAP, Jira — интеграция с бизнес-системами")
System_Ext(pstn, "PSTN / Операторская сеть", "Операторы фиксированной связи и мобильные операторы — голосовая связь через SIP-транки")
System_Ext(esmsgw, "Email/SMS/Push Gateway", "Система уведомлений — email, SMS, push-уведомления")
System_Ext(monitoring, "Системы мониторинга и ИБ", "SIEM, Security — наблюдаемость и безопасность")

' ============ ХРАНИЛИЩА ДАННЫХ ============

SystemDb_Ext(dbAccounts, "БД аккаунтов и профилей", "PostgreSQL", "Хранилище аккаунтов, профилей, конфигураций")
SystemDb_Ext(dbCalls, "БД сигнализации и вызовов", "PostgreSQL", "Хранилище вызовов, сессий, маршрутизации")
SystemDb_Ext(dbCdr, "БД CDR и биллинга", "PostgreSQL", "Хранилище CDR записей и биллинговых данных")
SystemDb_Ext(dbMessaging, "БД presence и сообщений", "PostgreSQL", "Хранилище сообщений, чатов, presence")
SystemDb_Ext(cache, "Кэш / сессии", "Redis", "Кэширование сессий, токенов, presence")
SystemDb_Ext(messageQueue, "Очередь сообщений", "Kafka / RabbitMQ", "Брокер сообщений для асинхронной обработки")
SystemDb_Ext(objStore, "Object Storage", "S3-совместимое", "Хранение записей разговоров и медиа-файлов")

' ============ ВЗАИМОДЕЙСТВИЯ ПОЛЬЗОВАТЕЛЕЙ ============

Rel(corpUser, ucClients, "Использует", "Голос/видео/чат, управление контактами")
Rel(admin, apiGateway, "Администрирует", "Управление политиками, пользователями, маршрутизацией")
Rel(securityOfficer, observability, "Контролирует", "Мониторинг безопасности, аудит доступа")
Rel(externalUser, ucClients, "Подключается", "Подключение по ссылке через приложение или браузер")

' ============ КЛИЕНТСКИЕ ВЗАИМОДЕЙСТВИЯ ============

Rel(ucClients, apiGateway, "HTTPS/JSON", "REST / Web API-запросы")
Rel(ucClients, webrtcGw, "WebTransport/UDP", "Сигнализация вызовов (real-time)")
Rel(ucClients, webrtcGw, "WebRTC (DTLS/SRTP)", "Медиа-потоки (голос/видео)")
Rel(ucClients, chat, "WebSocket/WebRTC", "Чат и голосовой чат")

' ============ API-ШЛЮЗ К СЕРВИСАМ ============

Rel(apiGateway, iam, "HTTP/gRPC", "Валидация токенов")
Rel(apiGateway, callControl, "HTTP/gRPC", "Инициация/управление вызовами")
Rel(apiGateway, chat, "HTTP/gRPC", "Сообщения и чаты")
Rel(apiGateway, presence, "HTTP/gRPC", "Запросы статусов")
Rel(apiGateway, notify, "HTTP/gRPC", "Инициация уведомлений")
Rel(apiGateway, provisioning, "HTTP/gRPC", "Управление пользователями")

' ============ АУТЕНТИФИКАЦИЯ И АВТОРИЗАЦИЯ ============

Rel(callControl, iam, "gRPC / HTTP", "Валидация токенов runtime-сервисов")
Rel(mediaRec, iam, "gRPC / HTTP", "Валидация токенов медиа-сервисов")
Rel(presence, iam, "gRPC / HTTP", "Валидация токенов presence/messaging")
Rel(chat, iam, "gRPC / HTTP", "Валидация токенов presence/messaging")
Rel(provisioning, iam, "gRPC / HTTP", "Служебные проверки")
Rel(observability, iam, "gRPC / HTTP", "Служебные проверки")

Rel(iam, idp, "OIDC / SAML 2.0", "SSO и федерация")

' ============ СИГНАЛИЗАЦИЯ (КЛЮЧЕВОЙ ПУТЬ) ============

Rel(callControl, sipgw, "SIP", "Исходящие/входящие вызовы")
Rel(callControl, webrtcGw, "WebRTC (DTLS/SRTP)", "Сигнализация и медиа")
Rel(sipgw, pstn, "SIP-транки", "Интеграция с оператором")
Rel(pstn, sipgw, "SIP-транки", "Входящие вызовы")

' ============ МЕДИА (КЛЮЧЕВЫЕ ВЗАИМОДЕЙСТВИЯ) ============

Rel(webrtcGw, mediaRec, "RTP/SRTP", "Медиа-потоки и запись")
Rel(sipgw, mediaRec, "RTP/SRTP", "Медиа-потоки (PSTN)")

' ============ PRESENCE И MESSAGING ============

Rel(chat, presence, "Events", "Обновление статуса по активности")
Rel(presence, chat, "Events", "Уведомления о статусах")

' ============ МОНИТИЗАЦИЯ И БИЛЛИНГ ============

Rel(callControl, billing, "Events (CDR)", "Детализация вызовов [async]")
Rel(mediaRec, billing, "Events", "Информация о записях [async]")
Rel(billing, crm, "REST / Export", "Отчётность и интеграции")

' ============ ПЛАТФОРМА: PROVISIONING, NOTIFY ============

Rel(provisioning, iam, "REST / Events", "Создание/обновление пользователей")
Rel(provisioning, callControl, "REST / Events", "Номера, маршрутизация")
Rel(provisioning, billing, "REST / Events", "Тарифы, биллинг-параметры")

Rel(notify, esmsgw, "SMTP / HTTPS", "Уведомления (email/SMS/push)")
Rel(apiGateway, notify, "REST / Events", "Системные и бизнес-события")

' ============ ДОСТУП К ДАННЫМ ============

Rel(provisioning, dbAccounts, "SQL", "Аккаунты, профили, конфиги")
Rel(callControl, dbCalls, "SQL", "Вызовы, сессии, маршрутизация")
Rel(billing, dbCdr, "SQL", "CDR записи, биллинг")
Rel(chat, dbMessaging, "SQL", "Сообщения, чаты")
Rel(presence, dbMessaging, "SQL", "Presence")

' Агрегированное использование Redis
Rel(callControl, cache, "Redis", "Кэш сессий, токенов, маршрутизации")
Rel(presence, cache, "Redis", "Кэш presence, активные чаты")
Rel(chat, cache, "Redis", "Кэш активных чатов")
Rel(iam, cache, "Redis", "Кэш токенов и feature-флагов")

' Object Storage
Rel(mediaRec, objStore, "S3 API", "Запись медиа-файлов (recordings)")

' ============ НАБЛЮДАЕМОСТЬ И МЕТРИКИ (АГРЕГИРОВАНО) ============

Rel(callControl, observability, "Metrics", "Метрики сигнализации (вызовы, ошибки, latency) [async]")
Rel(mediaRec, observability, "Metrics", "Метрики медиа (качество, записи) [async]")
Rel(chat, observability, "Metrics", "Метрики messaging/presence [async]")
Rel(presence, observability, "Metrics", "Метрики messaging/presence [async]")
Rel(billing, observability, "Metrics", "Бизнес-метрики (CDR, биллинг) [async]")
Rel(provisioning, observability, "Metrics", "Тех. метрики платформы [async]")

Rel(observability, monitoring, "Metrics / Logs / Traces", "Наблюдаемость и ИБ")
Rel(observability, messageQueue, "Events", "События для фоновой аналитики / алёртов [async]")

' ============ АСИНХРОННАЯ ОБРАБОТКА (АГРЕГИРОВАНО) ============

Rel(callControl, messageQueue, "Events", "События вызовов (call started/ended) [async]")
Rel(billing, messageQueue, "Events", "События биллинга [async]")
Rel(provisioning, messageQueue, "Events", "Служебные события [async]")

' ============ ПРИМЕЧАНИЯ ============

note right of ucPlatform
    Контейнерный уровень (C4):
    каждый компонент — развернутый сервис
    или приложение, а не отдельный класс.
    
    Архитектурные принципы:
    - Микросервисная архитектура
    - Event-driven коммуникации
    - Real-time обработка (WebRTC, WebTransport)
    - Горизонтальное масштабирование
    - Отказоустойчивость (HA)
end note

note bottom of dbAccounts
    Слой данных разделён по доменам:
    - аккаунты и профили (dbAccounts);
    - сигнализация и вызовы (dbCalls);
    - CDR и биллинг (dbCdr);
    - presence и messaging (dbMessaging).
    
    Redis используется для:
    - кэширования часто читаемых данных;
    - хранения сессий и токенов;
    - временных данных (presence, активные чаты).
    
    Object Storage для:
    - хранения записей разговоров;
    - медиа-файлов.
end note

note bottom of callControl
    Сигнализация (runtime-контур):
    критический путь call_control --> sipgw/webrtc_gw,
    жёсткие требования к задержкам.
    
    WebTransport используется для:
    - низколатентной сигнализации;
    - real-time обновлений состояния.
end note

note bottom of mediaRec
    Медиа-сервисы:
    - обработка RTP/SRTP потоков;
    - запись разговоров;
    - транскодирование кодеков;
    - управление качеством (QoS).
end note

note bottom of billing
    Домены монетизации изолированы:
    изменения в биллинге и CDR
    не влияют напрямую на сигнализацию.
end note

note right of pstn
    PSTN интеграция через SBC:
    - Безопасная маршрутизация SIP-трафика
    - Нормализация сигнализации
    - Защита от атак (DDoS, SIP-флуд)
    - Транскодирование кодеков
end note

note bottom of messageQueue
    Очередь сообщений используется для:
    - асинхронной обработки событий;
    - интеграции между сервисами;
    - буферизации нагрузки в пиках;
    - event-driven архитектуры.
end note

SHOW_LEGEND()

@enduml
