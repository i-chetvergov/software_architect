@startuml UC_Seq_Outgoing_Call
' Исходящий голосовой вызов (WebRTC / SIP)

actor User as User
participant "UC Web Client" as Client
participant "API Gateway" as APIGW
participant "IAM Service" as IAM
participant "Call Control Service" as CallControl
participant "WebRTC Gateway" as WebRTCGW
participant "Media / Recording" as MediaRec
participant "SIP Gateway / SBC" as SIPGW
participant "PSTN / External Callee" as Callee
participant "Billing / CDR" as Billing

User -> Client : Нажимает «Позвонить»\n(указан номер/контакт)
Client -> APIGW : HTTPS REST /calls (access token)
APIGW -> IAM : Validate token (sync)
IAM --> APIGW : OK (user, scopes)
APIGW -> CallControl : REST createCall(user, target)
CallControl -> WebRTCGW : Create WebRTC session\n(SDP offer/answer)
WebRTCGW -> MediaRec : Reserve media resources\n(возможно, включить запись)
CallControl -> SIPGW : SIP INVITE (PSTN number)
SIPGW -> Callee : SIP INVITE
Callee --> SIPGW : SIP 180 Ringing / 200 OK
SIPGW --> CallControl : SIP 200 OK
CallControl --> Client : Call established (via APIGW / signaling)
Client -> WebRTCGW : WebRTC connect (DTLS/SRTP)
WebRTCGW -> MediaRec : RTP/SRTP media

... После завершения разговора ...
Callee -> SIPGW : BYE
SIPGW -> CallControl : BYE
CallControl -> WebRTCGW : Terminate session
WebRTCGW -> MediaRec : Stop recording
CallControl -> Billing : Event CallEnded(CDR data) (async)

@enduml

@startuml UC_Seq_Incoming_Call
' Входящий вызов через SBC/шлюз

participant "PSTN / External Caller" as ExtCaller
participant "Operator SBC" as ExtSBC
participant "SIP Gateway / SBC" as SIPGW
participant "Call Control Service" as CallControl
participant "Presence Service" as Presence
participant "UC Client (Agent)" as AgentClient
participant "API Gateway" as APIGW
participant "Media / Recording" as MediaRec
participant "Billing / CDR" as Billing

ExtCaller -> ExtSBC : SIP INVITE (company number)
ExtSBC -> SIPGW : SIP INVITE (normalized)
SIPGW -> CallControl : NewIncomingCall(number)
CallControl -> Presence : Query available agents for queue
Presence --> CallControl : List of available agents
CallControl -> APIGW : Notify agent via push/WebSocket
APIGW -> AgentClient : Incoming call (queue, caller info)
AgentClient -> APIGW : Accept call
APIGW -> CallControl : acceptCall(agentId, callId)
CallControl -> SIPGW : SIP 200 OK
SIPGW -> ExtSBC : SIP 200 OK
ExtSBC -> ExtCaller : SIP 200 OK

CallControl -> MediaRec : Start recording (optional)

... Медиа-путь устанавливается через SIP/RTP ...

ExtCaller -> ExtSBC : BYE
ExtSBC -> SIPGW : BYE
SIPGW -> CallControl : BYE
CallControl -> MediaRec : Stop recording
CallControl -> Billing : Event CallEnded(CDR data) (async)

@enduml

@startuml UC_Seq_User_Auth_Token
' Аутентификация пользователя и получение access token

actor User as User
participant "UC Web Client" as Client
participant "API Gateway" as APIGW
participant "IAM Service" as IAM
participant "Identity Provider / IdP" as IdP

User -> Client : Открывает UC Web Client
Client -> APIGW : GET /login (redirect request)
APIGW -> IAM : Start OIDC flow
IAM -> IdP : Redirect user to IdP /authorize
IdP -> User : Логин/пароль / MFA
User --> IdP : Credentials / Consent
IdP --> IAM : Authorization Code
IAM -> IdP : Token request (code exchange)
IdP --> IAM : ID Token + Access Token + Refresh Token
IAM --> APIGW : Validated token + user info
APIGW --> Client : Set session / tokens\n(SPA storage / cookie)

... Дальнейшие запросы ...
Client -> APIGW : HTTPS /api/... (access token)
APIGW -> IAM : Introspect/validate token
IAM --> APIGW : OK / scopes / roles
APIGW --> Client : Protected resource / success

@enduml