## Защитная речь по выпускному проекту  
**Тема:** Архитектура корпоративной платформы унифицированных коммуникаций (Unified Communications, UC)  
**Исполнитель:** Четвергов Иван

---

### 0. Короткое позиционирование (30 секунд)

Мой проект — это **архитектурный blueprint корпоративной UC-платформы**, в которой телефония (SIP/WebRTC), голосовые конференции, чаты и presence объединены в единый продукт с **единым контуром безопасности**, **наблюдаемостью** и **интеграциями**.  
Ключевая ценность архитектуры — **независимое масштабирование доменов**, предсказуемость **критичного пути обработки вызова** и управляемый доступ к чувствительным данным (CDR/recordings) через **ABAC/OPA + аудит**.

---

### 1. Вступление и позиционирование проекта

Сегодня я представляю выпускной архитектурный проект по курсу «Архитектор программного обеспечения».

Тема проекта — **платформа унифицированных коммуникаций корпоративного класса**.  
Цель работы — **сформировать и задокументировать целевую микросервисную архитектуру UC-платформы**, которая решает зафиксированные бизнес-проблемы, поддерживает ключевые сценарии коммуникаций и удовлетворяет требованиям по масштабируемости, доступности, безопасности и управляемости.

Документация оформлена как **архитектурный кейс** и публикуется через MkDocs и GitHub Pages.  
**GitHub-репозиторий является единым источником истины**: артефакты — в Markdown, диаграммы — как код на PlantUML с воспроизводимым экспортом в SVG. Это важно практическим образом: архитектура становится версионируемым и проверяемым продуктом, а не набором разрозненных рисунков.

Структура проекта следует архитектурному каркасу:
- проблема и бизнес-контекст;
- контекст системы и стейкхолдеры;
- бизнес-цели и KPI;
- архитектурные драйверы и ограничения;
- требования (FR/NFR), пользовательские сценарии и QAS;
- архитектурное решение;
- диаграммы (C4, Deployment, Database, NoSQL, Sequence);
- ADR и ADL.

Далее я последовательно проведу по этим уровням — от проблемы и контекста до конкретных решений и их последствий.

---

### 2. Проблема и бизнес-контекст

Исходная точка проекта — **фрагментированная коммуникационная среда** в типичной корпоративной организации.

Сегодня бизнес часто использует разрозненный набор телеком- и коммуникационных систем:  
отдельно телефония, видеоконференцсвязь, несколько мессенджеров, почта, специализированные сервисы.  
Эта среда сформировалась эволюционно — за счёт локальных внедрений, поглощений и договоров с разными вендорами.

Ключевые проблемы:
- **Фрагментация пользовательского опыта.** Пользователь переключается между несколькими приложениями, растёт время операций и стоимость обучения.
- **Недостаток интеграции с бизнес-процессами.** Коммуникации живут отдельно от CRM/Service Desk/ERP: теряется контекст, данные вводятся вручную, автоматизация становится дорогой.
- **Рост TCO.** Множество лицензий, дублирование инфраструктуры, разные процессы эксплуатации/ИБ увеличивают стоимость владения.
- **Ограниченная масштабируемость и надёжность.** Монолитные решения сложнее масштабировать горизонтально, появляются точки отказа, модернизация обходится дорого.
- **Неоднородная безопасность и контроль.** Разные политики authN/authZ и аудита повышают риски ИБ и усложняют выполнение регуляторных требований (особенно для CDR и записей разговоров).

Для бизнеса это означает снижение производительности, рост затрат, риски простоев/утечек и ограничения цифровой трансформации.

---

### 3. Контекст системы и стейкхолдеры

В разделе «Контекст» зафиксирован архитектурный взгляд на окружение UC-платформы.

Ключевые стейкхолдеры:
- **CIO / Head of Digital** — консолидация ландшафта, управляемость затрат, ускорение вывода сервисов, соответствие ИБ.
- **Руководители бизнес-подразделений** — единый UX, омниканальные сценарии обслуживания, ускорение онбординга.
- **Эксплуатация и ИБ** — единый IAM, централизованный мониторинг/аудит, интеграция с SIEM, управляемое реагирование.
- **Конечные пользователи** — кроссплатформенность, единая адресная книга, история коммуникаций, presence-статусы.
- **Внешние партнёры и интеграторы** — стандартизированные API/Events, стабильные контракты и версионирование.

Внешние системы:
- каталоги и IdP (AD/LDAP, OIDC/SAML);
- бизнес-системы (CRM, ERP, Service Desk);
- операторские сети и PSTN через SIP-транки и SBC;
- клиентские приложения (Web/Mobile/Desktop, SIP-устройства);
- мониторинг/логирование/SIEM.

На уровне контекста архитектурный контракт формализован протоколами SIP/WebRTC/HTTP, федерацией идентичности OIDC/SAML и событийной интеграцией через брокер сообщений.

---

### 4. Бизнес-цели и KPI

Проблемы и контекст были преобразованы в **бизнес-цели** с измеримыми критериями успеха.

Ключевые цели:
- **BG-01. Консолидация коммуникаций и единый UX.**
- **BG-02. Интеграция коммуникаций с бизнес-процессами** (API, Webhooks, Events).
- **BG-03. Снижение TCO** за счёт консолидации и унификации эксплуатационного контура.
- **BG-04. Надёжность и доступность** критичных сервисов на уровне корпоративных ожиданий.
- **BG-05. Единая модель безопасности и аудита** (централизованный IAM и аудит критичных операций).
- **BG-06. Расширяемость и независимое развитие доменов** без «пересборки монолита».

---

### 5. Архитектурные драйверы и ограничения

Сформированы **архитектурные драйверы**, которые определяют выбор стиля и механизмов архитектуры:
- **AD-01 Масштабируемость и эластичность** — независимое масштабирование доменов, stateless, autoscaling.
- **AD-02 Высокая доступность и отказоустойчивость** — отсутствие SPOF, self-healing, multi-zone.
- **AD-03 Безопасность и соответствие** — IAM, TLS/mTLS, SRTP/DTLS-SRTP, аудит и контроль доступа.
- **AD-04 Интегрируемость и открытость** — REST/gRPC, события, версионирование контрактов.
- **AD-05 Наблюдаемость и управляемость** — метрики, логи, трассировки, корреляция идентификаторов.
- **AD-06 Сопровождаемость и скорость изменений** — независимые релизы, CI/CD, rollback.
- **AD-07 Оптимизация TCO** — консолидация компонентов, унификация инфраструктуры.

Ограничения: поэтапная реализация, интеграция в существующую инфраструктуру, требования к хранению CDR/записей/аудита, ориентация на Kubernetes и открытые стандарты.

---

### 6. Требования, сценарии и атрибуты качества (FR/NFR, UC, QAS)

На основе драйверов сформирован реестр **FR/NFR**, а также проверочные **QAS**, чтобы архитектура была проверяемой, а не декларативной.

Функционально платформа покрывает:
- IAM и provisioning (пользователи, устройства, роли, конфигурации);
- телефонию и сигнализацию (входящие/исходящие вызовы, очереди, маршрутизация);
- чаты и обмен сообщениями;
- presence и статусы;
- конференции как отдельный домен;
- запись разговоров, хранение и управляемую выдачу доступа;
- CDR и биллинг/экспорт;
- наблюдаемость и аудит;
- интеграции с CRM/Service Desk/ERP.

Нефункционально зафиксированы: цели доступности, производительности критичного пути, безопасность (шифрование, контроль доступа), наблюдаемость, управляемость изменений, требования к ретеншну и соответствию.

---

### 7. Главные архитектурные идеи (то, что «держит» решение)

Чтобы архитектура была целостной и применимой в реальной эксплуатации, я опирался на три принципа:

**1) Разделение control plane и media plane.**  
Сигнализация и управление вызовом (Call Control, шлюзы) отделены от медиа-контра (RTP/SRTP, запись, микширование). Это позволяет независимо масштабировать и изолировать деградации.

**2) Гибрид синхронного и асинхронного взаимодействия.**  
Критичный путь выполняется через REST/gRPC с минимальным числом зависимостей.  
Тяжёлые операции (CDR, аналитика, уведомления, экспорт, часть интеграций) выполняются в async-контуре через Kafka.

**3) Security-by-default через IAM + ABAC/OPA.**  
Авторизация — не только роли, но и контекст (субъект, ресурс, действие, окружение).  
Доступ к чувствительным объектам (recordings/CDR) реализуется через ABAC-решения OPA и управляемые механизмы доступа (например, pre-signed URL), с обязательным аудитом.

---

### 8. Архитектурное решение (C4 + Deployment)

**C4 Context** фиксирует границу платформы и интеграции: IdP, CRM/Service Desk, PSTN через SBC, шлюзы уведомлений, мониторинг/SIEM.  

**C4 Containers** фиксирует домены и сервисы:
- периметр: **API Gateway** + **IAM** (OIDC/SAML);
- политики: **Policy PDP (OPA)** + доставка/версионирование policy bundles;
- сигнализация: **Call Control** + **SIP GW/SBC** + **WebRTC GW**;
- медиа: **Media/Recording**;
- **Presence**, **Messaging**, **Voice Conferencing** — отдельные домены;
- **Billing/CDR**, **Provisioning**, **Notifications**, **Observability**.

**C4 Component (Call Control)** показывает, как устроен критичный путь:
- входная точка команд: Call Control API;
- локальная обработка identity context без постоянного hop-а в IAM;
- ABAC-решение: Policy Client → OPA (allow/deny + obligations);
- оркестрация: Call Orchestrator;
- маршрутизация и применение obligations: Routing Engine / Route Policy Evaluator;
- управление состоянием: Session Manager + Call State Machine + идемпотентность;
- протокольные обработчики: SIP Handler / WebRTC Handler;
- события и CDR: Event Publisher / CDR Collector в async-контуре.

**Deployment** фиксирует целевую эксплуатационную модель:
- Kubernetes namespaces по доменам;
- HA для PostgreSQL/Redis/Kafka;
- S3 (AWS/MinIO) для медиа/recordings;
- observability (metrics/logs/traces) и интеграция с SIEM.

---

### 9. Данные и специализированные хранилища (Database + NoSQL)

**Database Diagram**: разделение по доменам:
- DB_ACCOUNTS, DB_CALLS, DB_CDR, DB_MESSAGING, DB_CONFERENCES.
Cross-domain ссылки — логические (без FK across DB) для независимого масштабирования и релизов.

**NoSQL Diagram**: специализированные хранилища:
- **S3**: записи/вложения, индекс объектов, учёт выдачи ссылок;
- **Redis**: кэш runtime-состояний, rate limit, routing cache, idempotency keys;
- **Kafka**: единый event-bus по доменам;
- **observability storage**: метрики/логи/трейсы;
- **policy bundles/cache** для OPA.

---

### 10. QAS как доказательство качества

Чтобы архитектура была проверяемой, QAS покрывают:
- performance критичного пути вызова (P95 по времени установления);
- независимое масштабирование chat vs conferencing;
- отказоустойчивость (падение узла/zone → RTO/RPO);
- безопасность: ABAC-проверки и аудит доступа к recordings/CDR;
- наблюдаемость: диагностика инцидента по trace_id/correlation_id;
- управляемость изменений: rollout/rollback сервисов и политик без простоя.

---

### 11. Поэтапное внедрение (roadmap / migration)

Архитектура применима в реальном бизнесе, потому что поддерживает поэтапный ввод:

**Этап 1: Периметр и идентичность**  
API Gateway + IAM, единая модель authN/authZ, базовые API.

**Этап 2: Сигнализация и базовая телефония**  
Call Control + SIP/WebRTC GW, базовые сценарии входящих/исходящих вызовов.

**Этап 3: Messaging + Presence**  
Реал-тайм контур, история сообщений, подписки presence.

**Этап 4: Conferencing и Media/Recording**  
Отдельная нагрузка, запись, S3, политика ретеншна.

**Этап 5: Интеграции и монетизация**  
CRM/Service Desk, CDR/Billing, экспорт.

---

### 12. Риски, компромиссы и меры снижения

Архитектура микросервисная и распределённая, значит риски известны заранее — и под них заложены меры:

- **Сложность распределённой системы** → observability (метрики/логи/трейсы), корреляция идентификаторов, стандарты логирования.
- **Событийная согласованность** → идемпотентность (Redis idempotency keys), контракты событий, ретраи и дедупликация.
- **Деградации из-за зависимостей** → минимизация синхронных hop-ов в критичном пути, тяжёлые операции в async.
- **Доступ к записям и чувствительным данным** → ABAC/OPA, аудит, pre-signed URL, retention/compliance.
- **Разные профили нагрузки (chat vs conferencing)** → отдельные сервисы и независимое масштабирование.

---

### 13. Итоги и ожидаемый эффект

Суммируя, целевая архитектура UC-платформы:
- консолидирует коммуникации и формирует единый UX;
- встраивает коммуникации в бизнес-процессы через API и события;
- обеспечивает масштабирование и отказоустойчивость через доменное разбиение и Kubernetes-модель;
- задаёт единый контур безопасности (IAM + ABAC/OPA) и полный аудит;
- обеспечивает эксплуатационную управляемость через observability;
- создаёт основу для эволюции платформы без «пересборки монолита».

Проект оформлен как полноценный архитектурный кейс: от проблем и целей — до требований, диаграмм, решений и ADR/ADL. Архитектура не привязана к конкретному вендору, но задаёт чёткие требования к реализации корпоративной UC-платформы.

---

### 14. Завершение

Спасибо за внимание. Готов ответить на вопросы и, при необходимости, пройти по любому уровню:  
от контекста и драйверов — до конкретных механизмов безопасности (ABAC/OPA), событийной модели (Kafka) и критичного пути обработки вызова (Call Control).

---

## Возможные вопросы комиссии и готовые ответы

### Q1. Почему выбран микросервисный стиль, а не модульный монолит?
**Ответ:** Потому что домены UC-платформы имеют разные профили нагрузки и разные NFR.  
Например, **conferencing** и **chat** требуют разного масштабирования, а медиа-контур (RTP/SRTP) по природе отличается от control plane. Микросервисы позволяют масштабировать домены независимо, локализовать отказ и выпускать изменения отдельно. При этом риски микросервисов компенсируются наблюдаемостью, контрактами и идемпотентностью.

### Q2. Почему Kafka как event-bus, а не RabbitMQ?
**Ответ:** В архитектуре важны:
- длительное хранение событий с retention,
- высокая пропускная способность,
- возможность повторного проигрыша событий (replay) для аналитики/интеграций,
- масштабируемость по partitions.
Kafka лучше подходит как единая доменная шина событий. RabbitMQ полезен как брокер задач/очередей, но здесь основной паттерн — event streaming и доменные топики.

### Q3. Как вы обеспечиваете согласованность данных между сервисами (если нет cross-DB FK)?
**Ответ:** Сознательно выбран подход **eventual consistency**.  
Внутри домена — транзакционная согласованность в своей БД. Между доменами — события (Kafka) и логические ссылки. Для устойчивости обработки применяются идемпотентные консьюмеры, дедупликация и повторная доставка (at-least-once).

### Q4. Как решается проблема “at-least-once” в Kafka, чтобы не было двойной обработки?
**Ответ:** Идемпотентность обеспечивается через:
- **Redis idempotency keys** для команд и событий,
- дедупликацию по ключам (например, correlation_id/call_id),
- управляемые ретраи,
- при необходимости — шаблоны inbox/outbox на уровне сервисов.

### Q5. Почему ABAC/OPA, а не только RBAC?
**Ответ:** RBAC хорош для ролей, но недостаточен для UC-контекста.  
В UC решения часто зависят от **контекста**: кто инициатор, какой ресурс (запись разговора/чат/конференция), какое действие, какова организация/подразделение, режим доступа, время, политика ретеншна. ABAC позволяет описывать эти условия формально и централизованно. OPA даёт воспроизводимость, версионирование политик и возможность аудита “почему разрешено/запрещено”.

### Q6. Как вы обеспечиваете безопасный доступ к записям разговоров и вложениям?
**Ответ:** Записи хранятся в S3, а доступ выдаётся **контролируемо**:
- пользователь запрашивает доступ через API,
- выполняется ABAC-решение (OPA),
- выдаётся **pre-signed URL** на ограниченное время,
- факт выдачи и использование фиксируются в аудите.  
Это исключает прямой “публичный” доступ к бакету и позволяет управлять compliance.

### Q7. Как обеспечивается наблюдаемость и быстрое расследование инцидентов?
**Ответ:** Наблюдаемость задана как обязательный контракт:
- метрики, логи и трейсы собираются централизованно,
- используется корреляция по `trace_id` и `correlation_id`,
- ключевые бизнес-события (call started/ended, message delivered/read) также доступны через event-bus.  
Это позволяет восстанавливать цепочку: клиент → gateway → сервисы → БД/кэш → внешние интеграции.

### Q8. Что является критичным путём и как вы его “укоротили”?
**Ответ:** Критичный путь — инициация/управление вызовом и сигнализация.  
Он сделан предсказуемым за счёт:
- минимального числа синхронных вызовов,
- локальной валидации identity context без постоянного hop-а в IAM,
- вынесения тяжёлых операций (CDR, экспорт, уведомления) в async-контур,
- кэширования (routing cache, sessions cache) и контроля идемпотентности.

### Q9. Как обеспечивается высокая доступность?
**Ответ:** На уровне deployment:
- репликация сервисов (stateless + HPA),
- HA-кластера для PostgreSQL/Redis/Kafka,
- распределение по зонам (multi-zone),
- self-healing Kubernetes,
- изоляция доменов (chat/conferencing/media) снижает blast radius.

### Q10. Почему conferencing и chat разделены на разные сервисы?
**Ответ:** Потому что это разные домены и разные NFR:
- conferencing — высокие требования к jitter/latency и большой RTP-трафик,
- chat — высокая скорость доставки и хранение истории/receipts,
- присутствие (presence) — частые обновления, подписки и fan-out.  
Разделение позволяет по-разному масштабировать, оптимизировать и изолировать деградации.

### Q11. Как будет происходить внедрение без “большого взрыва”?
**Ответ:** Архитектура рассчитана на поэтапный ввод:
1) периметр и IAM,  
2) базовая телефония,  
3) messaging/presence,  
4) conferencing/recording,  
5) интеграции и монетизация.  
На каждом этапе можно интегрировать с существующими системами и мигрировать пользователей постепенно.

### Q12. Если бы у вас было больше времени, что бы вы улучшили в архитектуре?
**Ответ:** Усилил бы:
- формализацию контрактов событий (schema registry + тесты совместимости),
- отдельный контур для policy rollout/rollback и “policy canary”,
- расширенный набор QAS с нагрузочными профилями для media и presence fan-out,
- дополнительные сценарии DR (катастрофоустойчивость) и тестирование failover в автоматическом режиме.