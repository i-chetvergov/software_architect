# 8. Сценарии атрибутов качества

**Проект:** Платформа унифицированных коммуникаций (Unified Communications, UC) для корпоративного использования

---

## Введение

Сценарии атрибутов качества описывают, как система реагирует на различные стимулы в контексте нефункциональных требований. Они формулируются в формате **Stimulus / Response / Measure** и служат основой для оценки выполнения нефункциональных требований и проектирования архитектурных решений.

---

## Обзор сценариев атрибутов качества

| ID | Атрибут качества | Стимул | Связь с NFR | Связь с диаграммами |
|----|------------------|--------|-------------|---------------------|
| **QA-01** | Масштабируемость | Нагрузка до 5 000 одновременных вызовов | NFR-01 | Deployment |
| **QA-02** | Отказоустойчивость | Отказ узла Kubernetes-кластера | NFR-02, NFR-06 | Deployment |
| **QA-03** | Безопасность | Попытка доступа без токена или с неверными правами | NFR-04 | Sequence (UC_Seq_User_Auth_Token) |
| **QA-04** | Наблюдаемость | Анализ инцидента с повышенной задержкой | NFR-05 | Deployment |
| **QA-05** | Производительность | До 1 000 сообщений в минуту | NFR-03 | C4 Containers |
| **QA-06** | Сопровождаемость | Выкатка новой версии Call Control | NFR-07 | Deployment |
| **QA-07** | Безопасность | Попытка перехвата медиапотока | NFR-04 | C4 Containers |
| **QA-08** | Конфиденциальность | Попытка доступа к записям вне зоны ответственности | NFR-09 | C4 Containers |
| **QA-09** | Отказоустойчивость | Сбой основного узла СУБД | NFR-02, NFR-06 | Deployment |
| **QA-10** | Расширяемость | Подключение новой внешней системы | NFR-08 | C4 Context, C4 Containers |

---

## 1. Производительность

### QA-01. Масштабируемость голосовых вызовов

**Стимул:** Нагрузка на платформу возрастает до 5 000 одновременных голосовых вызовов в рабочее время.

**Контекст:** 
- До 5 000 одновременных активных голосовых вызовов
- Пиковая нагрузка в рабочие часы
- Распределение нагрузки по регионам

**Реакция:** 
- Сервисы Call Control, SIP Gateway и Media/Recording автоматически масштабируются за счёт добавления реплик
- Установление вызовов продолжается без деградации
- Время установления вызова остаётся в пределах SLA

**Характеристики (Measure):**
- Время установления вызова (от запроса клиента до ответа) P95 ≤ 3 секунд
- Потери вызовов из-за исчерпания ресурсов ≤ 0.1%
- Автоматическое масштабирование происходит в течение 2–5 минут

**Связь с архитектурой:** Реализуется через горизонтальное масштабирование микросервисов, auto-scaling (HPA), stateless-сервисы (см. диаграмму Deployment, ADR-001, ADR-003)

---

### QA-05. Производительность чата

**Стимул:** Пользователи активно обмениваются сообщениями в рабочих чатах (до 1 000 сообщений в минуту в пределах одного кластера).

**Контекст:**
- До 1 000 сообщений в минуту
- Множественные групповые чаты
- Высокая активность в рабочие часы

**Реакция:**
- Сообщения доставляются без заметных задержек
- История корректно сохраняется в хранилище
- Система обрабатывает нагрузку без деградации

**Характеристики (Measure):**
- 95-й перцентиль времени доставки сообщения ≤ 1 секунды
- Отсутствие потери сообщений
- Пропускная способность ≥ 1 000 сообщений в минуту

**Связь с архитектурой:** Реализуется через Messaging/Chat Service с кэшированием и асинхронной обработкой (см. диаграмму C4 Containers, ADR-003)

---

## 2. Надёжность

### QA-02. Отказоустойчивость при отказе узла кластера

**Стимул:** Один из рабочих узлов Kubernetes-кластера выходит из строя.

**Контекст:**
- Отказ одного узла в кластере
- Активные вызовы и сессии на момент отказа
- Новые запросы продолжают поступать

**Реакция:**
- Поды микросервисов автоматически перезапускаются на других узлах
- Новые сессии устанавливаются без ошибок
- Активные вызовы минимально затронуты (graceful degradation)

**Характеристики (Measure):**
- Время восстановления целевого числа реплик сервисов ≤ 5 минут
- Доля неуспешных операций в момент отказа ≤ 1%
- Отсутствие полной недоступности критичных сервисов

**Связь с архитектурой:** Реализуется через репликацию сервисов, автоматическое восстановление (self-healing), graceful degradation (см. диаграмму Deployment, ADR-005, ADR-006)

---

### QA-09. Восстановление после сбоя хранилища

**Стимул:** Сбой основного узла СУБД, используемой для транзакционных данных UC-платформы.

**Контекст:**
- Отказ основного узла PostgreSQL-кластера
- Активные транзакции на момент сбоя
- Репликация на резервный узел

**Реакция:**
- Включается механизм репликации/фейловера на резервный узел
- Система переводится в рабочий режим
- Транзакции восстанавливаются из реплики

**Характеристики (Measure):**
- Время переключения на резерв ≤ 5 минут
- Потеря подтверждённых транзакций отсутствует или минимальна (в пределах RPO, согласованного с бизнесом)
- RPO (Recovery Point Objective) ≤ 1 минута

**Связь с архитектурой:** Реализуется через HA-кластеры БД с автоматическим фейловером (см. диаграмму Deployment, ADR-006)

---

## 3. Безопасность

### QA-03. Аутентификация и безопасность доступа

**Стимул:** Пользователь пытается получить доступ к UC-сервисам без действительного токена доступа или с токеном, не соответствующим требуемой роли.

**Контекст:**
- Попытка доступа без токена или с невалидным токеном
- Попытка доступа с токеном без необходимых прав/ролей
- Множественные попытки несанкционированного доступа

**Реакция:**
- Доступ отклоняется API Gateway или IAM Service
- Событие фиксируется в журнале аудита
- Событие экспортируется в систему мониторинга/ИБ
- При множественных попытках может быть применена блокировка

**Характеристики (Measure):**
- 100% неавторизованных запросов блокируются
- Запись в аудит создаётся не позднее 1 секунды после события
- Время обнаружения аномальной активности ≤ 5 минут

**Связь с архитектурой:** Реализуется через IAM Service, API Gateway с централизованной аутентификацией, централизованный аудит (см. диаграммы C4 Containers и Sequence UC_Seq_User_Auth_Token, ADR-004)

---

### QA-07. Защита медиаданных

**Стимул:** Внешний злоумышленник пытается перехватить медиапоток голосового вызова в корпоративной сети.

**Контекст:**
- Попытка перехвата медиапотока в сети
- Пассивное прослушивание сетевого трафика
- Попытка расшифровки медиаданных

**Реакция:**
- Медиапотоки зашифрованы (SRTP/DTLS для WebRTC, TLS/SRTP для SIP)
- Попытка расшифровки без ключей невозможна
- События перехвата могут быть обнаружены системой мониторинга

**Характеристики (Measure):**
- Отсутствие незашифрованного медиатрафика на внешних интерфейсах
- Проверка выполняется регулярно автоматизированными тестами и аудитом конфигурации
- 100% медиапотоков защищены шифрованием

**Связь с архитектурой:** Реализуется через шифрование медиапотоков (SRTP/DTLS), защиту сигнализации (TLS), мониторинг безопасности (см. диаграмму C4 Containers, ADR-004)

---

### QA-08. Управление конфиденциальными данными (записи и CDR)

**Стимул:** Оператор контакт-центра пытается получить доступ к записям разговоров вне своей зоны ответственности.

**Контекст:**
- Попытка доступа к записям другого отдела или клиента
- Попытка доступа без необходимых прав
- Множественные попытки несанкционированного доступа

**Реакция:**
- Доступ блокируется политиками RBAC и атрибутной авторизацией
- Попытка фиксируется в журнале безопасности
- Событие экспортируется в систему мониторинга/ИБ

**Характеристики (Measure):**
- 100% несанкционированных попыток доступа блокируются
- Отчёт по попыткам доступен руководству и службе ИБ
- Время обнаружения попытки несанкционированного доступа ≤ 1 секунды

**Связь с архитектурой:** Реализуется через централизованный контроль доступа (IAM Service), политики RBAC, централизованный аудит (см. диаграмму C4 Containers, ADR-004)

---

## 4. Наблюдаемость

### QA-04. Наблюдаемость и трассировка запросов

**Стимул:** Оператор эксплуатации анализирует инцидент с повышенной задержкой установления вызовов.

**Контекст:**
- Повышенная задержка установления вызовов (P95 > 3 секунд)
- Необходимость локализации корневой причины
- Множественные компоненты в цепочке обработки вызова

**Реакция:**
- В системе доступны метрики, логи и распределённые трассировки по единому trace-id
- Позволяет выявить «узкое место» (Call Control, SIP Gateway, Media или сеть)
- Корреляция событий по единому trace-id

**Характеристики (Measure):**
- Среднее время локализации корневой причины инцидента ≤ 30 минут
- Покрытие трассировкой всех критичных сервисов 100%
- Корреляция событий по единому trace-id

**Связь с архитектурой:** Реализуется через Observability Stack (Prometheus, Loki, Tempo/Jaeger), распределённую трассировку (OpenTelemetry), интеграцию с корпоративными системами мониторинга (см. диаграмму Deployment, ADR-006)

---

## 5. Модифицируемость

### QA-06. Обновление без простоя (rolling upgrade)

**Стимул:** Выкатывается новая версия сервиса Call Control.

**Контекст:**
- Новая версия Call Control Service
- Активные вызовы и сессии на момент обновления
- Необходимость обновления без простоя

**Реакция:**
- Обновление происходит по стратегии rolling update
- Новые запросы постепенно переводятся на новую версию
- Активные сессии сохраняются по возможности
- Старая версия остаётся доступной до завершения миграции

**Характеристики (Measure):**
- Доля неуспешных попыток установления вызовов в период обновления ≤ 0.5%
- Отсутствие полной недоступности сервиса
- Время обновления ≤ 15 минут

**Связь с архитектурой:** Реализуется через стратегию rolling update в Kubernetes, версионирование API, graceful shutdown (см. диаграмму Deployment, ADR-005, ADR-006)

---

### QA-10. Расширяемость API для новых интеграций

**Стимул:** Появляется потребность подключить новую внешнюю систему (например, дополнительную CRM) к UC-платформе.

**Контекст:**
- Новая внешняя система требует интеграции
- Необходимость интеграции без изменения базовой архитектуры
- Минимизация влияния на существующие сервисы

**Реакция:**
- Новая интеграция реализуется через существующий API Gateway и событийную шину
- Без изменения базовой архитектуры и критичных сервисов
- Использование стандартизированных протоколов и форматов данных

**Характеристики (Measure):**
- Время реализации типовой интеграции ≤ 4–6 недель
- Отсутствует необходимость остановки существующих сервисов
- Обратная совместимость API сохраняется

**Связь с архитектурой:** Реализуется через API Gateway, событийную шину, стандартизированные протоколы (см. диаграммы C4 Context и C4 Containers, ADR-002, ADR-003)

---

## Связь с последующими разделами

Сценарии атрибутов качества служат основой для:

- **Раздела 9. Архитектурное решение** — обоснования архитектурных решений, направленных на удовлетворение нефункциональных требований
- **ADR** — фиксации конкретных архитектурных решений для каждого атрибута качества
- **Раздела 10. Диаграммы** — визуализации архитектурных решений на диаграммах развёртывания и последовательностей

Трассировка сценариев к решениям обеспечивает прозрачность связи между нефункциональными требованиями, архитектурными решениями и реализацией.
