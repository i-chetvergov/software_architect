# Сценарии атрибутов качества (Quality Attribute Scenarios)

**Проект:** Корпоративная платформа унифицированных коммуникаций  
(**Unified Communications, UC**)

---

## Введение

Настоящий раздел описывает сценарии атрибутов качества (Quality Attribute Scenarios, QAS) —
формализованные проверки того, **как система должна реагировать на стимулы**
в контексте нефункциональных требований (см. раздел **«Требования»**, NFR)
и целевых показателей эксплуатации (SLO/SLA).

Сценарии базируются на:
- нефункциональных требованиях (NFR) -> измеримые целевые показатели качества системы;
- пользовательских сценариях (см. раздел **«Пользовательские сценарии»**, UC) -> критичные пути взаимодействия для валидации качества.

Примечание по терминам:
- **SLO** -> внутренние целевые показатели качества, по которым проектируется и проверяется архитектура;
- **SLA** -> внешние договорные показатели (если применимо), которые обычно опираются на SLO и процессы эксплуатации.

Сценарии формулируются в формате:
- **Stimulus** (стимул) -> событие/условие, которое воздействует на систему;
- **Context** (контекст) -> предпосылки, окружение, режим эксплуатации, ограничения;
- **Response** (реакция) -> ожидаемое поведение системы;
- **Measure** (измерение) -> измеримые критерии приемки (как правило, SLO);
- **Artifacts** (артефакты) -> где проверяем и чем подтверждаем (метрики/логи/трейсы/тесты/дашборды).

QAS обеспечивают трассируемость:
- QAS -> NFR (какое качество проверяем);
- QAS -> UC (в каком пользовательском сценарии это проявляется);
- QAS -> C4/Deployment/Sequence (где именно это обеспечивается архитектурой);
- QAS -> ADL (какие архитектурные решения и компромиссы за этим стоят).

Во всех сценариях применяется принцип сквозной корреляции:
`correlation_id`, `trace_id`, а также доменные идентификаторы `call_id/session_id`, `conference_id`,
`recording_id`, `conversation_id`, `user_id`, `device_id`.

---

## Обзор сценариев атрибутов качества

| ID | Атрибут качества | Стимул | Связь с NFR | Связь с UC | Связь с диаграммами |
|----|------------------|--------|-------------|------------|---------------------|
| **QA-01** | Масштабируемость (Voice) | Рост нагрузки до 5 000 одновременных вызовов | NFR-01, NFR-03 | UC-01, UC-02, UC-09 | Deployment, Sequence (UC_Seq_Outgoing_Call, UC_Seq_Incoming_Call) |
| **QA-02** | Доступность/отказоустойчивость (Compute) | Отказ узла кластера/инстанса сервиса | NFR-02, NFR-06 | UC-01, UC-02, UC-03, UC-04 | Deployment |
| **QA-03** | Безопасность доступа (API) | Запрос без токена/с неверными правами | NFR-04, NFR-09 | UC-07, UC-06, UC-08 | Sequence (UC_Seq_User_Auth_Token), C4 Containers |
| **QA-04** | Наблюдаемость | Расследование инцидента P95 call setup > 3 сек | NFR-05 | UC-01, UC-02 | Deployment, Sequence |
| **QA-05** | Производительность (Chat) | До 1 000 сообщений/мин в кластере | NFR-03, NFR-05 | UC-03 | C4 Containers |
| **QA-06** | Сопровождаемость | Rolling upgrade Call Control без простоя | NFR-07, NFR-10 | UC-01, UC-02, UC-04, UC-09 | Deployment |
| **QA-07** | Безопасность (Media) | Попытка перехвата/подмены медиапотока | NFR-04 | UC-01, UC-02, UC-04 | C4 Containers, Deployment |
| **QA-08** | Конфиденциальность (Recordings/CDR) | Доступ к записи вне зоны ответственности | NFR-09, NFR-04 | UC-08 | C4 Containers, Sequence (UC_Seq_Recording_Access - план) |
| **QA-09** | Отказоустойчивость данных (DB) | Сбой primary узла транзакционной БД | NFR-02, NFR-06, NFR-10 | UC-06, UC-01, UC-02 | Deployment |
| **QA-10** | Расширяемость интеграций | Подключение новой внешней системы | NFR-08, NFR-07 | UC-05 | C4 Context, C4 Containers |
| **QA-11** | Управляемость конфигураций | Ошибочная конфигурация маршрутизации/политик | NFR-10, NFR-05 | UC-06, UC-02 | Deployment, C4 Containers |
| **QA-12** | Мультидевайс-согласованность | Входящий вызов на пользователя с 3 устройствами | NFR-03, NFR-05 | UC-09 | Sequence (UC_Seq_MultiDevice_Incoming - план) |

Примечание: сценарии со статусом «план» соответствуют UC, для которых Sequence-диаграммы будут подготовлены после финализации C4 Containers/Deployment.

---

## QA-01. Масштабируемость голосовых вызовов (Voice)

**Атрибут:** Масштабируемость и производительность real-time операций  
**Связь с NFR:** NFR-01, NFR-03  
**Связь с UC:** UC-01, UC-02, UC-09  
**Связь с архитектурой:** Deployment, Sequence (UC_Seq_Outgoing_Call, UC_Seq_Incoming_Call)

### Стимул
Рост нагрузки до **5 000 одновременных активных голосовых вызовов** в рабочие часы.

### Контекст
- типовой рабочий день, пик активности;
- mixed traffic: исходящие + входящие + очереди;
- разделение control plane и media plane;
- часть трафика WebRTC, часть SIP (SBC/SIP Edge);
- наблюдаемость включена и обязательна для критичных сервисов.

### Реакция
- Call Control, SIP Edge/SBC, WebRTC Gateway и Media/Recording увеличивают пропускную способность за счет горизонтального масштабирования;
- сохранение целевых SLO для установления вызова;
- при нехватке медиа-ресурсов допускается **graceful degradation** по политике (например, отказ от записи или отказ новых сессий с корректным кодом причины), но без потери контроля, финализации сессий и учета событий.

### Характеристики (Measure)
- **Call setup time** (P95) <= **3 сек** для типового контура;
- доля отказов установления из-за исчерпания ресурсов <= **0.1%** за интервал нагрузки;
- autoscaling/масштабирование достигает целевого числа реплик <= **5 минут** (порог и окно масштабирования согласованы эксплуатацией);
- при перегрузке: корректные причины отказа в CDR/событиях (не "unknown").

### Артефакты
- метрики: `call_setup_latency_p95`, `sip_invite_rate`, `media_alloc_failures`, `webrtc_sessions`, `cpu/mem`, `queue_depth`;
- трейсинг: выделение времени по сегментам (API Gateway -> Call Control -> SBC -> Media);
- нагрузочные тесты (voice load profile) + отчет.

---

## QA-02. Отказоустойчивость при отказе узла/инстанса (Compute)

**Атрибут:** Доступность/отказоустойчивость  
**Связь с NFR:** NFR-02, NFR-06  
**Связь с UC:** UC-01, UC-02, UC-03, UC-04  
**Связь с архитектурой:** Deployment

### Стимул
Отказ одного узла кластера или падение инстанса критичного сервиса (например, Call Control replica).

### Контекст
- в системе есть активные сессии и новые запросы;
- сервисы развернуты с репликацией, есть readiness/liveness probes;
- часть операций асинхронная (event bus, CDR pipeline).

### Реакция
- orchestrator перезапускает компоненты на оставшихся узлах;
- новые запросы продолжают обслуживаться;
- активные сессии минимально затронуты: допускается потеря части **не критичных неподтвержденных уведомлений/промежуточных сигналов**, но не допускается потеря финального статуса сессии, учета событий и возникновение "зависших" сессий без финального состояния.

### Характеристики (Measure)
- восстановление целевого числа реплик критичных сервисов <= **5 минут**;
- доля неуспешных операций в момент отказа <= **1%**;
- отсутствие полной недоступности критичного пути (аутентификация, создание вызова, маршрутизация) дольше согласованного окна (например, 60-120 секунд в деградации).

### Артефакты
- алерты availability/error-rate;
- отчет chaos/fault-injection тестирования (node kill / pod kill);
- трассировка сессий по `correlation_id` (нет "висящих" состояний).

---

## QA-03. Безопасность доступа (API Authorization)

**Атрибут:** Безопасность и контроль доступа  
**Связь с NFR:** NFR-04, NFR-09  
**Связь с UC:** UC-07, UC-06, UC-08  
**Связь с архитектурой:** Sequence (UC_Seq_User_Auth_Token), C4 Containers

### Стимул
Запрос к API без токена или с токеном без требуемых ролей/атрибутов (RBAC/ABAC).

### Контекст
- API Gateway является единой точкой входа;
- IAM отвечает за выдачу токенов и проверку прав;
- операции администрирования и доступ к записям требуют усиленной авторизации.

### Реакция
- запрос отклоняется на API Gateway и/или IAM;
- создается событие аудита (security audit) с `user_id` (если известен), `source_ip`, `correlation_id`, `resource`, `action`, `decision`;
- при множественных попытках применяется политика защиты (rate-limit/temporary block), не влияющая на легитимных пользователей.

### Характеристики (Measure)
- 100% неавторизованных запросов блокируются;
- запись аудита создается <= **1 сек** после события;
- обнаружение аномальной активности (по правилам SIEM/алертинга) <= **5 минут**;
- отсутствие утечки чувствительных данных в error responses (никаких деталей про существование ресурса при запрете, где требуется).

### Артефакты
- audit log events + интеграция с SIEM;
- тесты безопасности (negative auth tests) в CI/CD;
- дашборд по отказам авторизации.

---

## QA-04. Наблюдаемость и расследование инцидента (Tracing)

**Атрибут:** Наблюдаемость  
**Связь с NFR:** NFR-05  
**Связь с UC:** UC-01, UC-02  
**Связь с архитектурой:** Deployment, Sequence

### Стимул
Эксплуатация фиксирует рост задержки установления вызовов: `call_setup_latency_p95` > 3 сек.

### Контекст
- цепочка включает API Gateway, Call Control, SBC/SIP Edge, WebRTC Gateway/Media;
- включены метрики, логи, распределенная трассировка (OpenTelemetry);
- в каждом сервисе сохраняются `trace_id` и `correlation_id`.

### Реакция
- инженер эксплуатации находит деградирующий сегмент по trace waterfall (узкое место сервис/сеть/БД/очереди);
- определяет первопричину и применяет стандартную процедуру устранения (масштабирование/rollback/перенастройка/изоляция проблемного узла);
- формируется отчет RCA.

### Характеристики (Measure)
- время локализации корневой причины <= **30 минут**;
- покрытие трассировкой критичных сервисов: **100%** (по целевому списку);
- корреляция событий по `trace_id`/`correlation_id` доступна end-to-end для выбранного вызова.

### Артефакты
- дашборды Prometheus/Grafana, логи Loki/ELK, traces Tempo/Jaeger;
- runbook + шаблон RCA.

---

## QA-05. Производительность чата (Messaging)

**Атрибут:** Производительность и надежность доставки сообщений  
**Связь с NFR:** NFR-03, NFR-05  
**Связь с UC:** UC-03  
**Связь с архитектурой:** C4 Containers

### Стимул
До **1 000 сообщений/мин** в рамках одного кластера, включая групповые чаты.

### Контекст
- клиенты подключены к real-time каналу (push/WebSocket);
- хранение истории в БД сообщений;
- подтверждения доставки/прочтения реализованы по контракту чата.

### Реакция
- сообщения принимаются, сохраняются и доставляются без заметной деградации;
- при кратковременных сбоях доставки обеспечивается повторная доставка (идемпотентность, дедупликация по `message_id`);
- поддерживается синхронизация между устройствами.

### Характеристики (Measure)
- P95 времени доставки <= **1 сек** (в пределах региона/кластера);
- потерь сообщений нет (прием/сохранение гарантировано при успехе ответа API);
- доля дубликатов сообщений <= согласованного порога (например, <= 0.01%) и контролируется механизмом дедупликации;
- устойчивость к кратким сбоям: восстановление real-time канала <= согласованного времени (например, <= 30 сек).

### Артефакты
- метрики `message_delivery_latency_p95`, `message_store_latency`, `ws_connections`, `retries`, `dedup_hits`;
- трассы по `conversation_id`/`message_id`;
- нагрузочный профиль messaging.

---

## QA-06. Rolling upgrade Call Control без простоя

**Атрибут:** Сопровождаемость и управляемость изменений  
**Связь с NFR:** NFR-07, NFR-10  
**Связь с UC:** UC-01, UC-02, UC-04, UC-09  
**Связь с архитектурой:** Deployment

### Стимул
Выкатка новой версии Call Control (rolling update).

### Контекст
- есть активные вызовы и новые запросы;
- сервисы используют health probes;
- контракты API/событий версионируются и совместимы.

### Реакция
- новая версия вводится постепенно, старая версия обслуживает часть трафика до завершения rollout;
- при выявлении деградации выполняется rollback;
- активные сессии завершаются корректно (graceful shutdown) либо минимально затрагиваются согласно выбранной модели сохранения состояния.

### Характеристики (Measure)
- доля неуспешных попыток установления вызовов в период обновления <= **0.5%**;
- отсутствует полная недоступность сервиса;
- время rollout <= **15 минут** (или согласованное окно);
- rollback возможен <= **10 минут** (целевое).

### Артефакты
- deployment logs, progressive delivery отчеты;
- SLO/error budget на период изменения;
- автоматические smoke/regression тесты.

---

## QA-07. Защита медиаданных (SRTP/DTLS, TLS)

**Атрибут:** Безопасность медиаканала  
**Связь с NFR:** NFR-04  
**Связь с UC:** UC-01, UC-02, UC-04  
**Связь с архитектурой:** C4 Containers, Deployment

### Стимул
Попытка перехвата медиапотока или расшифровки RTP/WebRTC traffic в корпоративной сети.

### Контекст
- WebRTC использует DTLS-SRTP;
- SIP домен использует SRTP, сигнализация защищена TLS на внешних границах (SBC/SIP Edge);
- ключи не доступны злоумышленнику.

### Реакция
- медиатрафик на внешних интерфейсах всегда шифрован согласно политике безопасности;
- попытка пассивного перехвата не приводит к раскрытию содержимого;
- конфигурация шифрования контролируется эксплуатационными и security checks.

### Характеристики (Measure)
- 0% незашифрованного медиатрафика на внешних интерфейсах;
- 100% WebRTC media через DTLS-SRTP;
- 100% SIP media через SRTP (где политика требует);
- регулярная проверка конфигурации (автотест/аудит) выполняется по расписанию.

### Артефакты
- security audit report (crypto policies);
- automated config compliance checks;
- тесты на отказ при downgrade шифрования (если требуется).

---

## QA-08. Конфиденциальность записей и CDR (RBAC/ABAC + Audit)

**Атрибут:** Конфиденциальность и соответствие  
**Связь с NFR:** NFR-09, NFR-04  
**Связь с UC:** UC-08  
**Связь с архитектурой:** C4 Containers, Sequence (UC_Seq_Recording_Access - план)

### Стимул
Пользователь пытается получить доступ к записи разговора вне своей зоны ответственности.

### Контекст
- доступ к записям регулируется RBAC/ABAC (роль, подразделение, контекст, время);
- доступ осуществляется через API Gateway и Media/Recording Service;
- audit logging обязателен.

### Реакция
- доступ блокируется на этапе авторизации;
- событие попытки фиксируется в аудите и экспортируется в контур ИБ;
- при необходимости применяется дополнительная политика (например, требование повышенного уровня аутентификации для операций скачивания).

### Характеристики (Measure)
- 100% несанкционированных попыток доступа блокируются;
- аудит создается <= **1 сек**;
- отчет по попыткам доступен ИБ/руководству по фильтрам (период, пользователь, resource);
- отсутствие “data leakage” (метаданные записи выдаются строго в рамках прав).

### Артефакты
- audit log + SIEM;
- тесты на контроль доступа (policy tests) и отчеты.

---

## QA-09. Восстановление после сбоя primary узла БД (Data HA)

**Атрибут:** Доступность и восстановление  
**Связь с NFR:** NFR-02, NFR-06, NFR-10  
**Связь с UC:** UC-06, UC-01, UC-02  
**Связь с архитектурой:** Deployment

### Стимул
Сбой основного узла транзакционной БД (например, PostgreSQL primary).

### Контекст
- есть реплика/standby;
- определены RTO/RPO, согласованные с бизнесом;
- критичные операции должны иметь корректную деградацию.

### Реакция
- выполняется failover на standby;
- сервисы восстанавливают соединения и продолжают обслуживание;
- исключается потеря подтвержденных транзакций за пределами согласованного RPO;
- операции, завязанные на консистентность, при необходимости переводятся в деградированный режим (например, временно ограничиваются админ-операции), но без потери контроля и учета.

### Характеристики (Measure)
- целевое RTO критичных функций платформы <= **15 минут**; RTO/RPO подсистемы БД фиксируются отдельно и не должны ухудшать целевые показатели доступности критичных функций (значения могут уточняться в ADL);
- RPO <= **1 минута** (или согласованное значение);
- отсутствие потери подтвержденных транзакций за пределами RPO;
- восстановление нормального режима без ручного вмешательства или с ограниченным участием оператора (по runbook).

### Артефакты
- отчеты failover тестов;
- метрики replication lag;
- runbook + протокол учений.

---

## QA-10. Расширяемость интеграций (API + Events)

**Атрибут:** Расширяемость и совместимость  
**Связь с NFR:** NFR-08, NFR-07  
**Связь с UC:** UC-05  
**Связь с архитектурой:** C4 Context, C4 Containers

### Стимул
Подключение новой внешней системы (например, новая CRM/Service Desk), требующей click-to-call и логирования.

### Контекст
- есть API Gateway и интеграционный слой (webhooks/event bus);
- действуют требования к обратной совместимости контрактов;
- интеграции требуют корреляции событий (`correlation_id`, `call_id`).

### Реакция
- интеграция подключается без изменения ядра (Call Control/Messaging/Media);
- используются существующие контракты API/Events или добавляются новые версии без "ломающих" изменений;
- обеспечивается идемпотентность webhooks и повторная доставка.

### Характеристики (Measure)
- типовая интеграция реализуется <= **4-6 недель** при наличии тестового контура и документации;
- backward compatibility сохраняется (старые клиенты/интеграции продолжают работать);
- повторная доставка webhooks обеспечивает доставку с заданным SLO (например, 99.9% в 24 часа) и контролируется метриками.

### Артефакты
- API/event contract docs (versioned);
- sandbox для интеграций;
- отчеты по e2e тестам интеграции.

---

## QA-11. Управляемость конфигураций (Safety of Change)

**Атрибут:** Управляемость и снижение рисков изменений  
**Связь с NFR:** NFR-10, NFR-05  
**Связь с UC:** UC-06, UC-02  
**Связь с архитектурой:** Deployment, C4 Containers

### Стимул
Администратор вносит ошибочную конфигурацию (например, правило маршрутизации очереди приводит к циклу или блокирует входящий DID).

### Контекст
- изменения выполняются через Admin UI/Admin API;
- конфигурации версионируются;
- есть pre-flight валидация и возможность rollback.

### Реакция
- система предотвращает применение конфигурации, если валидация выявляет критическую ошибку (невалидные маршруты, конфликт номеров, циклы);
- если ошибка проявилась после применения, выполняется быстрый rollback на предыдущую версию;
- событие фиксируется в аудите и наблюдаемости.

### Характеристики (Measure)
- критические ошибки конфигурации блокируются на этапе валидации (coverage по правилам согласовано);
- rollback выполняется <= **10 минут** (целевое);
- инцидент диагностируется <= **30 минут** благодаря трассировке и событиям конфигурации;
- отсутствует длительная недоступность входящих сценариев из-за конфигурации.

### Артефакты
- audit log изменений конфигурации;
- метрики config rollout/rollback;
- набор policy/validation тестов.

---

## QA-12. Мультидевайс-согласованность (Incoming on 3 devices)

**Атрибут:** Производительность и наблюдаемость сценария мульти-устройств  
**Связь с NFR:** NFR-03, NFR-05  
**Связь с UC:** UC-09  
**Связь с архитектурой:** Sequence (UC_Seq_MultiDevice_Incoming - план)

### Стимул
Входящий вызов адресован пользователю, имеющему 3 активных устройства (Web + Mobile + SIP).

### Контекст
- действует политика параллельного вызова;
- синхронизация состояния обязательна;
- Call Control управляет отменой остальных оповещений при ответе на одном устройстве.

### Реакция
- все устройства получают оповещение;
- при ответе на одном устройстве остальные получают отмену (push cancel/SIP CANCEL);
- состояние вызова синхронизируется, Presence обновляется на "в звонке";
- события доступны end-to-end по `correlation_id` и `call_id`.

### Характеристики (Measure)
- время доставки оповещения на устройства: P95 <= согласованного порога (например, <= 1 сек для push канала);
- отмена остальных устройств после ответа: P95 <= согласованного порога (например, <= 500 мс после accept);
- отсутствие "двойного ответа" (race conditions) в пределах согласованного риска; инциденты фиксируются и наблюдаемы.

### Артефакты
- метрики по fan-out/race conditions;
- трассы по `correlation_id`;
- тесты мультидевайс сценария.

---

## Связь с последующими разделами

Сценарии атрибутов качества являются входом для:
- **Раздела «Архитектурное решение»** (см. раздел **«Решение»**) -> обоснование архитектурных механизмов (масштабирование, HA, security, observability, управляемость);
- **ADL** (см. раздел **«Принятые архитектурные решения (ADL)»**) -> фиксация компромиссов (например, модель сохранения состояния вызова при rollout, политика деградации при дефиците медиа-ресурсов, RTO/RPO);
- **Раздела «Диаграммы»** (см. раздел **«Диаграммы»**) -> конкретизация точек измерения и ответственности в Sequence/Deployment.

Трассируемость обеспечивается через связи:
- QAS -> NFR (какое качество проверяем, см. раздел **«Требования»**);
- QAS -> UC (в каком пользовательском сценарии это проявляется, см. раздел **«Пользовательские сценарии»**);
- QAS -> C4/Sequence/Deployment (где именно это обеспечивается архитектурой, см. раздел **«Диаграммы»**);
- QAS -> ADL (какие архитектурные решения и компромиссы за этим стоят, см. раздел **«Принятые архитектурные решения (ADL)»**).