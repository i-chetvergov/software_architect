# C4 Component Diagram

![C4 Component Diagram](../assets/diagrams/c4_component.svg)

## Назначение диаграммы

Диаграмма **C4 Component** описывает внутреннюю структуру ключевого контейнера UC-платформы — **Call Control Service** — на уровне компонентов, их зон ответственности и взаимодействий.

Диаграмма предназначена для фиксации **реализационной архитектуры** сервиса управления вызовами и показывает:
- как обрабатываются команды управления вызовом;
- каким образом применяется контроль доступа (ABAC/OPA);
- где проходит граница критического real-time контура сигнализации;
- какие части работают синхронно, а какие — асинхронно.

## Основные компоненты Call Control Service

На диаграмме представлены следующие компоненты:

- **Call Control API** — входная точка команд управления вызовом  
  (`create`, `answer`, `hold`, `transfer`, `end`), получает *identity context* от API Gateway.

- **Auth Context Validator** — локальная валидация *identity context*  
  (claims, scopes, tenant) без прямого обращения к IAM в каждом запросе.

- **Policy Client** — клиент ABAC/OPA, формирует запросы в PDP  
  (*subject / resource / action / context*) и интерпретирует результат  
  (*allow / deny + obligations*).

- **Call Orchestrator** — центральный компонент оркестрации, управляющий
  жизненным циклом вызова и координирующий работу всех подсистем.

- **Routing Engine** — вычисление маршрута вызова на основе правил,
  префиксов, политик и fallback-логики.

- **Route Policy Evaluator** — применение policy-обязательств (*obligations*)
  к рассчитанному маршруту  
  (например: запрет направления, принудительный trunk, обязательная запись).

- **Session Manager** — управление активными сессиями вызовов,
  обеспечение идемпотентности и согласованности состояния.

- **Call State Machine (FSM)** — детерминированная модель состояний вызова
  и допустимых переходов между ними.

- **SIP Handler** — обработка SIP-сигнализации и взаимодействие с SBC / SIP Gateway.

- **WebRTC Handler** — обработка сигнализации WebRTC-сессий
  через WebRTC Gateway.

- **Event Publisher** — публикация доменных событий вызова  
  (*started / connected / ended / failed*) в шину событий (Kafka).

- **CDR Collector** — сбор таймингов, маршрута и причин завершения вызова
  для формирования CDR, выполняется асинхронно.

- **Call Repository** — абстракция доступа к данным вызовов, сессий
  и маршрутизации (PostgreSQL).

- **Cache Adapter** — доступ к Redis для хранения «горячих» данных:
  активных сессий, кэша маршрутов, ключей дедупликации.

## Архитектурный смысл и ключевые решения

Диаграмма отражает ряд принципиальных архитектурных решений UC-платформы:

- **Разделение периметра и бизнес-логики**  
  Аутентификация и первичная авторизация выполняются на уровне API Gateway,
  а Call Control Service работает с уже проверенным *identity context*,
  что исключает нагрузку на IAM в runtime-контуре сигнализации.

- **Формализованный контроль доступа (ABAC/OPA)**  
  Все критические действия (инициация вызова, перевод, подключение к конференции)
  проходят проверку через **Policy Decision Point (OPA)**.
  Используются не только решения *allow / deny*, но и *obligations*.

- **Чёткое разделение ответственности компонентов**  
  Оркестрация (Call Orchestrator) отделена от вычисления маршрута (Routing Engine).  
  Управление состояниями и идемпотентность вынесены в Session Manager и FSM.  
  Протокольная логика изолирована в SIP/WebRTC Handler.

- **Асинхронная обработка CDR и событий**  
  Сбор CDR и публикация доменных событий выполняются асинхронно через Kafka
  и не блокируют критический путь обработки вызова.

- **Оптимизация latency-критичного контура**  
  Использование Redis для кэша маршрутов и активных сессий
  снижает количество обращений к PostgreSQL и повышает устойчивость под нагрузкой.

## Связь с архитектурными драйверами и ADR

Диаграмма поддерживает следующие архитектурные драйверы:

- **AD-01** — масштабируемость и отказоустойчивость real-time сервисов;
- **AD-02** — минимизация задержек в контуре сигнализации;
- **AD-03** — формализованный и расширяемый контроль доступа.

А также реализует архитектурные решения, зафиксированные в:

- **ADR-001** — разделение периметра и core-сервисов;
- **ADR-002** — использование event-driven архитектуры (Kafka);
- **ADR-005** — внедрение ABAC/OPA как централизованного механизма авторизации.