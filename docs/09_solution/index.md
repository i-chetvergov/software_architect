# Архитектурное решение

**Проект:** Корпоративная платформа унифицированных коммуникаций  
(**Unified Communications, UC**) для корпоративного использования

---

## Введение

Настоящий раздел описывает целевую микросервисную архитектуру UC-платформы и объясняет,
**какими архитектурными механизмами** обеспечивается выполнение ранее зафиксированных:

- **бизнес-целей и ограничений** (см. разделы **«Бизнес-цели»** и **«Ограничения»**);
- **архитектурных драйверов** (см. раздел **«Архитектурные драйверы»**) — ключевых факторов проектирования;
- **функциональных требований (FR)** и **нефункциональных требований (NFR)** (см. раздел **«Требования»**);
- **сценариев атрибутов качества (QAS)** (см. раздел **«Атрибуты качества»**) — формализованных проверок качества системы;
- **пользовательских сценариев (UC)** (см. раздел **«Пользовательские сценарии»**) — критичных путей взаимодействия с платформой.

Архитектурные решения и компромиссы фиксируются через **ADL (Architecture Decision Records)**
(см. раздел **«Принятые архитектурные решения (ADL)»**).

Данный раздел является «сквозным мостом» между требованиями и последующими диаграммами
(см. раздел **«Диаграммы»** — C4/Deployment/Sequence), а также задаёт **границы ответственности доменов**
и **контрактные принципы интеграции**.

---

## Архитектурные допущения и границы ответственности

### Организационный и эксплуатационный контур

- **Масштаб использования:** платформа предназначена для средних и крупных заказчиков (ориентир: 1–50 тыс. активных пользователей) с ростом нагрузки во времени.
- **Мульти-арендность (tenant isolation):** архитектура допускает логическую изоляцию клиентов (tenant_id) на уровне IAM, политик доступа, конфигураций и данных.
- **Среда развёртывания:** базовый вариант ориентирован на Kubernetes-кластер (on-premise и/или private/public cloud), с поддержкой требований эксплуатации по наблюдаемости и управляемости.
- **Итерационность поставки:** функциональные домены вводятся поэтапно (голос, очереди/группы, чат, конференции, запись, интеграции, администрирование), без нарушения контрактов для уже введённых возможностей.

### Функциональные границы платформы (домены и сервисы)

В архитектурное решение входят следующие домены и ключевые компоненты (на уровне C4 Containers):

| Домен | Компоненты/микросервисы | Назначение и ответственность |
|------|--------------------------|-----------------------------|
| **Периметр** | API Gateway | Единая точка входа для внешних клиентов и интеграций: аутентификация, авторизация, rate-limit, маршрутизация, политики безопасности, версионирование API |
| **Identity & Access** | IAM / Identity Service | Интеграция с корпоративным IdP (OIDC/SAML), выдача/валидация токенов, RBAC/ABAC, управление сессиями, аудит безопасности |
| **Call Signaling** | Call Control Service | Оркестрация вызовов и сессий: создание/изменение состояния вызова, маршрутизация, управление очередями/группами, мультидевайс, публикация доменных событий |
| **SIP Edge** | SIP Gateway / SBC (логическая роль) | Терминация/проксирование SIP-транков, защита периметра сигнализации, topology hiding, политики безопасности, маршрутизация на внешний/внутренний SIP-домен |
| **WebRTC Edge** | WebRTC Gateway (логическая роль) | Терминация WebRTC-сессий и согласование медиа-параметров (DTLS-SRTP), интеграция WebRTC-клиентов с контуром вызовов |
| **Media & Recording** | Media / Recording Service | Управление медиаканалом (RTP/SRTP/WebRTC media), подключение/разрыв медиа, запись разговоров/конференций, метаданные записей |
| **Presence & Realtime** | Presence Service | Статусы пользователей/устройств (в сети, занят, в звонке, в конференции), мультидевайс-согласованность, fan-out уведомлений |
| **Messaging** | Messaging / Chat Service | 1:1 и групповые чаты: доставка, история, синхронизация устройств, подтверждения доставки/прочтения, дедупликация |
| **Accounting** | Billing / CDR Service | Формирование и хранение CDR/статистики, отчётность, экспорт в внешние системы по контракту |
| **Platform Ops** | Provisioning / Admin Service | Управление пользователями, номерами, политиками, маршрутами, конфигурациями, версиями конфигурации и откатами |
| **Notifications** | Notification Service | Отправка уведомлений (push/email/системные), интеграционные уведомления, шаблоны сообщений |
| **Observability** | Observability Stack | Метрики/логи/трейсы, трассировка (OpenTelemetry), дашборды и алерты, интеграция с корпоративным мониторингом/SIEM |

Примечание: названия отражают **логические роли**. Конкретные продукты (например, конкретный SBC/Media Server/IdP) выбираются отдельными ADL и технологическими решениями.

### Связь с разработанными пользовательскими сценариями (UC)

Архитектура покрывает критичные UC из ранее подготовленного раздела **«Пользовательские сценарии»**:
- **UC-01** Исходящий голосовой вызов (WebRTC -> SIP/PSTN) — покрывается доменами API Gateway, Call Control, WebRTC Gateway, SIP Edge, Media
- **UC-02** Входящий вызов с маршрутизацией по очереди/группе — покрывается доменами SIP Edge, Call Control, Presence, Media
- **UC-03** Чат между сотрудниками (доставка/история/синхронизация устройств) — покрывается доменами Messaging, Presence, API Gateway
- **UC-04** Видеоконференция (AV + чат + запись) — покрывается доменами Call Control, Media/Recording, Messaging, Presence
- **UC-05** Интеграция с CRM (click-to-call + логирование) — покрывается доменами API Gateway, Call Control, Billing/CDR, Event Bus
- **UC-06** Provisioning (пользователи/номера/политики/маршрутизация) — покрывается доменами Provisioning, IAM, Call Control
- **UC-07** Аутентификация пользователя и получение токена (SSO) — покрывается доменами API Gateway, IAM
- **UC-08** Доступ к записи разговора с контролем прав и аудитом — покрывается доменами Media/Recording, IAM, Object Storage, Audit
- **UC-09** Мультидевайс (параллельный вызов/синхронизация состояния) — покрывается доменами Call Control, Presence, SIP Edge

### Нефункциональные критерии (NFR) и измеримость

Архитектурное решение ориентировано на выполнение NFR и проверяется через QAS:

| Критерий | Целевой показатель | Трассируемость |
|----------|---------------------|----------------|
| **Доступность** | SLA/SLO уровня платформы 99.9% при отказе одного узла/инстанса | NFR-02, NFR-06, QAS QA-02 |
| **Масштабируемость** | Горизонтальное масштабирование и эластичность до 50 000 пользователей | NFR-01, QAS QA-01 |
| **Производительность** | Call setup time P95 <= 3 сек; чат P95 доставка <= 1 сек (внутри региона/кластера) | NFR-03, QAS QA-01/QA-05 |
| **Безопасность** | OAuth2.1/OIDC, SAML 2.0, TLS/mTLS, SRTP/DTLS-SRTP; централизованный аудит | NFR-04, NFR-09, QAS QA-03/QA-07/QA-08 |
| **Восстановление** | Восстановление реплик сервисов <= 5 минут; сценарии отказа БД с RTO/RPO по ADL | NFR-06, NFR-10, QAS QA-02/QA-09 |
| **Наблюдаемость** | End-to-end трассировка, метрики и логи для критичных цепочек | NFR-05, QAS QA-04 |
| **Сопровождаемость/управляемость** | Rolling upgrade/rollback, версионирование конфигураций, безопасные изменения | NFR-07, NFR-10, QAS QA-06/QA-11 |

---

## Технические ограничения и стандарты

Архитектура реализует совместимость с отраслевыми протоколами и практиками:

| Категория | Стандарты/подходы | Комментарий |
|-----------|-------------------|-------------|
| Сигнализация | SIP | Интеграция с операторами, SBC роль на периметре |
| Web-клиент | WebRTC (DTLS-SRTP) | Реализация UC-01/UC-04, безопасный медиа-контур |
| Медиа | RTP/SRTP, запись | Управление медиа и запись через Media/Recording Service |
| Аутентификация | OAuth2.1/OIDC, SAML 2.0 | SSO, интеграция с корпоративным IdP |
| API | REST и/или gRPC | Выбор протоколов фиксируется ADL в зависимости от домена (см. ADR-002) |
| События | Kafka и/или RabbitMQ | Event-driven интеграции и доменные события |
| Хранилища | PostgreSQL (OLTP), Redis (кэш), Object Storage (записи), time-series/columnar (аналитика) | Выбор по типам данных и профилям нагрузки |
| Инфраструктура | Kubernetes, Docker | Базовый контур развёртывания и эксплуатации |

---

## Архитектурные принципы

### 1. Микросервисная архитектура и доменное разбиение

**Принцип:** система разделена на домены и независимые сервисы с чёткими границами ответственности.

**Обоснование:**
- независимое масштабирование и развёртывание доменов;
- снижение связности и локализация изменений;
- поэтапное внедрение функционала без «большого взрыва».

**Реализация:**
- домены: Периметр, IAM, Call Signaling, SIP/WebRTC Edge, Media, Presence, Messaging, Billing/CDR, Provisioning;
- **Database per Service** (изоляция данных) + согласование через события/контракты;
- технологические решения, влияющие на границы доменов, фиксируются ADL (см. ADR-001).

**Трассируемость:** UC-01..UC-09, QAS QA-01..QA-12, C4 Containers/Deployment, ADL (архитектура и границы доменов).

---

### 2. Разделение control plane и media plane

**Принцип:** сигнализация и медиаканал разделены по компонентам, масштабируются и развиваются независимо.

**Обоснование:**
- критичность задержек и устойчивости сигнализации (UC-01/UC-02/UC-09);
- медиа и запись требуют отдельных ресурсов, политики деградации и безопасности (UC-01/UC-04/UC-08);
- соответствие QAS по производительности и безопасности (QA-01, QA-07, QA-08).

**Реализация:**
- Call Control управляет состоянием вызова (control plane), но не обязан быть медиашлюзом;
- Media/Recording выполняет медиа-функции и записи (media plane);
- SBC/WebRTC Gateway реализуют «edge»-роль на границе домена.

---

### 3. Event-driven взаимодействие между доменами

**Принцип:** домены обмениваются событиями асинхронно, чтобы снизить связность и выдерживать пики нагрузки.

**Обоснование:**
- снижение каскадных зависимостей и изоляция отказов;
- интеграции и учёт (CDR) не должны блокировать критичный путь вызова;
- требования наблюдаемости и трассировки через корреляцию событий.

**Реализация:**
- брокер сообщений для доменных событий (например: CallStarted, CallAnswered, CallEnded, RecordingReady, MessageSent);
- идемпотентные consumer’ы и дедупликация по `event_id`/`message_id`;
- управление схемами событий (версионирование, совместимость).

**Трассируемость:** UC-01/UC-02/UC-03/UC-05, QAS QA-04/QA-10, C4 Containers/Deployment.

---

### 4. Real-time критичный путь без лишних синхронных зависимостей

**Принцип:** критичные операции (установление вызова, fan-out оповещений) не должны зависеть от «тяжёлых» внешних подсистем синхронно.

**Обоснование:**
- NFR по задержке установления вызова (P95 <= 3 сек);
- QAS QA-01 и QA-04 (производительность и расследуемость).

**Реализация:**
- API Gateway и Call Control формируют минимальный синхронный путь для call setup;
- Billing/CDR, интеграции и аналитика выполняются асинхронно (с гарантией учёта);
- Presence используется как источник статусов/регистраций, но взаимодействие строится так, чтобы деградация Presence не «роняла» критичный путь полностью (graceful degradation).

---

### 5. Горизонтальное масштабирование и stateless подход

**Принцип:** сервисы масштабируются горизонтально и минимизируют локальное состояние.

**Обоснование:**
- масштабирование до 50 000 пользователей и пики по вызовам/сообщениям;
- управляемость и rolling upgrade без простоя.

**Реализация:**
- stateless сервисы, состояние хранится в внешних хранилищах (DB/Redis) и/или восстанавливается из событий;
- HPA (autoscaling) по метрикам нагрузки;
- отдельные политики масштабирования для control plane и media plane.

**Трассируемость:** QAS QA-01/QA-06, Deployment.

---

### 6. Отказоустойчивость и graceful degradation

**Принцип:** отказ одного узла/инстанса не должен приводить к полной недоступности ключевых сценариев.

**Обоснование:**
- SLA 99.9% и требования NFR-02/NFR-06;
- QAS QA-02 и QA-09.

**Реализация:**
- репликация критичных сервисов минимум в 2 экземплярах;
- self-healing в Kubernetes (liveness/readiness, rescheduling);
- HA для OLTP (PostgreSQL primary/standby) и план восстановления RTO/RPO фиксируется ADL (см. ADR-003, ADR-006);
- деградация по политике: например, временный отказ от записи/необязательных операций, но сохранение учёта и финализации сессий.

---

### 7. Безопасность по умолчанию (Zero Trust внутри контура)

**Принцип:** безопасность встроена во все уровни архитектуры, включая межсервисные взаимодействия и доступ к чувствительным данным.

**Обоснование:**
- NFR-04 и NFR-09;
- QAS QA-03/QA-07/QA-08.

**Реализация:**
- IAM и централизованные политики RBAC/ABAC;
- mTLS для service-to-service (в зависимости от инфраструктурного решения: service mesh/ingress);
- TLS на периметре; защита медиаканала SRTP/DTLS-SRTP;
- централизованный аудит доступа к записям/данным CDR и административным операциям.

---

### 8. Наблюдаемость как обязательный архитектурный контракт

**Принцип:** каждый сервис обязан публиковать метрики/логи/трейсы и поддерживать корреляцию по идентификаторам.

**Обоснование:**
- NFR-05;
- QAS QA-04 (расследование инцидентов).

**Реализация:**
- OpenTelemetry instrumentation;
- единые идентификаторы: `trace_id`, `correlation_id`, `call_id/session_id`, `conversation_id`, `recording_id`, `user_id`, `device_id`;
- дашборды SLO и алерты по критичным цепочкам (UC-01/UC-02/UC-03).

---

## Архитектурные паттерны и их применение

### API Gateway Pattern

**Назначение:** единая точка входа для клиентов и интеграций.

**Реализация:**
- аутентификация и авторизация через IAM;
- rate limiting, WAF-политики (при необходимости), маршрутизация;
- версионирование API и контрактная дисциплина.

**Трассируемость:** UC-01/UC-03/UC-05/UC-06/UC-07/UC-08, QAS QA-03.

---

### Database per Service Pattern

**Назначение:** изоляция данных и независимое развитие сервисов.

**Реализация:**
- отдельные хранилища на домен (например: accounts, calls, messaging, cdr);
- согласование междоменной согласованности через события и контрактные API.

**Трассируемость:** UC-06, QAS QA-11, ADL по границам данных (см. ADR-003).

---

### CQRS и событийность (частично, там где оправдано)

**Назначение:** разделить нагрузку чтения и записи для доменов с интенсивной аналитикой/поиском и обеспечить асинхронную согласованность.

**Реализация:**
- события как источник для построения read-моделей (например, для отчётности/дашбордов);
- идемпотентность обработчиков, дедупликация.

**Трассируемость:** UC-05, UC-08, QAS QA-04/QA-10.

---

### Circuit Breaker / Timeouts / Bulkheads

**Назначение:** защита от каскадных отказов и удержание критичного пути работоспособным.

**Реализация:**
- таймауты и circuit breaker для внешних зависимостей и межсервисных вызовов;
- изоляция пулов ресурсов (bulkheads) для критичных операций;
- fallback и graceful degradation по политике.

**Трассируемость:** QAS QA-02, QA-06.

---

## Технологический стек (целевой, с возможностью уточнения ADL)

Технологический стек выбирается на основе архитектурных принципов и требований (NFR, QAS).
Конкретные технологические решения и обоснования фиксируются в ADL (см. раздел **«Принятые архитектурные решения (ADL)»**).

| Категория | Технологии/подходы | Назначение |
|-----------|---------------------|------------|
| Контейнеризация | Docker, Kubernetes | стандартный контур развёртывания и масштабирования |
| Service-to-service security | mTLS (возможно через service mesh) | Zero Trust внутри кластера |
| Протоколы сигнализации | SIP, WebRTC (DTLS-SRTP) | голос/видео, совместимость с телеком-инфраструктурой |
| API | REST и/или gRPC | управление и взаимодействие между сервисами |
| События | Kafka и/или RabbitMQ | асинхронные события доменов и интеграции |
| OLTP | PostgreSQL | транзакционные данные доменов |
| Кэш/сессии | Redis | ускорение чтения, временные данные, rate-limit/locks |
| Объектное хранилище | S3-compatible / on-prem object storage | хранение записей и больших артефактов |
| Observability | Prometheus, Grafana, Loki, Tempo/Jaeger, OpenTelemetry | метрики/логи/трейсы и SLO |

---

## Границы ответственности архитектурного решения

### Входит в архитектурное решение

- целевая логическая и физическая архитектура (декомпозиция по доменам и роли компонентов);
- контракты взаимодействия между компонентами (API и события на концептуальном уровне);
- механизмы обеспечения NFR (HA, security, scalability, observability, manageability);
- принципы конфигурационного управления и безопасных изменений (versioning/rollback);
- точки измерения SLO и корреляции событий (идентификаторы и обязательная телеметрия).

### Не входит в архитектурное решение

- детальная проработка схем данных конкретных вендоров CRM/ERP/Service Desk (рассматривается на уровне интерфейсов и контрактов);
- выбор конкретных проприетарных продуктов (конкретный SBC, конкретный media server, конкретный SIEM) без оформления ADL и технологического решения;
- регламенты ITIL/ITSM как отдельные документы (в рамках архитектуры фиксируются только требования к событиям, аудитам, интеграциям и наблюдаемости).

---

## Связь с последующими разделами

Архитектурное решение детализируется в:

- **Разделе «Диаграммы»** (см. раздел **«Диаграммы»**) -> C4 Context, C4 Containers, Deployment и Sequence для UC-01..UC-09;
- **ADL** (см. раздел **«Принятые архитектурные решения (ADL)»**) -> фиксация ключевых решений и компромиссов (с указанием причин, альтернатив и последствий);
- **Диаграммах последовательности** (см. раздел **«Диаграммы / Sequence»**) -> детализация критичных цепочек с обязательной корреляцией `trace_id`/`correlation_id` и доменных идентификаторов.

Трассируемость обеспечивается через связи:

- Требования (FR/NFR, см. раздел **«Требования»**) -> UC (см. раздел **«Пользовательские сценарии»**) -> QAS (см. раздел **«Атрибуты качества»**) -> Архитектурные механизмы -> Диаграммы (см. раздел **«Диаграммы»**) -> ADL (см. раздел **«Принятые архитектурные решения (ADL)»**).