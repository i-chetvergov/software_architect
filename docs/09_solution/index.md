# 9. Архитектурное решение

**Проект:** Платформа унифицированных коммуникаций (Unified Communications, UC) для корпоративного использования

---

## Введение

Архитектурное решение для платформы унифицированных коммуникаций (Unified Communications, UC) описывает целевую микросервисную архитектуру, предназначенную для корпоративного использования, с учётом требований по безопасности, масштабируемости, наблюдаемости и интеграции с внешними системами.

Решение основано на анализе бизнес-целей, архитектурных драйверов, ограничений и требований, описанных в предыдущих разделах, и фиксируется в виде ADR (Architecture Decision Records).

---

## Архитектурные допущения и границы ответственности

### Организационный контур

- **Масштаб использования:** Платформа UC предназначена для использования средними и крупными корпоративными заказчиками (1–50 тыс. активных пользователей).
- **Среда развёртывания:** Эксплуатация платформы может осуществляться как в облачной среде (private/public cloud), так и в дата-центре заказчика; базовый вариант архитектуры ориентирован на развёртывание в Kubernetes-кластере.
- **Поэтапная реализация:** Проект реализуется итерационно, с поэтапным вводом функциональных доменов (голос, чат, конференции, запись, интеграции).

### Функциональный охват платформы

В архитектурное решение входят следующие домены и микросервисы:

| Домен | Микросервисы | Назначение |
|-------|--------------|------------|
| **Периметр** | API Gateway, IAM / Identity Service | Единая точка входа, аутентификация, авторизация |
| **Сигнализация** | Call Control Service, SIP Gateway / SBC, WebRTC Gateway | Управление вызовами, интеграция с PSTN, WebRTC-сигнализация |
| **Медиа** | Media / Recording Service | Обработка медиапотоков, запись разговоров |
| **Presence и Messaging** | Presence Service, Messaging / Chat Service | Управление статусами, обмен сообщениями |
| **Монетизация и биллинг** | Billing / CDR Service | Сбор CDR, биллинг, отчётность |
| **Платформа** | Provisioning Service, Notification Service, Observability Stack | Управление пользователями, уведомления, мониторинг |

**Интеграции:** Интеграция с корпоративными системами (AD/LDAP, HR, CRM, ERP, Service Desk) рассматривается на уровне высокоуровневых интерфейсов и протоколов, без детальной проработки схем данных конкретных вендоров.

### Нефункциональные критерии

| Критерий | Значение | Обоснование |
|----------|---------|-------------|
| **Доступность** | SLA 99.9% при отказе одного узла | Требование BG-04, NFR-02 |
| **Масштабируемость** | Горизонтальное масштабирование до 50 000 пользователей | Требование NFR-01, AD-01 |
| **Безопасность** | OAuth2.1/OIDC, mTLS, TLS | Требование NFR-04, AD-03 |
| **Производительность** | Время установления вызова ≤ 3 сек (P95) | Требование NFR-03 |
| **Восстановление** | Время восстановления ≤ 5 минут | Требование NFR-06, AD-02 |

### Технические ограничения и стандарты

| Категория | Стандарты и технологии | Обоснование |
|-----------|------------------------|-------------|
| **Сигнализация** | SIP, WebRTC (SRTP/DTLS) | Требование TC-01, совместимость с существующими системами |
| **Аутентификация** | OAuth2.1/OIDC, SAML 2.0 | Требование NFR-04, TC-03 |
| **API** | REST, gRPC | Требование TC-01, AD-04 |
| **События** | Kafka / RabbitMQ | Требование TC-01, AD-04, AD-06 |
| **Хранилища** | PostgreSQL (OLTP), Time-series/Columnar, Object Storage | Требование BC-04, оптимизация под типы данных |
| **Инфраструктура** | Kubernetes, Docker | Требование TC-02 |

---

## Архитектурные принципы

### 1. Микросервисная архитектура

**Принцип:** Система разбита на независимые микросервисы с чёткими границами доменов.

**Обоснование:**
- Независимое развёртывание и масштабирование доменов (AD-01, AD-06)
- Изоляция отказов и минимизация каскадных изменений (AD-02, AD-06)
- Возможность поэтапной реализации (BC-01)

**Реализация:**
- Разделение по доменам: Периметр, Сигнализация, Медиа, Presence и Messaging, Монетизация, Платформа
- Независимые микросервисы с собственными БД (Database per Service)
- Слабая связность через события и API

**Связь с ADR:** ADR-001 (Микросервисная архитектура)  
**Связь с диаграммами:** C4 Containers, Deployment

---

### 2. Event-driven коммуникации

**Принцип:** Асинхронный обмен событиями через брокер сообщений для слабой связности между доменами.

**Обоснование:**
- Слабая связность и масштабируемость (AD-01, AD-04)
- Возможность независимого развития доменов (AD-06)
- Сглаживание пиков нагрузки (AD-01)

**Реализация:**
- Событийная шина (Kafka/RabbitMQ) для асинхронных событий
- Идемпотентные обработчики событий
- Schema Registry для управления схемами событий

**Связь с ADR:** ADR-003 (Event-driven коммуникации)  
**Связь с диаграммами:** C4 Containers, Deployment

---

### 3. Real-time обработка

**Принцип:** Выделенный контур для критичных real-time операций (сигнализация вызовов) с жёсткими требованиями к задержкам.

**Обоснование:**
- Требования к производительности (NFR-03: время установления вызова ≤ 3 сек)
- Критичность задержек для коммуникаций (AD-01)
- Необходимость изоляции критичных путей

**Реализация:**
- WebTransport для низколатентной сигнализации вызовов
- Выделенный контур Call Control → SIP Gateway / WebRTC Gateway
- Минимизация синхронных зависимостей в критичном пути

**Связь с ADR:** ADR-003 (Real-time архитектура)  
**Связь с диаграммами:** C4 Containers, Sequence

---

### 4. Горизонтальное масштабирование

**Принцип:** Все микросервисы масштабируются горизонтально через добавление реплик.

**Обоснование:**
- Требования к масштабируемости (NFR-01: до 50 000 пользователей)
- Эластичность при пиковых нагрузках (AD-01)
- Оптимизация стоимости владения (AD-07)

**Реализация:**
- Stateless-сервисы с внешним хранилищем состояния
- Автоматическое масштабирование (HPA) на основе метрик нагрузки
- Горизонтальное масштабирование через Kubernetes

**Связь с ADR:** ADR-001, ADR-003  
**Связь с диаграммами:** Deployment

---

### 5. Отказоустойчивость и высокая доступность

**Принцип:** Система выдерживает отказ отдельных компонентов без потери доступности критичных сервисов.

**Обоснование:**
- Требования к доступности (NFR-02: SLA 99.9%)
- Требования к отказоустойчивости (NFR-06: отказ одного узла без потери доступности)
- Критичность коммуникаций для бизнеса (BG-04)

**Реализация:**
- Репликация критичных сервисов (минимум 2 реплики)
- HA-кластеры для баз данных (PostgreSQL с репликацией)
- Автоматическое восстановление (self-healing) через Kubernetes
- Graceful degradation при частичных отказах

**Связь с ADR:** ADR-005, ADR-006  
**Связь с диаграммами:** Deployment

---

### 6. Безопасность по умолчанию

**Принцип:** Безопасность встроена в архитектуру на всех уровнях.

**Обоснование:**
- Требования к безопасности (NFR-04)
- Соответствие регуляторным требованиям (BG-05, BC-04)
- Защита чувствительных данных (CDR, записи)

**Реализация:**
- IAM Service с интеграцией корпоративных IdP (OIDC/SAML)
- API Gateway с централизованной аутентификацией и авторизацией
- mTLS для внутрисервисного взаимодействия
- Шифрование медиапотоков (SRTP/DTLS для WebRTC)
- Централизованный аудит и логирование безопасности

**Связь с ADR:** ADR-004  
**Связь с диаграммами:** C4 Context, C4 Containers, Sequence

---

### 7. Наблюдаемость

**Принцип:** Все сервисы генерируют метрики, логи и трассировки для полной прозрачности системы.

**Обоснование:**
- Требования к наблюдаемости (NFR-05)
- Быстрое обнаружение и устранение инцидентов (BG-08, AD-05)
- Интеграция с корпоративными системами мониторинга (TC-04)

**Реализация:**
- Observability Stack (Prometheus, Loki, Tempo/Jaeger)
- Распределённая трассировка (OpenTelemetry)
- Интеграция с корпоративными SIEM
- Централизованные дашборды (Grafana)

**Связь с ADR:** ADR-006  
**Связь с диаграммами:** Deployment

---

## Архитектурные паттерны

### API Gateway Pattern

**Назначение:** Единая точка входа для всех внешних запросов.

**Реализация:**
- API Gateway для маршрутизации, аутентификации, авторизации, rate limiting
- Версионирование API для обратной совместимости
- Агрегация ответов от нескольких микросервисов

**Связь с ADR:** ADR-002  
**Связь с диаграммами:** C4 Context, C4 Containers

---

### Database per Service Pattern

**Назначение:** Каждый микросервис имеет собственную БД для изоляции данных.

**Реализация:**
- Разделение БД по доменам: DB_ACCOUNTS, DB_CALLS, DB_CDR, DB_MESSAGING
- Независимое развитие схем данных
- Согласованность данных через события

**Связь с ADR:** ADR-001  
**Связь с диаграммами:** C4 Containers, Deployment

---

### Event Sourcing и CQRS (частично)

**Назначение:** Использование событий для согласованности данных между доменами.

**Реализация:**
- События для асинхронной обработки (CallStarted, CallEnded, MessageSent)
- Идемпотентные обработчики событий
- Разделение команд и запросов где необходимо

**Связь с ADR:** ADR-003  
**Связь с диаграммами:** C4 Containers

---

### Circuit Breaker Pattern

**Назначение:** Защита от каскадных отказов при недоступности зависимостей.

**Реализация:**
- Circuit breaker в API Gateway и между микросервисами
- Graceful degradation при частичных отказах
- Fallback-механизмы для некритичных операций

**Связь с ADR:** ADR-005  
**Связь с диаграммами:** C4 Containers

---

## Технологический стек

| Категория | Технологии | Обоснование |
|-----------|------------|-------------|
| **Контейнеризация** | Docker, Kubernetes | Требование TC-02, стандарт индустрии |
| **Языки программирования** | Go, Java, Python (по выбору домена) | Производительность, экосистема |
| **Протоколы сигнализации** | SIP, WebRTC (SRTP/DTLS) | Требование TC-01, стандарты индустрии |
| **Аутентификация** | OAuth2.1/OIDC, SAML 2.0 | Требование NFR-04, TC-03 |
| **API** | REST, gRPC | Требование TC-01, производительность |
| **События** | Kafka / RabbitMQ | Требование TC-01, масштабируемость |
| **БД** | PostgreSQL, Redis, Time-series DB, Object Storage | Оптимизация под типы данных |
| **Мониторинг** | Prometheus, Loki, Tempo/Jaeger, Grafana | Требование NFR-05, TC-04 |

---

## Границы ответственности архитектурного решения

### Входит в архитектурное решение

- Целевая логическая и физическая архитектура
- Принципы разбиения на микросервисы
- Интерфейсы взаимодействия между компонентами
- Требования к инфраструктуре и развёртыванию
- Стратегии безопасности, масштабирования и отказоустойчивости

### Не входит в архитектурное решение

- Операционные процессы (ITIL/ITSM, процессы эксплуатации, регламенты NOC/Service Desk) — формализуются только через требования к интерфейсам и событиям
- Выбор конкретных продуктов и проприетарных решений (SBC, медиашлюзы) — оформляется отдельными технологическими решениями и ADR
- Детальная проработка схем данных конкретных вендоров CRM/ERP — рассматривается на уровне высокоуровневых интерфейсов

---

## Связь с последующими разделами

Архитектурное решение детализируется в:

- **Разделе 10. Диаграммы** — визуализация архитектуры на C4 Context, C4 Containers, Deployment и Sequence диаграммах
- **ADR** — фиксация конкретных архитектурных решений с обоснованием и последствиями
- **ADL** — описание архитектурных соглашений и шаблонов

Трассировка решений к требованиям, драйверам и целям обеспечивает прозрачность связи между бизнес-целями, архитектурными решениями и реализацией.
