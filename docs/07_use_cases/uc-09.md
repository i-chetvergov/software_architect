# UC-09. Управление несколькими устройствами (параллельный вызов/синхронизация состояния)

**Проект:** Корпоративная платформа унифицированных коммуникаций  
(**Unified Communications, UC**)

---

![UC-09. Управление несколькими устройствами](../assets/diagrams/uc-09.svg)

## Описание

**Акторы:** Пользователь, несколько UC-клиентов/SIP-устройств, Call Control Service, Presence Service, API Gateway, SIP Gateway / SBC, Observability Stack.

**Цель:** Обеспечить предсказуемое поведение при наличии нескольких устройств пользователя: оповещение, ответ на одном устройстве, синхронизация состояния вызова и Presence между устройствами.

**Предусловия:**
- пользователь зарегистрирован на нескольких устройствах (Web/Mobile/Desktop/SIP);
- политика «несколько устройств» определена (параллельный/последовательный вызов, лимиты регистраций);
- устройства подключены к сигнальному каналу (push/WebSocket или SIP-регистрация).

**Триггер:** входящий вызов адресован пользователю.

## Основной поток (вариант «параллельный вызов»)

1. Входящий вызов поступает через SIP Gateway / SBC (PSTN/SIP) или создаётся внутри домена.
2. Call Control получает список активных устройств/регистраций пользователя и проверяет политику оповещения.
3. Call Control инициирует оповещение устройств:
   - push/WebSocket для Web/Mobile/Desktop клиентов;
   - SIP INVITE для SIP-устройств через SIP Gateway / SBC;
   - присваивает `call_id`, `session_id`, `correlation_id` и связывает их с `user_id` и `device_id`.
4. Одно из устройств принимает вызов; подтверждение поступает в Call Control (через API Gateway или SIP-ответ).
5. Call Control отменяет оповещение остальных устройств (push-команда отмены и/или SIP CANCEL) и синхронизирует финальные состояния.
6. Presence Service обновляет статус пользователя до «в звонке» и синхронизирует статус со всеми активными устройствами.
7. Call Control публикует события состояния (answered/hold/ended) в поток наблюдаемости с едиными идентификаторами корреляции.
8. После завершения Presence Service обновляет статус пользователя до актуального и синхронизирует со всеми устройствами.

## Альтернативные потоки

- **Последовательный вызов:** устройства оповещаются последовательно с таймаутом; статистика попыток фиксируется в CDR.
- **Превышен лимит регистраций:** применяется политика ограничения (отклонение новой регистрации или вытеснение старой); событие фиксируется в аудите.
- **Ошибка синхронизации состояния:** Call Control повторяет команды синхронизации; ошибки фиксируются в наблюдаемости.

## Постусловия

- вызов принят на одном устройстве, остальные получили отмену оповещения;
- состояние вызова синхронизировано между устройствами;
- Presence обновлён и синхронизирован;
- наблюдаемость содержит корреляцию событий по `correlation_id`.

---

## Связь с требованиями

**Функциональные требования:** [FR-12](../06_requirements/index.md#fr-12-интероперабельность-клиентов-и-устройств), [FR-05](../06_requirements/index.md#fr-05-presence-и-статусы-пользователей), [FR-02](../06_requirements/index.md#fr-02-голосовая-связь-и-телефония), [FR-15](../06_requirements/index.md#fr-15-контракты-событий-и-идентификаторы-корреляции)  
**Нефункциональные требования:** [NFR-03](../06_requirements/index.md#nfr-03-производительность), [NFR-05](../06_requirements/index.md#nfr-05-наблюдаемость)

---

## Связь с диаграммами

- **Use Case диаграмма:** [**UC-01. Use Cases корпоративного пользователя**](../11_use_case_diagrams/usecase_uc-01.md)  
- **Архитектурные диаграммы:** [**C4 Context**](../10_diagrams/c4_context.md), [**C4 Containers**](../10_diagrams/c4_containers.md), [**Deployment**](../10_diagrams/deployment.md), [**Database**](../10_diagrams/database_diagram.md), [**NoSQL Database**](../10_diagrams/nosql_database.md)

---

← [К списку Use Cases](index.md)