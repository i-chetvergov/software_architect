# UC-03. Чат между сотрудниками (доставка, история, синхронизация устройств)

**Проект:** Корпоративная платформа унифицированных коммуникаций  
(**Unified Communications, UC**)

---

## Описание

**Акторы:** Пользователь A, Пользователь B, UC-клиенты (Web/Mobile/Desktop), API Gateway, IAM Service, Messaging/Chat Service, Presence Service, Observability Stack.

**Цель:** Обеспечить обмен сообщениями 1:1 с сохранением истории, поиском и корректной синхронизацией между устройствами, с учётом прав доступа и политик хранения.

**Предусловия:**
- пользователи аутентифицированы (валидные access token);
- для обоих пользователей доступны политики чатов (разрешения, ограничения по вложениям);
- включена синхронизация истории между устройствами;
- клиенты подключены к сигнальному каналу (WebSocket/push через API Gateway).

**Триггер:** Пользователь A отправляет сообщение Пользователю B.

## Основной поток

1. Пользователь A открывает диалог с Пользователем B; клиент запрашивает историю сообщений (с учётом прав доступа).
2. Пользователь A отправляет сообщение; клиент передаёт запрос в API Gateway с access token.
3. API Gateway валидирует токен через IAM Service и применяет политики безопасности (rate limit; tenant isolation — при наличии мульти-тенантности).
4. Messaging Service:
   - проверяет права и применяет политики (например, запрет типов вложений, ограничения по размеру);
   - сохраняет сообщение и присваивает `conversation_id`, `message_id`, `correlation_id` (см. FR-15);
   - публикует событие нового сообщения для получателя (real-time через push/WebSocket).
5. Клиент Пользователя B получает событие; подтверждает доставку (delivery ack) — если выбран протокол подтверждений.
6. Статусы доставки/прочтения (delivery/read receipts) синхронизируются на устройствах пользователей через Messaging Service (как часть доменной логики чата).
7. Presence Service обновляет статусы доступности (online/busy/away/offline) независимо от статусов доставки сообщений и предоставляет их клиентам (при необходимости — для UI).

## Альтернативные потоки

- **Получатель offline:** событие ставится в очередь доставки; сообщение доступно при следующем подключении; клиент синхронизирует историю при восстановлении соединения.
- **Ограничение политики хранения:** при истечении retention сообщение удаляется/архивируется согласно политике (см. NFR-09); факт удаления фиксируется в аудите при необходимости.
- **Перегрузка сервиса:** при недоступности Messaging Service клиент ставит сообщение в локальную очередь и повторяет отправку с экспоненциальной задержкой; события перегрузки фиксируются для наблюдаемости.

## Постусловия

- история сообщений согласована между устройствами обоих пользователей;
- наблюдаемость содержит `conversation_id` и `correlation_id` для диагностики задержек/ошибок;
- события сообщения доступны для интеграций (при включённой политике) по контракту FR-06.

---

## Связь с требованиями

**Функциональные требования:** FR-04, FR-05, FR-12, FR-13, FR-15  
**Нефункциональные требования:** NFR-03, NFR-05, NFR-09

---

## Связь с диаграммами

Sequence: **UC_Seq_Chat_1to1** (план)

---

← [К списку Use Cases](index.md#обзор-пользовательских-сценариев)