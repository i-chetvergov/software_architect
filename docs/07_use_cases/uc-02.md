# UC-02. Входящий вызов с маршрутизацией по очереди/группе

**Проект:** Корпоративная платформа унифицированных коммуникаций  
(**Unified Communications, UC**)

---

![UC-02. Входящий вызов с маршрутизацией](../assets/diagrams/uc-02.svg)

## Описание

**Акторы:** Внешний пользователь, PSTN/SIP-транк, SIP Gateway / SBC, Call Control Service, Presence Service, UC-клиенты операторов, API Gateway, Media / Recording Service, Billing / CDR Service, Observability Stack.

**Цель:** Обработать входящий вызов на номер компании и маршрутизировать его в очередь/группу операторов с учётом правил, статусов и таймаутов, формируя CDR и (при необходимости) запись.

**Предусловия:**
- входящий DID/номер/URI известен и связан с маршрутом (очередь/группа/правило);
- операторы имеют активные сессии (зарегистрированы) и их статусы доступны;
- определены правила распределения (ring-all, round-robin, longest idle, skills-based — по политике).

**Триггер:** поступление SIP INVITE на внешней границе (SIP Gateway / SBC).

## Основной поток

1. SIP Gateway / SBC принимает SIP INVITE от оператора/транка и применяет политику безопасности (ACL, rate limit, topology hiding).
2. SBC передаёт сигнализацию в Call Control Service (внутренний интерфейс/шина).
3. Call Control:
   - нормализует адрес назначения, сопоставляет входящий номер с маршрутом;
   - создаёт сессию вызова и назначает `call_id` и `correlation_id`.
4. Call Control запрашивает у Presence Service кандидатов для обработки вызова (учёт статусов, расписаний, ограничений).
5. Call Control применяет алгоритм распределения и инициирует оповещение операторов:
   - отправляет уведомления через сигнальный канал (push/WebSocket) и/или инициирует вызовы на устройства операторов (в зависимости от выбранной модели).
6. Первый ответивший оператор принимает вызов; Call Control прекращает оповещение остальных (синхронизация состояния).
7. Media/Recording Service подключается к медиаканалу согласно политике (включая запись).
8. После завершения разговора Call Control формирует CDR и события очереди (время ожидания, количество попыток, причина завершения), отправляет в Billing / CDR Service.

## Альтернативные потоки

- **Нет доступных операторов:** вызов переходит в состояние ожидания (очередь) с политикой: удержание/музыка/сообщение; либо — на резервный маршрут (другая группа/голосовая почта/дежурный).
- **Таймаут ответа:** Call Control завершает попытку и переходит к следующему кандидату по правилам очереди; фиксируется статистика попыток.
- **Отказ/занято:** кандидат исключается на текущую попытку; учитывается Presence и результат предыдущих попыток.
- **Сбой медиаканала:** фиксируется причина; возможна деградация (например, без записи) при сохранении минимально работоспособного соединения — если предусмотрено политикой.

## Постусловия

- CDR и статистика очереди сохранены;
- при включённой записи запись и метаданные доступны и связаны с `call_id`;
- наблюдаемость содержит корреляцию по `correlation_id` для всей цепочки: SIP Gateway / SBC -> Call Control -> операторские клиенты -> Media / Recording Service -> CDR.

---

## Связь с требованиями

**Функциональные требования:** FR-02, FR-05, FR-07, FR-08, FR-11, FR-12, FR-13, FR-15  
**Нефункциональные требования:** NFR-02, NFR-03, NFR-06

---

## Связь с диаграммами

Sequence: **UC_Seq_Incoming_Call**

---

← [К списку Use Cases](index.md)