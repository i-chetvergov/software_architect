# 7. Пользовательские сценарии (Use Cases)

**Проект:** Платформа унифицированных коммуникаций (Unified Communications, UC) для корпоративного использования

---

## Введение

Пользовательские сценарии описывают типичные способы взаимодействия пользователей и внешних систем с UC-платформой. Они детализируют функциональные требования и служат основой для проектирования архитектуры и разработки диаграмм последовательностей.

---

## Обзор пользовательских сценариев

| ID | Сценарий | Акторы | Связь с требованиями | Диаграмма последовательности |
|----|----------|--------|----------------------|----------------------------|
| **UC-01** | Исходящий голосовой вызов из веб-клиента | Пользователь, UC WebRTC-клиент, Call Control, SIP Gateway/SBC, PSTN | FR-02, NFR-01, NFR-02, NFR-03 | UC_Seq_Outgoing_Call |
| **UC-02** | Входящий вызов с маршрутизацией по очереди | Внешний абонент, PSTN/SIP-транк, SBC, Call Control, Presence, операторы очереди | FR-02, FR-05, NFR-01, NFR-02 | UC_Seq_Incoming_Call |
| **UC-03** | Чат между сотрудниками с историей сообщений | Два сотрудника, UC-клиенты, Messaging/Chat сервис | FR-04, NFR-03, NFR-05 | — |
| **UC-04** | Создание и проведение видеоконференции | Инициатор, участники, UC-клиенты, Call Control, Media/Recording, Presence | FR-03, FR-07, NFR-01, NFR-02 | — |
| **UC-05** | Интеграция с CRM: клик-ту-колл и логирование | Оператор контакт-центра, CRM, UC-платформа, Call Control, Billing/CDR | FR-06, FR-08, NFR-04 | — |
| **UC-06** | Управление пользователями и номерами (Provisioning) | Администратор UC, Provisioning сервис, IAM, Billing/CDR | FR-01, FR-10, NFR-04 | — |
| **UC-07** | Аутентификация пользователя и получение токена | Пользователь, UC Web-клиент, API Gateway, IAM Service, IdP | FR-01, NFR-04, NFR-09 | UC_Seq_User_Auth_Token |

---

## UC-01. Исходящий голосовой вызов из веб-клиента

### Описание

**Акторы:** Пользователь UC (сотрудник), UC WebRTC-клиент, API Gateway, IAM Service, Call Control Service, WebRTC Gateway, SIP Gateway/SBC, Media/Recording Service, PSTN/внешний абонент, Billing/CDR Service

**Цель:** Пользователь инициирует голосовой вызов внешнему или внутреннему абоненту из веб-клиента.

**Предусловия:**
- Пользователь аутентифицирован в UC-платформе
- Веб-клиент загружен и зарегистрирован в системе
- Пользователь имеет права на совершение исходящих вызовов

**Основной поток:**
1. Пользователь набирает номер или выбирает контакт из адресной книги и нажимает «Позвонить».
2. Клиент отправляет запрос на создание вызова через API Gateway с access token.
3. API Gateway валидирует токен через IAM Service.
4. Call Control Service проверяет права пользователя, применяет правила маршрутизации и создаёт сессию вызова.
5. Call Control Service запрашивает создание WebRTC-сессии через WebRTC Gateway.
6. WebRTC Gateway резервирует медиа-ресурсы в Media/Recording Service (при необходимости включает запись).
7. Call Control Service инициирует SIP-сессию через SIP Gateway/SBC к целевому абоненту.
8. SIP Gateway/SBC устанавливает соединение с PSTN/внешним абонентом.
9. После установления соединения медиапоток устанавливается между клиентом и медиасервером/абонентом через WebRTC Gateway.
10. По завершении разговора Call Control Service формирует CDR и отправляет событие в Billing/CDR Service (асинхронно).

**Альтернативные потоки:**
- **A1:** Целевой абонент недоступен — вызов завершается с соответствующим сообщением.
- **A2:** Пользователь не имеет прав на совершение вызовов — доступ отклоняется.
- **A3:** Недостаточно ресурсов для установления вызова — возвращается ошибка перегрузки.

**Постусловия:**
- CDR-запись создана и сохранена в Billing/CDR Service.
- При необходимости запись разговора сохранена в Object Storage.
- Статистика вызова обновлена в системе аналитики.

**Связь с требованиями:** FR-02, NFR-01, NFR-02, NFR-03  
**Связь с диаграммами:** Sequence UC_Seq_Outgoing_Call (см. раздел `10. Диаграммы`)

---

## UC-02. Входящий вызов с маршрутизацией по очереди

### Описание

**Акторы:** Внешний абонент, PSTN/SIP-транк, Operator SBC, SIP Gateway/SBC, Call Control Service, Presence Service, UC-клиенты операторов, API Gateway, Media/Recording Service, Billing/CDR Service

**Цель:** Обработать входящий вызов на номер компании и маршрутизировать его в очередь контакт-центра или на группу операторов.

**Предусловия:**
- Входящий номер зарегистрирован в системе
- Настроены очереди и группы операторов
- Операторы зарегистрированы и доступны

**Основной поток:**
1. Внешний абонент звонит на номер компании через PSTN.
2. Operator SBC получает SIP INVITE и передаёт его в SIP Gateway/SBC UC-платформы.
3. SIP Gateway/SBC нормализует сигнализацию и передаёт запрос в Call Control Service.
4. Call Control Service определяет маршрутизацию вызова (очередь, группа операторов) и запрашивает список доступных операторов у Presence Service.
5. Presence Service возвращает список доступных операторов для очереди.
6. Call Control Service уведомляет доступных операторов через API Gateway (push/WebSocket).
7. Оператор принимает вызов через UC-клиент.
8. Call Control Service устанавливает SIP-сессию с внешним абонентом через SIP Gateway/SBC.
9. Media/Recording Service начинает запись разговора (при необходимости).
10. После завершения разговора Call Control Service формирует CDR и отправляет событие в Billing/CDR Service (асинхронно).

**Альтернативные потоки:**
- **A1:** Нет доступных операторов — вызов переходит в очередь ожидания или на голосовую почту.
- **A2:** Оператор не отвечает в течение таймаута — вызов перенаправляется следующему оператору.

**Постусловия:**
- CDR-запись создана и сохранена.
- Запись разговора сохранена (при необходимости).
- Статистика очереди обновлена.

**Связь с требованиями:** FR-02, FR-05, NFR-01, NFR-02  
**Связь с диаграммами:** Sequence UC_Seq_Incoming_Call (см. раздел `10. Диаграммы`)

---

## UC-03. Чат между сотрудниками с историей сообщений

### Описание

**Акторы:** Два сотрудника, UC-клиенты, Messaging/Chat Service, Presence Service

**Цель:** Обеспечить обмен сообщениями между сотрудниками с сохранением истории и возможностью поиска.

**Основной поток:**
1. Пользователь A выбирает пользователя B в клиенте и открывает чат.
2. Клиент отправляет сообщение в Messaging/Chat Service через API Gateway.
3. Messaging/Chat Service сохраняет сообщение в БД и доставляет его пользователю B (если онлайн) или сохраняет для доставки.
4. При доставке сообщения обновляется статус presence пользователя B (если необходимо).
5. История сообщений доступна обоим пользователям с различных устройств.

**Связь с требованиями:** FR-04, NFR-03, NFR-05

---

## UC-04. Создание и проведение видеоконференции

### Описание

**Акторы:** Инициатор конференции, участники, UC-клиенты, Call Control Service, Media/Recording Service, Presence Service

**Цель:** Организовать многопользовательскую аудио-/видеоконференцию с возможностью записи и чата конференции.

**Основной поток:**
1. Инициатор создаёт конференцию через UC-клиент.
2. Call Control Service создаёт сессию конференции и резервирует медиа-ресурсы в Media/Recording Service.
3. Инициатор приглашает участников (через ссылку или приглашения).
4. Участники присоединяются к конференции через UC-клиенты.
5. Media/Recording Service обрабатывает медиапотоки всех участников и обеспечивает микширование.
6. При необходимости включается запись конференции.
7. Участники могут использовать совместный экран и чат конференции.
8. После завершения конференции формируется CDR и сохраняется запись (при необходимости).

**Связь с требованиями:** FR-03, FR-07, NFR-01, NFR-02

---

## UC-05. Интеграция с CRM: клик-ту-колл и логирование взаимодействий

### Описание

**Акторы:** Оператор контакт-центра, CRM, UC-платформа, API Gateway, Call Control Service, Billing/CDR Service

**Цель:** Обеспечить возможность совершать вызов из карточки клиента в CRM и автоматически логировать результат общения.

**Основной поток:**
1. Оператор открывает карточку клиента в CRM.
2. CRM отображает кнопку «Позвонить» с номером клиента.
3. При нажатии кнопки CRM отправляет запрос в UC-платформу через API Gateway (клик-ту-колл).
4. UC-платформа инициирует вызов через Call Control Service.
5. После завершения вызова Call Control Service отправляет событие в Billing/CDR Service.
6. Billing/CDR Service экспортирует CDR в CRM через Webhook.
7. CRM обновляет карточку клиента с информацией о звонке.

**Связь с требованиями:** FR-06, FR-08, NFR-04

---

## UC-06. Управление пользователями и номерами (Provisioning)

### Описание

**Акторы:** Администратор UC, Provisioning Service, IAM Service, Call Control Service, Billing/CDR Service

**Цель:** Создание, изменение и деактивация пользователей, назначение номеров и тарифов через административный интерфейс или API.

**Основной поток:**
1. Администратор создаёт нового пользователя через административный интерфейс или API.
2. Provisioning Service создаёт запись пользователя в IAM Service.
3. Provisioning Service назначает номер и настраивает маршрутизацию в Call Control Service.
4. Provisioning Service настраивает тарифы и биллинг-параметры в Billing/CDR Service.
5. Пользователь получает уведомление о создании учётной записи и инструкции по использованию.

**Связь с требованиями:** FR-01, FR-10, NFR-04

---

## UC-07. Аутентификация пользователя и получение токена

### Описание

**Акторы:** Пользователь, UC Web-клиент, API Gateway, IAM Service, Identity Provider / IdP

**Цель:** Пользователь аутентифицируется в UC-платформе и получает access token для доступа к сервисам.

**Основной поток:**
1. Пользователь открывает UC Web-клиент.
2. Клиент запрашивает аутентификацию через API Gateway.
3. API Gateway перенаправляет запрос в IAM Service.
4. IAM Service инициирует OIDC-поток и перенаправляет пользователя в IdP.
5. Пользователь вводит учётные данные в IdP (логин/пароль, MFA при необходимости).
6. IdP возвращает authorization code в IAM Service.
7. IAM Service обменивает code на токены (ID Token, Access Token, Refresh Token) у IdP.
8. IAM Service возвращает токены в API Gateway.
9. API Gateway устанавливает сессию и возвращает токены клиенту (SPA storage / cookie).
10. Клиент использует access token для последующих запросов к API.

**Связь с требованиями:** FR-01, NFR-04, NFR-09  
**Связь с диаграммами:** Sequence UC_Seq_User_Auth_Token (см. раздел `10. Диаграммы`)

---

## Связь с последующими разделами

Указанные сценарии детализируются в виде диаграмм последовательностей (см. раздел `10. Диаграммы`) и связаны с атрибутами качества в разделе `8. Сценарии атрибутов качества`. Они служат основой для:

- **Раздела 8. Сценарии атрибутов качества** — формулирования сценариев для оценки выполнения нефункциональных требований в контексте пользовательских сценариев
- **Раздела 9. Архитектурное решение** — обоснования архитектурных решений, направленных на реализацию пользовательских сценариев
- **Раздела 10. Диаграммы** — создания диаграмм последовательностей для визуализации взаимодействий в пользовательских сценариях

Трассировка сценариев к требованиям и решениям обеспечивает прозрачность связи между пользовательскими потребностями, функциональными требованиями и архитектурной реализацией.
