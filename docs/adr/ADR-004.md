### ADR-004. IAM/OIDC, сервисные токены и mTLS между сервисами

- **Статус**: Принято

#### Контекст

UC-платформа должна обеспечивать безопасный доступ пользователей и сервисов, соответствуя требованиям безопасности и регуляторики (драйвер **AD-03**). Необходимо выбрать подход к аутентификации/авторизации и защите трафика между микросервисами и внешними клиентами.

#### Решение

- Для **пользовательской аутентификации**:
  - Используется протокол **OAuth2.1/OIDC** с внешним или корпоративным IdP.
  - `IAM Service` интегрируется с IdP и управляет сессиями/токенами в UC-платформе.
  - UC-клиенты (web, мобильные) получают `access token` и `refresh token` для доступа к API (`UC_Seq_User_Auth_Token` в `sequences.puml`).
- Для **сервисной аутентификации**:
  - Межсервисные вызовы защищены **mTLS**; каждый сервис имеет собственный X.509-сертификат, управляемый централизованным PKI/secret management.
  - Дополнительно используются **service tokens** (JWT) с ограниченными scope/roles для авторизации на уровне приложений.
- Для **авторизации**:
  - Применяется модель **RBAC** с возможностью расширения до ABAC для чувствительных доменов (CDR, записи).
  - Проверка токенов и прав выполняется на уровне `API Gateway` и целевых сервисов (defence-in-depth).

Связь с артефактами:

- Архитектурные драйверы: **AD-02**, **AD-03**, **AD-04**, **AD-05**.
- Диаграммы: `c4_context.puml`, `c4_containers.puml`, `sequences.puml` (сценарий аутентификации).
- Разделы решения: `09_solution/index.md` (подсистема безопасности).

#### Альтернативы

- Использование только базовой аутентификации/сессий без OIDC.
  - Плюсы: простота.
  - Минусы: отсутствие стандартизированного SSO, сложность интеграции с внешними системами.
- Отказ от mTLS в пользу только сетевых ACL.
  - Плюсы: меньшие накладные расходы.
  - Минусы: более высокий риск компрометации трафика и сервисов внутри кластера.

#### Последствия

- Положительные:
  - Стандартизованный подход к SSO и интеграциям через OIDC.
  - Повышенный уровень защиты внутреннего трафика и сервисных взаимодействий.
  - Ясная модель авторизации по ролям и атрибутам.
- Отрицательные:
  - Усложнение конфигурации (управление сертификатами, токенами, политиками).
  - Повышенные требования к интеграции с корпоративными IdP и PKI.

