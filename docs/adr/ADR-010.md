### ADR-010. Стратегия данных CDR/Recording/Retention

- **Статус**: Принято

#### Контекст

UC-платформа генерирует большие объёмы данных: CDR (Call Detail Records) для всех сеансов связи, записи разговоров и конференций, логи аудита. Необходимо определить стратегию хранения, управления доступом и retention (хранение и удаление) этих данных с учётом требований регуляторов (BC-04), безопасности (NFR-09) и оптимизации стоимости (AD-07).

Требования к биллингу (FR-08), записи разговоров (FR-07), конфиденциальности (NFR-09) и регуляторным требованиям (BC-04) требуют надёжной стратегии управления данными с политиками retention и контроля доступа.

#### Решение

- **CDR (Call Detail Records):**
  - **Хранение:** Специализированная БД (PostgreSQL или колоночная БД) оптимизированная под аналитические запросы
  - **Структура данных:** CDR содержит метаданные вызова (инициатор, получатель, время начала/окончания, длительность, код результата, маршрутизация)
  - **Сбор данных:** Асинхронный сбор CDR через события (CallStarted, CallEnded) от Call Control Service
  - **Retention policy:** CDR хранятся минимум 7 лет (требования регуляторов), с возможностью архивации старых записей в холодное хранилище
  - **Доступ:** Контролируется через RBAC, доступ только для авторизованных пользователей и систем (Billing, Analytics, Compliance)

- **Записи разговоров (Recordings):**
  - **Хранение:** Object Storage (S3-совместимое) для медиафайлов записей
  - **Метаданные:** Хранятся в БД (связь с CDR), включая путь к файлу, размер, формат, дату создания
  - **Форматы:** Стандартные аудио/видео форматы (WAV, MP3, MP4) с возможностью конвертации
  - **Retention policy:** Записи хранятся согласно политике организации (обычно 1–3 года), с автоматическим удалением по истечении срока
  - **Доступ:** Строгий контроль доступа через RBAC и атрибутную авторизацию, аудит всех попыток доступа
  - **Шифрование:** Записи шифруются при хранении (encryption at rest)

- **Логи аудита:**
  - **Хранение:** Централизованное хранилище логов (Loki/ELK) с экспортом в SIEM
  - **Retention policy:** Логи хранятся минимум 1 год, критичные логи безопасности — 7 лет
  - **Доступ:** Доступ только для службы ИБ и аудита, все попытки доступа логируются

- **Архивация и удаление:**
  - **Автоматическая архивация:** Старые CDR (старше 1 года) архивируются в холодное хранилище (S3 Glacier, архивные БД)
  - **Автоматическое удаление:** Записи и логи удаляются автоматически по истечении retention period
  - **Аудит удаления:** Все операции удаления логируются и аудируются
  - **Восстановление:** Возможность восстановления удалённых данных из архивов (в пределах retention period)

- **Интеграция с внешними системами:**
  - **Экспорт CDR:** REST API и batch-экспорт для биллинга и аналитики
  - **Экспорт в SIEM:** Автоматический экспорт логов безопасности в корпоративный SIEM
  - **Compliance reporting:** Автоматическая генерация отчётов для соответствия регуляторным требованиям

Диаграмма `deployment.puml` отражает размещение CDR DB, Object Storage и интеграцию с системами архивации.

Связь с артефактами:

- Архитектурные драйверы: **AD-02**, **AD-03**, **AD-05**, **AD-07**.
- Диаграммы: `c4_containers.puml` (Billing/CDR Service, Media/Recording Service), `deployment.puml` (CDR DB, Object Storage).
- Разделы решения: `09_solution/index.md` (стратегия данных), `06_requirements/index.md` (FR-07, FR-08, NFR-09), `05_constraints/index.md` (BC-04), `08_quality_scenarios/index.md` (QA-08).

#### Альтернативы

- **Хранение всех данных в единой БД:**
  - Плюсы: упрощённое администрирование.
  - Минусы: неоптимальная производительность для разных типов данных, сложность масштабирования, высокие затраты на хранение.

- **Отсутствие автоматической архивации:**
  - Плюсы: проще реализация.
  - Минусы: высокие затраты на хранение, сложность поиска в больших объёмах данных.

- **Хранение записей в БД (BLOB):**
  - Плюсы: проще управление.
  - Минусы: неэффективное использование БД, сложность масштабирования, высокие затраты.

#### Последствия

- Положительные:
  - Оптимизация хранения под типы данных снижает затраты и улучшает производительность.
  - Автоматическая архивация и удаление обеспечивают соответствие регуляторным требованиям и снижают затраты.
  - Строгий контроль доступа и аудит обеспечивают безопасность чувствительных данных.
  - Интеграция с внешними системами упрощает биллинг и compliance reporting.
- Отрицательные:
  - Усложнение архитектуры данных (несколько типов хранилищ).
  - Необходимость управления политиками retention и архивации.
  - Высокие затраты на хранение больших объёмов записей (особенно видео).
  - Сложность восстановления данных из архивов при необходимости.
