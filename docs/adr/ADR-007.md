- **Статус**: Принято

#### Контекст

UC-платформа должна предоставлять единую точку входа для всех внешних клиентов (веб-клиенты, мобильные приложения, интеграции с CRM/ERP) и обеспечивать централизованную аутентификацию, авторизацию, rate limiting и версионирование API. Необходимо определить подход к API Gateway и стратегию версионирования API с учётом драйверов **AD-01**, **AD-03**, **AD-04**, **AD-06**, **AD-07**.

Требования к интеграции с внешними системами (FR-06) и необходимость независимого развития доменов (AD-06) требуют гибкой стратегии версионирования API, позволяющей эволюционировать интерфейсы без нарушения обратной совместимости.

#### Решение

- **API Gateway как единая точка входа:**
  - Все внешние запросы к UC-платформе проходят через `API Gateway`, который выполняет:
    - Маршрутизацию запросов к соответствующим микросервисам
    - Централизованную аутентификацию и авторизацию (валидация токенов через IAM Service)
    - Rate limiting и защиту от DDoS
    - Трансформацию протоколов (REST, gRPC, WebSocket)
    - Агрегацию ответов от нескольких микросервисов
    - Логирование и метрики всех запросов

- **Стратегия версионирования API:**
  - Используется подход **URL-based versioning** для REST API: `/api/v1/`, `/api/v2/`
  - Для gRPC используется **package versioning** в proto-файлах
  - Поддержка **одновременно нескольких версий API** для обеспечения обратной совместимости
  - **Deprecation policy:** устаревшие версии API поддерживаются минимум 12 месяцев с предупреждениями в документации и заголовках ответов
  - **Breaking changes** допускаются только в major версиях (v1 → v2)

- **Управление версиями:**
  - Версионирование контролируется на уровне API Gateway через конфигурацию маршрутов
  - Документация API (OpenAPI/Swagger) версионируется вместе с API
  - Автоматические тесты для проверки обратной совместимости

Диаграммы `c4_context.puml` и `c4_containers.puml` отражают API Gateway как единую точку входа для всех внешних клиентов.

Связь с артефактами:

- Архитектурные драйверы: **AD-01**, **AD-03**, **AD-04**, **AD-06**, **AD-07**.
- Диаграммы: `c4_context.puml`, `c4_containers.puml`, `deployment.puml`.
- Разделы решения: `09_solution/index.md` (API Gateway Pattern), `06_requirements/index.md` (FR-06, NFR-08).

#### Альтернативы

- **Отсутствие API Gateway, прямое обращение к микросервисам:**
  - Плюсы: меньше компонентов, потенциально ниже задержка.
  - Минусы: отсутствие централизованной безопасности, сложность управления версиями, необходимость реализации аутентификации в каждом сервисе.

- **Header-based versioning** (версия в HTTP-заголовке):
  - Плюсы: чище URL.
  - Минусы: сложнее кэширование, менее явное для клиентов.

- **Semantic versioning без поддержки нескольких версий:**
  - Плюсы: проще управление.
  - Минусы: breaking changes требуют синхронного обновления всех клиентов, что недопустимо для корпоративных интеграций.

#### Последствия

- Положительные:
  - Единая точка входа упрощает управление безопасностью и мониторингом.
  - Стратегия версионирования обеспечивает независимое развитие доменов без нарушения обратной совместимости.
  - Централизованный rate limiting защищает от перегрузок и атак.
  - Упрощение интеграций с внешними системами через единый API.
- Отрицательные:
  - API Gateway становится единой точкой отказа (требуется HA-конфигурация).
  - Дополнительная задержка на маршрутизацию и валидацию (обычно < 10 мс).
  - Необходимость управления конфигурацией маршрутов и версиями API.
  - Риск превращения API Gateway в «God Object» при неправильном использовании.
