### ADR-008. Управление конфигурацией и секретами

- **Статус**: Принято

#### Контекст

UC-платформа состоит из множества микросервисов, каждый из которых требует конфигурации (URL сервисов, параметры подключения к БД, feature flags) и секретов (пароли БД, API-ключи, сертификаты). Необходимо определить подход к управлению конфигурацией и секретами, обеспечивающий безопасность (AD-03), сопровождаемость (AD-06) и соответствие требованиям регуляторов (BC-04).

Требования к безопасности (NFR-04) и необходимость быстрого развёртывания (BG-07) требуют централизованного и безопасного управления конфигурацией и секретами.

#### Решение

- **Управление конфигурацией:**
  - **Конфигурация хранится в виде key-value пар** в централизованном хранилище (например, Kubernetes ConfigMaps, HashiCorp Consul, или специализированный Config Service)
  - **Иерархическая структура конфигурации:** глобальные настройки → настройки окружения (dev/staging/prod) → настройки сервиса
  - **Feature flags** управляются через отдельный сервис или хранилище конфигурации, позволяя включать/отключать функции без перезапуска сервисов
  - **Динамическое обновление конфигурации** через API или события (при поддержке сервисами hot-reload)

- **Управление секретами:**
  - **Секреты хранятся в специализированном Secret Management** (Kubernetes Secrets, HashiCorp Vault, AWS Secrets Manager)
  - **Ротация секретов** выполняется автоматически или по расписанию
  - **Доступ к секретам** контролируется через RBAC и аудируется
  - **Секреты никогда не хранятся в коде или конфигурационных файлах** в открытом виде
  - **Шифрование секретов** на уровне хранилища и при передаче

- **Интеграция с микросервисами:**
  - Сервисы получают конфигурацию и секреты при старте через:
    - **Environment variables** (для простых случаев)
    - **API Secret Management** (для динамических секретов)
    - **Sidecar-паттерн** (для прозрачного доступа к секретам)
  - **Валидация конфигурации** при старте сервиса для раннего обнаружения ошибок

- **Аудит и соответствие:**
  - Все операции с секретами логируются и аудируются
  - Политики доступа к секретам соответствуют требованиям регуляторов
  - Периодический аудит использования секретов и конфигурации

Диаграмма `deployment.puml` отражает использование ConfigMaps и Secrets в Kubernetes-кластере.

Связь с артефактами:

- Архитектурные драйверы: **AD-03**, **AD-05**, **AD-06**, **AD-07**.
- Диаграммы: `deployment.puml`, `c4_containers.puml` (Provisioning Service, Config Service).
- Разделы решения: `09_solution/index.md` (управление конфигурацией), `05_constraints/index.md` (BC-04, TC-04), `06_requirements/index.md` (NFR-04, NFR-09).

#### Альтернативы

- **Хранение конфигурации в коде или файлах:**
  - Плюсы: простота начальной настройки.
  - Минусы: необходимость пересборки при изменении, риск утечки секретов, сложность управления для разных окружений.

- **Хранение секретов в переменных окружения без шифрования:**
  - Плюсы: простота реализации.
  - Минусы: высокий риск утечки, отсутствие ротации, сложность аудита.

- **Децентрализованное управление конфигурацией (каждый сервис управляет своей конфигурацией):**
  - Плюсы: независимость сервисов.
  - Минусы: дублирование, сложность синхронизации, риск несогласованности.

#### Последствия

- Положительные:
  - Централизованное управление упрощает сопровождение и аудит.
  - Безопасное хранение секретов снижает риски утечки.
  - Динамическое обновление конфигурации позволяет быстро реагировать на изменения без перезапуска сервисов.
  - Соответствие требованиям регуляторов по управлению секретами.
- Отрицательные:
  - Дополнительная инфраструктура для Secret Management (затраты, сложность).
  - Необходимость интеграции всех сервисов с системой управления секретами.
  - Риск единой точки отказа при неправильной конфигурации Secret Management.
  - Дополнительная задержка при получении секретов (обычно кэшируется).
