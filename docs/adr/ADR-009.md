### ADR-009. Интеграция SIP/WebRTC и медиа-плоскости

- **Статус**: Принято

#### Контекст

UC-платформа должна поддерживать голосовые и видеовызовы через различные протоколы: SIP для интеграции с PSTN и традиционными телефонийными системами, и WebRTC для браузерных и мобильных клиентов. Необходимо определить подход к интеграции SIP/WebRTC и обработке медиапотоков с учётом требований к производительности (NFR-03), безопасности (NFR-04) и масштабируемости (NFR-01).

Требования к голосовой связи (FR-02), видеоконференциям (FR-03) и производительности (NFR-03: время установления вызова ≤ 3 сек) требуют эффективной обработки сигнализации и медиапотоков с минимальной задержкой.

#### Решение

- **Архитектура сигнализации:**
  - **SIP Gateway / SBC** обрабатывает SIP-сигнализацию для интеграции с PSTN и операторскими сетями:
    - Нормализация SIP-сигнализации от различных операторов
    - Защита от SIP-атак (DDoS, SIP-флуд)
    - Транскодирование кодеков при необходимости
    - Маршрутизация SIP-вызовов к Call Control Service
  - **WebRTC Gateway** обрабатывает WebRTC-сигнализацию для браузерных и мобильных клиентов:
    - Обработка SDP (Session Description Protocol) для установления WebRTC-сессий
    - Использование WebTransport для низколатентной сигнализации вызовов
    - Интеграция с ICE/STUN/TURN для NAT traversal
  - **Call Control Service** управляет жизненным циклом вызовов и координирует работу SIP Gateway и WebRTC Gateway

- **Архитектура медиа-плоскости:**
  - **Media / Recording Service** обрабатывает медиапотоки:
    - Приём RTP/SRTP потоков от SIP Gateway и WebRTC Gateway
    - Микширование аудио/видео для конференций
    - Транскодирование кодеков (G.711, G.729, Opus, VP8/VP9/H.264)
    - Запись разговоров и конференций (при необходимости)
    - Адаптивное качество медиа (adaptive bitrate) в зависимости от качества сети
  - **Медиапотоки зашифрованы:**
    - SRTP/DTLS для WebRTC
    - TLS/SRTP для SIP
    - Отсутствие незашифрованного медиатрафика на внешних интерфейсах

- **Оптимизация производительности:**
  - **Выделенный контур для критичных операций:** Call Control → SIP Gateway/WebRTC Gateway → Media Service
  - **Минимизация синхронных зависимостей** в критичном пути установления вызова
  - **Использование WebTransport** для низколатентной сигнализации (вместо WebSocket где возможно)
  - **Кэширование маршрутизации** и правил для снижения задержки

- **Масштабирование:**
  - Горизонтальное масштабирование Media Service для обработки медиапотоков
  - Распределение медиапотоков по нескольким Media Service инстансам
  - Автоматическое масштабирование на основе метрик нагрузки (количество активных вызовов, использование CPU/памяти)

Диаграммы `c4_containers.puml` и `sequences.puml` отражают взаимодействие между Call Control, SIP Gateway, WebRTC Gateway и Media Service.

Связь с артефактами:

- Архитектурные драйверы: **AD-01**, **AD-02**, **AD-03**, **AD-04**.
- Диаграммы: `c4_context.puml`, `c4_containers.puml`, `deployment.puml`, `sequences.puml` (UC_Seq_Outgoing_Call, UC_Seq_Incoming_Call).
- Разделы решения: `09_solution/index.md` (Real-time обработка, медиа-обработка), `06_requirements/index.md` (FR-02, FR-03, NFR-03), `05_constraints/index.md` (TC-01, TC-05).

#### Альтернативы

- **Единый шлюз для SIP и WebRTC:**
  - Плюсы: меньше компонентов.
  - Минусы: сложность реализации, разные требования к обработке протоколов, сложность масштабирования.

- **Обработка медиапотоков в Call Control Service:**
  - Плюсы: меньше компонентов.
  - Минусы: смешение сигнализации и медиа, сложность масштабирования, нарушение принципа разделения ответственности.

- **Отказ от записи разговоров:**
  - Плюсы: упрощение архитектуры, снижение затрат на хранение.
  - Минусы: несоответствие требованиям регуляторов и бизнес-требованиям (FR-07, BC-04).

#### Последствия

- Положительные:
  - Разделение сигнализации и медиа обеспечивает независимое масштабирование и оптимизацию.
  - Использование WebTransport снижает задержку сигнализации для браузерных клиентов.
  - Шифрование медиапотоков обеспечивает безопасность коммуникаций.
  - Горизонтальное масштабирование Media Service позволяет обрабатывать большие нагрузки.
- Отрицательные:
  - Сложность координации между несколькими компонентами (Call Control, SIP Gateway, WebRTC Gateway, Media Service).
  - Высокие требования к пропускной способности сети для медиапотоков.
  - Необходимость управления кодеков и транскодирования увеличивает сложность.
  - Дополнительная задержка на обработку медиа (обычно < 50 мс).
