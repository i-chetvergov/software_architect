### ADR-002. Синхронные и асинхронные коммуникации (REST/gRPC + event bus)

- **Статус**: Принято

#### Контекст

UC-платформа должна поддерживать как интерактивные сценарии (установка вызова, обмен сообщениями), так и фоновые/массовые операции (логирование CDR, нотификации, интеграции с CRM). Необходимо выбрать подход к взаимодействию микросервисов, обеспечивающий баланс между простотой, отзывчивостью и надёжностью (драйверы **AD-01**, **AD-02**, **AD-04**, **AD-05**, **AD-06**).

#### Решение

- Для **синхронных запросов** между сервисами используется:
  - **HTTPS/REST** для внешних и междоменных API (через `API Gateway`).
  - **gRPC** (поверх mTLS) для высоконагруженных внутренних вызовов между сервисами.
- Для **асинхронного взаимодействия**:
  - Используется **брокер сообщений** (`Message Broker` на Deployment Diagram) для публикации/подписки на события: `CallStarted`, `CallEnded`, `MessageSent`, `UserCreated`, `NotificationRequested` и др.
  - Сервисы публикуют доменные события и подписываются на них в рамках своих bounded contexts.
- Диаграмма `c4_containers.puml` и `deployment.puml` отражают как синхронные соединения (сплошные линии), так и поток событий через брокер.

Связь с артефактами:

- Архитектурные драйверы: **AD-01**, **AD-02**, **AD-04**, **AD-05**, **AD-06**.
- Диаграммы: `c4_containers.puml`, `deployment.puml`, `sequences.puml` (исходящий/входящий вызовы, нотификации).
- Разделы решения: `09_solution/index.md` (описание интеграционного и коммуникационного слоёв).

#### Альтернативы

- **Только синхронный REST**:
  - Плюсы: простота, широкий стек инструментов.
  - Минусы: высокая связанность, риск каскадных отказов, сложнее обрабатывать пики нагрузки.
- **Только асинхронная шина**:
  - Плюсы: хорошая декуплинг, высокая устойчивость к перегрузкам.
  - Минусы: сложность реализации запрос-ответ, повышенная латентность для интерактивных операций, сложная отладка.

#### Последствия

- Положительные:
  - Чёткое разделение интерактивных и фоновых сценариев.
  - Возможность буферизации нагрузки и повышения отказоустойчивости через брокер сообщений.
  - Упрощение интеграций с внешними системами через события.
- Отрицательные:
  - Увеличение сложности инфраструктуры (брокер, схемы сообщений).
  - Необходимость строгой дисциплины в определении событий и схем, а также в управлении версионированием.

