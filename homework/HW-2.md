# Декомпозиция на функциональные компоненты  
**Проект:** «Мир веб-крафта» — многопользовательская браузерная игра (MMORPG-шутер)

---

## Цель
Освоить подходы к функциональной декомпозиции системы и выполнить сравнение двух архитектурных вариантов по модифицируемости, стоимости изменений и изоляции доменов.

---

## 1. Модель предметной области

**Файл:** `domain_web_craft.puml`  
**Рисунок:** вставить изображение сгенерированной диаграммы UML-классов  

**Описание диаграммы:**  
Диаграмма отражает ключевые сущности мира «Мир веб-крафта» и их взаимосвязи.  
Основные домены:
- **Игровой процесс:** матч, лобби, игровые серверы, чат, зрители.  
- **Пользовательская часть:** аккаунт, профиль, инвентарь, валюта, предметы.  
- **Монетизация:** заказы, платежи, каталоги.  
- **UGC-контент:** пользовательские ассеты, модерация, публикация.  
- **Социальные функции:** турниры, приглашения.  

Диаграмма демонстрирует структуру данных и связи «один ко многим» между объектами (например, один аккаунт → один профиль → один инвентарь → множество предметов и валют).  
Она используется как исходная модель для последующих архитектурных декомпозиций.

---

## 2. Функциональная декомпозиция по доменам

**Файл:** `decomp_domains.puml`  
**Рисунок:** вставить изображение диаграммы декомпозиции по доменам  

**Описание диаграммы:**  
Декомпозиция отражает разделение системы на функциональные домены:
- **Игровой процесс (runtime):** матчмейкинг, лобби, игровые серверы, пространственный чат.  
- **Монетизация (commerce):** каталог, заказы, платежный адаптер, начисления в инвентарь.  
- **UGC / Контент:** загрузка, песочница, модерация, публикация в CDN.  
- **Социальные функции:** турниры, приглашения, зрители.  
- **Платформа:** аутентификация, профили, античит, конфиги, телеметрия, CDN.  

В диаграмме отображены связи между доменами и инфраструктурными элементами (Kafka/Redpanda, хранилища, шина конфигураций).  
Стрелки показывают направления взаимодействий и типы связей:  
- **[sync]** — синхронные вызовы (REST, gRPC, WebRTC);  
- **[async]** — асинхронные события и метрики.  

Цель этой схемы — показать модульное разделение системы на бизнес-домены, что повышает управляемость и независимость разработки.

---

## 3. Функциональная декомпозиция по жизненным циклам (lifecycles)

**Файл:** `decomp_lifecycles.puml`  
**Рисунок:** вставить изображение диаграммы декомпозиции по потокам жизненного цикла  

**Описание диаграммы:**  
Этот вариант декомпозиции группирует компоненты не по предметным областям, а по фазам жизненного цикла взаимодействия игрока:
- **Доступ и профиль:** API-шлюз, идентификация, профили.  
- **Вовлечение и экономика:** витрина, заказы, инвентарь, прогресс.  
- **Реал-тайм рантайм:** матчмейкинг, оркестрация сессии, игровые серверы, чат, зрители.  
- **Экосистема авторов (UGC):** загрузка, проверки, модерация, публикация.  
- **События и сообщество:** турниры, приглашения.  
- **Операции:** античит, наблюдаемость, конфиги, CDN, автоскейлинг.  

На диаграмме выделен **критический путь** `поиск матча → лобби → сервер`, обеспечивающий SLA по задержкам (tickrate, latency).  
Lifecycles-схема акцентирует внимание на потоках данных, SLA и операционных границах между системами.

---

## 4. Сценарии изменений

| ID | Сценарий изменения | Пример изменений | Вероятность |
|----|--------------------|------------------|--------------|
| CH-1 | Подключить второго платёжного провайдера (PSP) | новый PSP, webhooks, маршрутизация | Высокая |
| CH-2 | Новый режим боя / правила | новый `RuleSet`, параметры урона/тикрейта | Средняя |
| CH-3 | Добавить новый регион/PoP | пулы серверов, матчмейкинг с учётом RTT | Средняя |
| CH-4 | Расширить UGC-монетизацию | роялти авторам, витрина UGC | Средняя |
| CH-5 | Новый формат турниров | Swiss/Double-Elim, расписание | Низкая |
| CH-6 | Усилить анти-чит | новые сигналы/модели, политики сервера | Высокая |
| CH-7 | Ввести задержку зрителя | настройка anti-ghosting 5–15 сек | Средняя |
| CH-8 | Добавить голосовую модерацию | фильтрация токсичности, mute | Средняя |
| CH-9 | Витрина сезонных платежей | боевой пропуск, подписка | Средняя |
| CH-10 | Оптимизация cold-start клиента | разрез бандла, CDN-политики | Средняя |

---

## 5. Оценка модифицируемости и стоимости изменений

**Шкала:**  
S — ≤ 1 неделя; M — 2–3 недели; L — 1–2 месяца; XL — более 2 месяцев.

| Сценарий | Вариант A (по доменам) | Вариант B (по lifecycles) |
|-----------|------------------------|-----------------------------|
| CH-1 | S — изолированный `Платёжный адаптер` | S — поток «Экономика» |
| CH-2 | M — меняется только `RuleSet` | M–L — затрагивает Runtime и Экономику |
| CH-3 | M — флит и матчмейкинг отделены | M — Runtime + Операции |
| CH-4 | S–M — «Монетизация» + «UGC» | M — стык потоков |
| CH-5 | M — изолированный домен «Социальные» | S–M — поток «События» |
| CH-6 | S–M — «Платформа» (античит) | M — Runtime + Операции |
| CH-7 | S — сервис «Зрители» | S — компонент в Runtime |
| CH-8 | M — VOIP + Observability | M — Runtime + ML |
| CH-9 | M — витрина/подписки | M — поток «Экономика» |
| CH-10 | S–M — CDN и паблишинг | S–M — «Операции/CDN» |

**Вывод:**  
- Вариант **A (по доменам)** — минимальные зависимости, модульность, простота изменений.  
- Вариант **B (lifecycles)** — логика лучше соответствует SLA, но требует синхронизации между потоками.

---

## 6. Риски и ограничения

| Категория | Описание |
|------------|-----------|
| Общие | Всплески CCU, злоупотребления UGC, нагрузка на CDN, регрессия FPS |
| Вариант A | Возможен общий доступ к БД, требуется строгая контрактная дисциплина |
| Вариант B | Возможное дублирование сущностей (профиль, инвентарь) между потоками |

---

## 7. Сравнительный анализ

| Критерий | Вариант A — домены | Вариант B — lifecycles |
|-----------|-------------------|------------------------|
| Организация команд | По предметным областям | По потокам жизненного цикла |
| SLA и производительность | Гибкая, требует дисциплины | Изоляция Runtime, гарантированные SLO |
| Быстрота изменений геймплея | Высокая | Ниже (затрагивает несколько потоков) |
| Изменения платежей | Простая адаптация | Простая адаптация |
| Масштабируемость | Хорошая | Отличная |
| Повторное использование | Высокое (отдельные домены) | Среднее |
| Риск дублирования | Низкий | Выше |
| Средняя стоимость изменений | S–M | S–M / M–L |

**Вывод:**  
- Вариант **A (по доменам)** — лучше для быстрой эволюции и модульной разработки.  
- Вариант **B (по lifecycles)** — предпочтителен для эксплуатации с жёсткими SLA и контролем латентности.  

Рекомендуемая стратегия — использовать **доменную модель как основу**, а **lifecycles** как слой для управления эксплуатацией и SLA.

---

## 8. Дополнительные архитектурные решения (ADR)

### ADR-003 — Междоменные коммуникации (Event-driven)

**Статус:** принято  
**Контекст:** необходима слабая связность при высокой нагрузке (CCU, платежи, UGC).  
**Решение:** асинхронный обмен событиями через Kafka/Redpanda, идемпотентные обработчики, Schema Registry.  
**Последствия:**  
+ слабая связность и масштабируемость  
− сложность трассировки и обработка дубликатов

---

### ADR-004 — Жёсткий контур Runtime с SLO

**Статус:** принято  
**Контекст:** SLA по латентности и тикрейту критичны для геймплея.  
**Решение:**  
- контур `mm → lob → gs` выделен как независимый real-time слой  
- на вход — только конфиги и события, без синхронных зависимостей  
- SLO: поиск матча P95 ≤ 10 с; RTT P95 ≤ 80–120 мс; тикрейт 30–60 Hz  
**Последствия:**  
+ высокая предсказуемость  
− требуется строгая спецификация контрактов и буферизация

---

## 9. Вывод

Обе декомпозиции жизнеспособны и дополняют друг друга:
- **A (по доменам)** обеспечивает модульность и простоту внедрения новых функций;  
- **B (по lifecycles)** повышает управляемость SLA и эксплуатационную устойчивость.

**Итоговое решение:**  
использовать **доменную декомпозицию как базовый уровень**,  
и **lifecycles-декомпозицию как слой операционного управления и SLA**.

---
