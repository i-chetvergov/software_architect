@startuml
skinparam linetype ortho
skinparam componentStyle rectangle
skinparam PackageBorderColor #777
skinparam PackageFontColor #222
skinparam ArrowThickness 1
skinparam shadowing false
left to right direction
title Функциональная декомпозиция по потокам жизненного цикла (lifecycles)

' ==== ПОТОКИ / ЖЦ ====
package "Доступ и профиль" as pkg_access #AliceBlue {
  [API-шлюз/WAF] as edge
  [Идентификация (OIDC)] as auth
  [Профили игроков] as profiles
}

package "Вовлечение и экономика" as pkg_econ #LightGoldenRodYellow {
  [Витрина/Каталог] as cat
  [Заказы/Платежи] as billing
  [Инвентарь/Начисления] as inv
  [Прогресс/Рейтинг] as progress
}

package "Реал-тайм рантайм" as pkg_rt #LightSkyBlue {
  [Поиск матча] as find
  [Оркестратор сессии] as orch
  [Игровой сервер (сервер-авторитет)] as gs
  [Пространственный чат (WebRTC)] as voip
  [Зритель на краю] as spect
}

package "Экосистема авторов (UGC)" as pkg_ugc #LightGreen {
  [Редактор/Загрузка] as ugc_edit
  [Песочница/Проверки] as ugc_sandbox
  [Модерация] as mod
  [Публикация в CDN] as publish
}

package "События и сообщество" as pkg_events #Thistle {
  [Турниры/Сетка] as tour
  [Приглашения/Доступ] as invite
}

package "Операции" as pkg_ops #Gainsboro {
  [Наблюдаемость/Телеметрия] as obs
  [Античит/Аналитика] as ant
  [Конфиги/Фиче-флаги] as cfg
  [Автоскейл/Ёмкость] as capacity
  [CDN/Ассеты] as cdn
}

' ==== ИНФРАСТРУКТУРА ====
queue "Шина событий (Kafka/Redpanda)" as bus
queue "Шина конфигураций (pub/sub)" as cfg_bus
database "Хранилище профилей" as db_profiles
database "Хранилище биллинга" as db_billing
database "Хранилище инвентаря" as db_inventory
database "Хранилище UGC" as db_ugc
database "Телеметрия/логи" as db_logs

' ==== СВЯЗИ ПО ПОТОКАМ ====
' Доступ и профиль
edge --> auth : HTTPS [sync]
auth --> profiles : REST/gRPC [sync]
profiles --> db_profiles : SQL

' Вовлечение и экономика
cat --> billing : REST [sync]
billing --> inv : REST/gRPC [sync]
billing --> db_billing : SQL
inv --> db_inventory : SQL
billing ..> bus : PaymentSucceeded/Failed [async]

' Реал-тайм (критический путь подсвечен)
find -[#red,bold]-> orch : gRPC [sync]
orch -[#red,bold]-> gs : gRPC [sync]
voip --> gs : WebRTC [sync]
spect --> gs : WSS/WebRTC [sync]
gs ..> bus : MatchEvents [async]

' Экосистема авторов
ugc_edit --> ugc_sandbox : REST [sync]
ugc_sandbox --> mod : REST [sync]
mod --> publish : REST [sync]
publish --> cdn : API [sync]
ugc_edit --> db_ugc : SQL
mod ..> bus : ModerationVerdict [async]

' События и сообщество
tour --> invite : REST [sync]

' Операции
ant --> gs : сигналы/правила [sync]
capacity --> gs : автоскейл [sync]
pkg_rt ..> obs : метрики/трейсы [async]
pkg_econ ..> obs : метрики [async]
pkg_ugc ..> obs : метрики [async]
pkg_events ..> obs : метрики [async]
pkg_access ..> obs : метрики [async]
obs --> db_logs : ingest

' Конфиги — по стрелке на поток
cfg --> cfg_bus : publish [async]
cfg_bus ..> pkg_rt : subscribe [async]
cfg_bus ..> pkg_econ : subscribe [async]
cfg_bus ..> pkg_ugc : subscribe [async]
cfg_bus ..> pkg_events : subscribe [async]
cfg_bus ..> pkg_access : subscribe [async]
cfg_bus ..> pkg_ops : subscribe [async]

' ==== ЛЕГЕНДА ====
legend right
  Потоки (lifecycles):
    Доступ и профиль — логин/профиль/гейтвей
    Вовлечение и экономика — витрина/платежи/инвентарь/прогресс
    Реал-тайм — матчмейкинг/оркестрация/сервер/чат/зритель
    Экосистема авторов — загрузка→проверки→модерация→CDN
    События и сообщество — турниры и инвайты
    Операции — конфиги, античит, observability, автоскейл, CDN
  Обозначения:
    [sync]  синхронно (REST/gRPC/WebRTC)
    [async] асинхронно (events/metrics)
    Красные стрелки — критический путь (find→orch→gs)
endlegend
@enduml