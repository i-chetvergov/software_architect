@startuml
title Схема баз данных "Мир веб-крафта" (логический уровень, с описаниями таблиц)

skinparam linetype ortho
skinparam classAttributeIconSize 0
left to right direction

skinparam package {
  BackgroundColor #F5F5F5
  BorderColor #424242
}

' ============ DB_ACCOUNTS ============

package "DB_ACCOUNTS\n(PostgreSQL)\nДомен: Аккаунты и профили" {

  class accounts {
    + PK_id : uuid
    + email : text
    + password_hash : text
    + status : text        ' active / banned / deleted
  }

  note right of accounts
    Таблица accounts — учетные записи игроков.
    Хранит идентификатор аккаунта, email и хеш пароля.
    Поле status отражает состояние учётной записи
    (active / banned / deleted) и управляет доступом в игру.
    Используется сервисом аутентификации и платёжным контуром.
    Данные аккаунтов являются критичными и не должны физически удаляться,
    предпочтительно переводить их в "deleted" / "banned".
  end note

  class profiles {
    + PK_id : uuid
    + FK_account_id : uuid
    + nickname : text
    + region : text
    + rating_elo : integer
  }

  note right of profiles
    Таблица profiles — игровые профили, привязанные к аккаунтам.
    Хранит никнейм, игровой регион и рейтинг (rating_elo).
    Один аккаунт может иметь один или несколько профилей
    (при необходимости расширения модели).
    Профиль используется в матчмейкинге, турнирах, инвентаре и UGC.
    Значение region используется для географического распределения
    нагрузки и применения feature-флагов по регионам.
  end note

  class feature_flags {
    + PK_id : uuid
    + key : text
    + value : jsonb
    + scope : text        ' global / region / account / profile
    + scope_ref : text    ' null / region / account_id / profile_id
    + enabled : boolean
  }

  note right of feature_flags
    Таблица feature_flags — конфигурация и feature-флаги системы.
    Поле key — уникальное имя флага, value — произвольные параметры в JSON.
    Поле scope определяет уровень применения: global / region / account / profile.
    Поле scope_ref содержит конкретное значение региона, account_id или profile_id.
    Записи используются сервисами конфигураций и приложениями в рантайме
    для включения/отключения функций, A/B-тестов и поэтапного выката.
    Логически связана с accounts и profiles, но без жёстких FK,
    чтобы не ломать независимость доменов и кросс-БД границы.
  end note
}

' ============ DB_GAMEPLAY ============

package "DB_GAMEPLAY\n(PostgreSQL)\nДомен: Игровой процесс" {

  class lobbies {
    + PK_id : uuid
    + region : text
    + FK_map_id : uuid
    + FK_ruleset_id : uuid
    + max_players : integer
    + status : text        ' created / filling / started / closed
  }

  note right of lobbies
    Таблица lobbies — игровые лобби (комнаты ожидания перед матчем).
    Содержит регион, карту (FK_map_id), набор правил (FK_ruleset_id)
    и максимальное количество игроков.
    Поле status описывает жизненный цикл лобби: создано, заполняется,
    матч запущен, лобби закрыто.
    Используется сервисами матчмейкинга и оркестрации игровых серверов.
    В случае турнирного режима лобби привязывается к соответствующим матчам.
  end note

  class matches {
    + PK_id : uuid
    + FK_lobby_id : uuid
    + FK_game_server_id : uuid
    + status : text        ' scheduled / running / finished / aborted
    + result_json : jsonb
  }

  note right of matches
    Таблица matches — запущенные и завершённые игровые матчи.
    Связана с конкретным лобби и игровым сервером.
    Поле status отражает состояние матча: запланирован, идёт, завершён, отменён.
    В поле result_json хранятся результаты: победитель, счёт, статистика.
    Используется для отображения истории боёв, начисления наград
    и анализа качества матчмейкинга и серверов.
  end note

  class game_servers {
    + PK_id : uuid
    + region : text
    + host : text
    + port : integer
    + status : text        ' idle / busy / maintenance
    + capacity : integer
  }

  note right of game_servers
    Таблица game_servers — зарегистрированные игровые серверы.
    Хранит регион, хост, порт, статус (idle / busy / maintenance)
    и вместимость по числу матчей или игроков.
    Используется оркестратором для назначения серверов матчу.
    Помогает управлять пулом серверов, мониторить состояние
    и выполнять плановое обслуживание.
  end note

  class tournaments {
    + PK_id : uuid
    + name : text
    + visibility : text    ' public / private / invite_only
    + format : text        ' single_elim / double_elim / swiss / league
    + status : text        ' planned / running / finished
    + FK_created_by_profile_id : uuid
  }

  note right of tournaments
    Таблица tournaments — игровые турниры.
    Хранит имя, тип видимости (public / private / invite_only),
    формат (single_elim, double_elim, swiss, лига) и статус.
    Поле FK_created_by_profile_id указывает на профиль создателя турнира.
    Используется сервисом турниров для планирования сетки матчей
    и последующего расчёта результатов и наград.
  end note

  class tournament_invites {
    + PK_id : uuid
    + FK_tournament_id : uuid
    + FK_profile_id : uuid
    + role : text          ' player / admin / spectator
    + status : text        ' pending / accepted / declined
  }

  note right of tournament_invites
    Таблица tournament_invites — приглашения в турниры.
    Содержит ссылку на турнир и профиль игрока или администратора.
    Поле role определяет роль участника (игрок / админ / зритель).
    Статус (pending / accepted / declined) отражает состояние приглашения.
    Используется для управления доступом к приватным и инвайт-турнирам.
  end note

  class spectators {
    + PK_id : uuid
    + FK_match_id : uuid
    + FK_profile_id : uuid
    + delay_sec : integer
  }

  note right of spectators
    Таблица spectators — зрители конкретных матчей.
    Хранит ссылку на матч и профиль зрителя.
    Поле delay_sec задаёт задержку показа (anti-ghosting),
    чтобы предотвратить передачу информации в реальном времени
    активным игрокам.
    Используется сервисом зрителей и стриминга.
  end note
}

' ============ DB_COMMERCE ============

package "DB_COMMERCE\n(PostgreSQL)\nДомен: Монетизация" {

  class catalog_items {
    + PK_id : uuid
    + sku : text
    + type : text          ' skin / weapon / pass / currency_pack
    + title : text
    + price_amount : numeric
    + price_currency : text
    + is_active : boolean
  }

  note right of catalog_items
    Таблица catalog_items — сущности каталога и витрины магазина.
    Описывает продаваемые позиции: скины, оружие, боевые пропуска,
    пакеты игровой валюты и т.п.
    Хранит SKU, название, цену и валюту, а также признак is_active.
    Используется сервисом каталога и заказов для отображения
    ассортимента и создания позиций заказа.
  end note

  class orders {
    + PK_id : uuid
    + FK_account_id : uuid
    + total_amount : numeric
    + currency : text
    + status : text        ' pending / paid / cancelled / failed
  }

  note right of orders
    Таблица orders — заказы игроков в магазине.
    Связана с аккаунтом (плательщиком) и содержит итоговую сумму
    и валюту заказа.
    Поле status фиксирует жизненный цикл: pending / paid / cancelled / failed.
    Используется сервисами заказов и платежей для учёта операций
    и последующего начисления предметов и валюты.
    Записи не должны удаляться, только менять статус (аудит, отчётность).
  end note

  class order_items {
    + PK_id : uuid
    + FK_order_id : uuid
    + FK_catalog_item_id : uuid
    + quantity : integer
    + price_amount : numeric
    + price_currency : text
  }

  note right of order_items
    Таблица order_items — позиции внутри заказа.
    Для каждого заказа хранит ссылки на элементы каталога,
    количество, цену и валюту на момент покупки.
    Позволяет анализировать структуру продаж и корзину игрока.
    Используется при восстановлении истории покупок и расчёте выручки.
  end note

  class payments {
    + PK_id : uuid
    + FK_order_id : uuid
    + provider : text
    + provider_ref : text
    + status : text        ' initiated / succeeded / failed / refunded
    + amount : numeric
    + currency : text
  }

  note right of payments
    Таблица payments — платежи по заказам.
    Связывает заказ с платёжным провайдером и его внешним идентификатором.
    Поле status хранит состояние платёжной транзакции
    (initiated, succeeded, failed, refunded).
    Используется платёжным адаптером и для финансовой отчётности.
  end note

  class inventories {
    + PK_id : uuid
    + FK_profile_id : uuid
  }

  note right of inventories
    Таблица inventories — инвентарь игрового профиля.
    Логический контейнер для всех предметов и улучшений игрока.
    Связана с profiles и используется сервисом инвентаря
    для чтения и обновления содержимого.
    Один профиль имеет один инвентарь в рамках игры.
  end note

  class inventory_items {
    + PK_id : uuid
    + FK_inventory_id : uuid
    + FK_catalog_item_id : uuid
    + quantity : integer
    + source : text        ' purchase / reward / grant
  }

  note right of inventory_items
    Таблица inventory_items — конкретные предметы в инвентаре.
    Хранит, какие предметы (из каталога) и в каком количестве
    принадлежат игроку.
    Поле source фиксирует источник получения: покупка, награда, вручную.
    Используется для отображения инвентаря в клиенте
    и проверки прав на использование предметов в игре.
  end note

  class currencies {
    + PK_id : uuid
    + FK_profile_id : uuid
    + currency_code : text ' GOLD / GEMS / ...
    + balance : numeric
  }

  note right of currencies
    Таблица currencies — балансы внутриигровых валют.
    Описывает, сколько единиц каждой валюты (GOLD, GEMS и т.п.)
    принадлежит конкретному профилю.
    Используется в монетизации, наградах и внутриигровых расходах.
    Важно обеспечивать целостность балансов при ошибках платежей
    и откатах операций.
  end note
}

' ============ DB_UGC ============

package "DB_UGC\n(DocumentDB)\nДомен: Пользовательский контент" {

  class ugc_assets {
    + PK_id : uuid
    + FK_owner_profile_id : uuid
    + type : text          ' map / weapon / skin / ruleset / script
    + title : text
    + status : text        ' draft / pending_review / approved / rejected
    + payload : json       ' карта, правила, параметры
    + cdn_url : text
    + version : integer
  }

  note right of ugc_assets
    Таблица ugc_assets — пользовательские игровые ресурсы (UGC).
    Содержит карты, правила, оружие, скины и другие моды.
    Поле payload хранит полное описание объекта в JSON
    (структура карты, параметры оружия и т.п.).
    Статус определяет стадию: черновик, на модерации,
    одобренный или отклонённый контент.
    cdn_url указывает на размещённые в CDN медиа-ресурсы.
    Версионирование позволяет обновлять контент без потери истории.
  end note

  class ugc_moderation {
    + PK_id : uuid
    + FK_ugc_asset_id : uuid
    + FK_moderator_id : uuid
    + verdict : text       ' approve / reject / block
    + reason : text
  }

  note right of ugc_moderation
    Таблица ugc_moderation — результаты модерации UGC-контента.
    Хранит связь с UGC-объектом и модератором (человек или система).
    Поле verdict фиксирует решение (approve, reject, block),
    а reason — текстовое обоснование.
    Используется для аудита, повторной проверки
    и обучения автоматических систем модерации.
  end note
}

' ============ DB_METRICS ============

package "DB_METRICS\n(Time-series / Column)\nДомен: Метрики и аналитика" {

  class metrics_gameplay {
    + ts : timestamp
    + FK_match_id : uuid
    + region : text
    + metric_name : text
    + metric_value : numeric
  }

  note right of metrics_gameplay
    Таблица metrics_gameplay — технические метрики игрового процесса.
    Хранит временной ряд значений по матчам: задержки, потери пакетов,
    серверные ошибки, CPS и другие показатели.
    Поле metric_name позволяет хранить разные типы метрик
    в единой структуре (schema-on-read).
    Используется службой наблюдаемости для построения графиков,
    алёртов и анализа качества рантайма.
  end note

  class metrics_business {
    + ts : timestamp
    + FK_account_id : uuid
    + event_name : text
    + properties : jsonb
  }

  note right of metrics_business
    Таблица metrics_business — бизнес-события и аналитика.
    Хранит события уровня аккаунта: регистрации, покупки, входы,
    участие в турнирах и т.п.
    Поле event_name задаёт тип события, а properties — параметры в JSON.
    Используется аналитикой и продуктовой командой для расчёта KPI
    (LTV, конверсии, ретеншн) и оценки эффективности изменений.
  end note
}

' ============ СВЯЗИ МЕЖДУ ТАБЛИЦАМИ ============

' --- DB_ACCOUNTS ---
accounts "1" -- "1" profiles : FK_account_id

' --- ЛОГИЧЕСКИЕ СВЯЗИ FEATURE FLAGS (НЕ ФИЗИЧЕСКИЕ FK) ---
feature_flags .. profiles : scope = "profile"\nscope_ref = profile_id
feature_flags .. accounts : scope = "account"\nscope_ref = account_id
feature_flags .. profiles : scope = "region"\nscope_ref = region

' --- GAMEPLAY <-> ACCOUNTS ---
profiles "1" -- "*" tournament_invites : FK_profile_id
profiles "1" -- "*" spectators         : FK_profile_id
profiles "1" -- "*" tournaments        : FK_created_by_profile_id

lobbies "1" -- "0..1" matches     : FK_lobby_id
matches "*" -- "1" game_servers   : FK_game_server_id
tournaments "1" -- "*" tournament_invites : FK_tournament_id

' --- COMMERCE <-> ACCOUNTS / PROFILES ---
accounts "1" -- "*" orders       : FK_account_id
orders "1"   -- "*" order_items  : FK_order_id
orders "1"   -- "0..1" payments  : FK_order_id

profiles "1" -- "0..1" inventories     : FK_profile_id
inventories "1" -- "*" inventory_items : FK_inventory_id
profiles "1" -- "*" currencies         : FK_profile_id

catalog_items "1" -- "*" order_items      : FK_catalog_item_id
catalog_items "1" -- "*" inventory_items  : FK_catalog_item_id

' --- UGC <-> PROFILES ---
profiles "1" -- "*" ugc_assets           : FK_owner_profile_id
ugc_assets "1" -- "0..*" ugc_moderation  : FK_ugc_asset_id

' --- GAMEPLAY <-> UGC (логические связи между БД) ---
lobbies "1" -- "1" ugc_assets   : FK_map_id\n(type = "map")
lobbies "1" -- "0..1" ugc_assets: FK_ruleset_id\n(type = "ruleset")

' --- METRICS <-> ДОМЕННЫЕ СУЩНОСТИ (ЛОГИЧЕСКИ) ---
matches "1" -- "*" metrics_gameplay : FK_match_id
accounts "1" -- "*" metrics_business: FK_account_id

' ============ ОБЩЕЕ ПРИМЕЧАНИЕ ============

note bottom
  Разделение по БД:
  - DB_ACCOUNTS — идентификация и профили игроков;
  - DB_GAMEPLAY — лобби, матчи, серверы, турниры, зрители;
  - DB_COMMERCE — каталог, заказы, платежи, инвентарь, валюты;
  - DB_UGC — пользовательские карты, моды, правила, скрипты;
  - DB_METRICS — техническая и бизнес-телеметрия.

  PK_* — первичный ключ таблицы.
  FK_* — внешний ключ на сущность из другого класса/домена.

  feature_flags:
  - scope задаёт уровень применения (global / region / account / profile);
  - scope_ref содержит конкретное значение (region / account_id / profile_id);
  - связи с accounts и profiles на диаграмме — логические,
    реализуются на уровне приложения, а не физическими FK.

  Связи между разными пакетами (между БД)
  являются логическими внешними ключами на уровне приложения,
  а не физическими ограничениями внутри одной СУБД.
end note

@enduml