@startuml
title Критический сценарий: поиск матча и подключение к игровому серверу (перфекционизм)

actor "Игрок" as player
participant "Веб-клиент" as client
participant "Сервис аутентификации" as auth
participant "Сервис матчмейкинга" as mm
participant "Сервис лобби" as lob
participant "Оркестрация игровых серверов" as gs
participant "Сервис античита" as ant
participant "Сервис наблюдаемости" as obs

== Авторизация игрока ==
player -> client : Открывает игру
client -> auth : Проверка токена / вход [requestId]
alt Токен валиден
    auth --> client : Профиль, рейтинг, регион
else Токен невалиден
    auth --> client : Ошибка 401 / нужен refresh
    opt Успешное обновление токена
        client -> auth : Refresh token
        auth --> client : Новый токен
    end
end

== Запрос на поиск матча ==
player -> client : Нажимает "Играть"
opt Переопределение региона/режима
    client -> mm : Обновление предпочтений
    mm --> client : OK
end

client -> mm : Запрос подбора\n(профиль, рейтинг, регион, requestId)
activate mm
mm -> mm : Алгоритм подбора\n(поиск совместимых игроков)

alt Найдена подходящая группа
    ' --- создание лобби ---
    create lob
    mm --> lob : Создать лобби\n(список игроков, карта, правила) [idempotent]
    activate lob

    ' --- назначение игрового сервера ---
    lob -> gs : Выделение сервера\n(регион, ресурсы, правила)
    activate gs
    gs -> ant : Проверка политик античита\n(конфигурация матча)
    activate ant

    alt Разрешено
        ant --> gs : OK
        gs --> lob : Параметры сервера\n(ip, порт, протокол, sessionToken, matchId)
        lob --> client : Данные подключения\n(server + sessionToken, lobbyId)
        deactivate ant
        deactivate gs
        deactivate lob
        deactivate mm

        ' === Успешный матч -> подключение клиента ===
        opt Успешный матч
        == Подключение клиента к серверу ==
        group Подключение и верификация
            client -> gs : Установка соединения\n(WebTransport/UDP, mTLS/DTLS, sessionToken)
            activate gs
            alt Верификация успешна
            gs --> client : Снапшот состояния\n(карта, игроки)
            else Ошибка / истёкший токен
            gs --> client : 401/403 + причина
            opt Повторная попытка 1–2 раза с backoff
                client -> gs : Повторное соединение
            end
            end
            deactivate gs
        end

        loop Геймплейная сессия (30–60 Гц)
            client -> gs : Поток input-событий
            gs --> client : Обновления состояния / ACK
        end

        ' --- Наблюдаемость (только если матч существует) ---
        par Метрики матча
            gs -> obs : Метрики матча\n(RTT, потери, ошибки, CPS)
            lob -> obs : Статус лобби / финальный статус
        end

        opt Завершение матча
            gs --> client : Завершение / результаты
            gs -> obs : Итоговые метрики\n(результаты, длительность)
        end
        end

    else Запрещено
        ant --> gs : Deny + причина
        gs --> lob : Отмена запуска матча
        lob --> mm : Отмена лобби (переподбор)
        mm --> client : Матч отменён,\nбудет выполнен переподбор
        destroy lob
        deactivate ant
        deactivate gs
        deactivate mm
    end

else Таймаут подбора
    mm --> client : Таймаут / расширить диапазон рейтинга
    deactivate mm
end

== Общая наблюдаемость (всегда) ==
mm -> obs : Время поиска матча\n(P50/P95/P99)

== Отмена поиска игроком ==
opt Отмена поиска игроком
    player -> client : Отменить поиск
    client -> mm : Cancel(requestId)
    mm --> client : Cancelled
end

note over client,gs
    Все запросы содержат requestId / correlationId.
    sessionToken — короткий TTL, привязка к playerId+matchId.
    Создание лобби и выделение сервера — идемпотентны.
end note

@enduml